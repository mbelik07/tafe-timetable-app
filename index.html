<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="TAFE Interactive Timetabling Application" property="og:title"/>
<meta content="A multi-college, interactive timetabling solution for TAFE NSW with data persistence and class notes." property="og:description"/>
<meta content="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762158838/u1103083349_img_120x40_8aa3ecf2_m66f6i.png" property="og:image"/>
<meta content="website" property="og:type"/>
<link href="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762158838/u1103083350_img_64x64_ad306614_xji6gn.png" rel="icon"/>
<title>TAFE Interactive Timetabling Application</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
.sidebar { transition: transform 0.3s ease-in-out; }
.sidebar-open { transform: translateX(0) !important; }
.view-container { display: none; }
.view-container.active { display: block; }
/* Updated College Tab Styles */
.college-tab { padding: 10px 20px; border: 1px solid transparent; border-bottom: none; background: #f3f4f6; color: #4b5563; cursor: pointer; border-radius: 8px 8px 0 0; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; transition: all 0.2s; }
.college-tab:hover { background: #e5e7eb; color: #1e3a8a; }
.college-tab.active { background: white; border-color: #d1d5db; border-bottom-color: white; color: #1e3a8a; box-shadow: 0 -2px 4px rgba(0,0,0,0.05); }
.college-tab i { font-size: 1.1em; }

.timetable-main-grid { display: grid; grid-template-columns: 50px repeat(5, minmax(200px, 1fr)); grid-template-rows: auto 1fr; border: 1px solid #d1d5db; }
.timetable-header { background-color: #007bff; color: white; font-weight: bold; padding: 0.75rem 0.5rem; text-align: center; border-left: 1px solid #d1d5db; grid-row: 1; }
.time-labels { grid-row: 2; grid-column: 1; display: flex; flex-direction: column; }
.time-label { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6b7280; border-top: 1px solid #e5e7eb; box-sizing: border-box; }
.day-column { grid-row: 2; position: relative; border-left: 1px solid #d1d5db; }
.time-slot { height: 30px; border-top: 1px solid #e5e7eb; box-sizing: border-box; cursor: pointer; }
.time-slot:hover { background-color: rgba(229, 231, 235, 0.5); }
.dragging .time-slot:hover { background-color: transparent !important; }
.dragging .time-slot { cursor: default !important; }
.time-slot.slot-selected { background-color: rgba(59, 130, 246, 0.3); }
.session-block { position: absolute; border-radius: 4px; padding: 6px; font-size: 14px; line-height: 1.3; overflow: hidden; border: 1px solid rgba(0,0,0,0.4); z-index: 10; cursor: grab; }
.session-block.compulsory { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700; }
.session-block.online { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.blended { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.compulsory.online { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.session-block.compulsory.blended { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.dispute-warning { border: 3px solid #ef4444 !important; z-index: 15; animation: pulse-border 1.5s infinite; }
.dispute-warning::after { content: '⚠️ DISPUTED'; position: absolute; top: 2px; right: 4px; font-weight: bold; color: #ef4444; font-size: 10px; background: white; padding: 0 2px; border-radius: 3px;}
@keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
.resize-handle { position: absolute; bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; z-index: 20; }
.context-menu { position: fixed; background: #2d3748; color: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-width: 220px; display: none; }
.context-menu.active { display: block; }
.context-menu-item { padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #4a5568; display: flex; align-items: center; gap: 0.5rem; }
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:hover { background: #4a5568; }
.context-menu-item i { width: 20px; text-align: center; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: none; }
.modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; z-index: 101; }
.modal-overlay.active { display: block; }

/* Management Modal Improvements */
.management-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; }
.management-modal-title { font-size: 1.875rem; font-weight: bold; color: #1e3a8a; margin: 0; }
.management-modal-actions { display: flex; gap: 0.75rem; }
.add-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold; padding: 0.625rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.close-btn { background: none; border: none; font-size: 1.875rem; font-weight: bold; color: #6b7280; cursor: pointer; padding: 0; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; transition: all 0.2s; }
.close-btn:hover { background: #f3f4f6; color: #1f2937; }

/* Compact Table Styling */
.management-table-wrapper { overflow-x: auto; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
.management-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
.management-table thead { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; position: sticky; top: 0; }
.management-table th { padding: 0.875rem; text-align: left; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2); }
.management-table th:last-child { border-right: none; }
.management-table tbody tr { border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
.management-table tbody tr:hover { background-color: #f9fafb; }
.management-table td { padding: 0.875rem; }
.management-table td:first-child { font-weight: 600; color: #1f2937; }

/* Action Buttons - Compact */
.action-buttons { display: flex; gap: 0.5rem; justify-content: center; }
.action-btn { padding: 0.375rem 0.75rem; border: none; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 0.25rem; }
.edit-btn { background: #3b82f6; color: white; }
.edit-btn:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3); }
.delete-btn { background: #ef4444; color: white; }
.delete-btn:hover { background: #dc2626; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3); }

/* Form Section */
.management-form-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb; }
.management-form-section h3 { font-size: 1.125rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem; }
.form-group input, .form-group select { padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; transition: border-color 0.2s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
.form-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1rem; }
.form-btn { padding: 0.625rem 1.25rem; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.form-btn-submit { background: #10b981; color: white; }
.form-btn-submit:hover { background: #059669; transform: translateY(-1px); }
.form-btn-cancel { background: #9ca3af; color: white; }
.form-btn-cancel:hover { background: #6b7280; transform: translateY(-1px); }

/* PDF Print Styles */
.pdf-print-grid { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
.pdf-print-grid th, .pdf-print-grid td { border: 1px solid #000; padding: 4px; text-align: left; font-size: 9px; }
.pdf-print-grid th { background-color: #595959; color: white; font-weight: bold; }
.pdf-print-grid td:first-child, .pdf-print-grid th:first-child { width: 65px !important; max-width: 65px !important; }
.pdf-day-header { background-color: #595959; color: white; font-weight: bold; text-align: center; }
.pdf-period-label { background-color: #fde9d9; font-weight: bold; text-align: center; vertical-align: middle; min-height: 120px; width: 65px !important; max-width: 65px !important; padding: 4px 2px; font-size: 10px; word-break: break-word; overflow-wrap: break-word; }
.pdf-cell { vertical-align: top; min-height: 120px; padding: 3px !important; }
.pdf-session { border: 1px solid #000; border-radius: 2px; padding: 3px; margin-bottom: 2px; font-size: 9px; line-height: 1.2; }
.pdf-session.compulsory { border: 2px solid #ffff00; background-color: #fffacd; box-shadow: 0 0 0 2px #ffd700; }
.pdf-session.online { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
.pdf-session.blended { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }

.pdf-container { width: 100%; padding: 10px; background: white; }
.pdf-title { text-align: center; margin-bottom: 6px; }
.pdf-title h2 { font-size: 18px; font-weight: bold; margin: 0; }
.pdf-title h3 { font-size: 12px; margin: 2px 0 0 0; color: #666; }

.pdf-bottom-section { margin-top: 8px; display: flex; gap: 8px; }
.pdf-teacher-info { flex: 1.2; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; display: flex; flex-direction: column; height: fit-content; }
.pdf-teacher-info h4 { font-weight: bold; margin: 0 0 6px 0; font-size: 13px; flex-shrink: 0; }
.pdf-teacher-info-content { flex: 0; overflow-y: auto; }
.pdf-teacher-info-item { margin-bottom: 6px; font-size: 13px; line-height: 1.4; color: #222; word-break: break-word; display: flex; gap: 4px; align-items: flex-start; }
.pdf-teacher-info-item span { font-weight: 600; flex-shrink: 0; }
.pdf-teacher-info-item a { color: #0066cc; text-decoration: underline; font-size: 12px; word-break: break-all; letter-spacing: 0.2px; flex: 1; }

.pdf-notes-section { flex: 1.3; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; display: flex; flex-direction: column; height: fit-content; }
.pdf-notes-section h4 { font-weight: bold; margin: 0 0 6px 0; font-size: 13px; flex-shrink: 0; }
.pdf-notes-content { font-family: "Helvetica Neue", Arial, sans-serif; font-size: 13px; letter-spacing: 0.3px; line-height: 1.6; color: #222; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px 12px; flex: 0; white-space: pre-wrap; word-wrap: break-word; hyphens: auto; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-y: auto; }

.pdf-legend-section { flex: 0; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; display: flex; flex-direction: column; height: fit-content; }
.pdf-legend-section h4 { font-weight: bold; margin: 0 0 6px 0; font-size: 13px; flex-shrink: 0; }
.pdf-legend-item { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; font-size: 12px; }
.pdf-legend-circle { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

.pdf-total-hours { margin-top: 8px; text-align: right; font-size: 11px; font-weight: bold; }
.pdf-total-hours-value { display: inline-block; background: #1f2937; color: white; padding: 4px 10px; border-radius: 2px; margin-left: 6px; font-size: 10px; }

.color-circle { display: inline-block; width: 22px; height: 22px; border-radius: 50%; border: 1px solid #999; margin-right: 8px; vertical-align: middle; }
.course-list-item { padding: 12px; margin-bottom: 8px; background: #f3f4f6; border: 2px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.course-list-item:hover { background: #e5e7eb; }
.course-list-item.active { background: #dbeafe; border-color: #3b82f6; font-weight: bold; }
.staff-notes-input { max-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
.task-card { padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; background: white; }
.task-card.high { border-left: 4px solid #dc2626; background: #fee2e2; }
.task-card.medium { border-left: 4px solid #f59e0b; background: #fef3c7; }
.task-card.low { border-left: 4px solid #10b981; background: #ecfdf5; }
.task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
.task-title { font-weight: bold; font-size: 1.1rem; color: #1f2937; }
.task-status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
.task-status-todo { background: #e5e7eb; color: #374151; }
.task-status-inprogress { background: #dbeafe; color: #1e40af; }
.task-status-done { background: #dcfce7; color: #166534; }
.task-status-blocked { background: #fee2e2; color: #991b1b; }
.task-meta { display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; flex-wrap: wrap; align-items: center; }
.task-description { color: #4b5563; margin-bottom: 0.75rem; }
.task-actions { display: flex; gap: 0.5rem; }
.task-actions button { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; border: none; cursor: pointer; }
.task-edit-btn { background: #3b82f6; color: white; }
.task-edit-btn:hover { background: #2563eb; }
.task-delete-btn { background: #ef4444; color: white; }
.task-delete-btn:hover { background: #dc2626; }
.task-done-btn { background: #10b981; color: white; }
.task-done-btn:hover { background: #059669; }
.dropdown-menu { position: relative; display: inline-block; }
.dropdown-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.dropdown-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.dropdown-content { position: absolute; background: white; min-width: 250px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 0.375rem; z-index: 1; top: 100%; left: 0; margin-top: 0.5rem; display: none; border: 2px solid #667eea; max-height: 400px; overflow-y: auto; }
.dropdown-content.show { display: block; }
.dropdown-item { color: #1f2937; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
.dropdown-item:last-child { border-bottom: none; }
.dropdown-item:hover { background: #f3f4f6; color: #667eea; font-weight: 500; }
.dropdown-item i { width: 20px; text-align: center; color: #1e3a8a; }
.college-checkboxes { display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
.college-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; }
.college-checkbox-label input { cursor: pointer; width: 18px; height: 18px; }
.unassigned-badge { display: inline-block; background: #fbbf24; color: #78350f; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }

@media print { 
  body * { visibility: hidden; } 
  #print-area, #print-area * { visibility: visible; } 
  #print-area { position: absolute; left: 0; top: 0; width: 100%; } 
  .no-print { display: none !important; }
  .pdf-container { padding: 8px; }
  .pdf-print-grid { margin-bottom: 6px; }
}
</style>
</head>
<body class="bg-gray-100">
<div class="sidebar fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 -translate-x-full" id="sidebar">
<div class="p-4 bg-blue-900 text-white flex justify-between items-center no-print"><h2 class="text-xl font-bold">Data Hub</h2><button class="text-2xl" id="closeSidebarBtn">×</button></div>
<div class="p-4 space-y-3 no-print">
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Management</h3>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSemestersBtn"><i class="fa-solid fa-calendar-days mr-2 text-blue-900"></i> Manage Semesters</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageTeachersBtn"><i class="fa-solid fa-chalkboard-user mr-2 text-blue-900"></i> Manage Teachers</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageCoursesBtn"><i class="fa-solid fa-book mr-2 text-blue-900"></i> Manage Courses</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSubjectsBtn"><i class="fa-solid fa-palette mr-2 text-blue-900"></i> Manage Subjects</button>
<hr class="my-4"/>
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Data Actions</h3>
<button class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" id="exportDataBtn"><i class="fa-solid fa-file-export mr-2"></i> Export Data</button>
<button class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" id="importDataBtn"><i class="fa-solid fa-file-import mr-2"></i> Import Data</button>
<button class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" id="loadSampleDataBtn"><i class="fa-solid fa-rotate mr-2"></i> Load Sample Data</button>
<input type="file" id="importFileInput" accept=".json" style="display: none;"/>
</div>
</div>
<div class="transition-all duration-300" id="mainContent">
<header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
<div class="flex items-center gap-4"><img alt="TAFE Logo" src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762673524/ci_1595_1762673524_TAFE_logo_ecudtj.png" style="height: 50px;"/><h1 class="text-2xl font-bold text-blue-900">Interactive Timetabling App</h1></div>
<div class="flex items-center gap-3">
<button class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded" id="openSidebarBtn"><i class="fa-solid fa-bars mr-2"></i> Open Menu</button>
<div class="dropdown-menu">
<button class="dropdown-btn" id="semesterDropdownBtn"><i class="fa-solid fa-calendar-days"></i> Semester <i class="fa-solid fa-caret-down ml-1"></i></button>
<div class="dropdown-content" id="semesterDropdown"></div>
</div>
<div class="dropdown-menu">
<button class="dropdown-btn" id="viewDropdownBtn"><i class="fa-solid fa-eye"></i> View <i class="fa-solid fa-caret-down ml-1"></i></button>
<div class="dropdown-content" id="viewDropdown"></div>
</div>
<div id="secondary-selectors"></div>
<button class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded" id="printBtn"><i class="fa-solid fa-file-pdf mr-2"></i> Download PDF</button>
</div>
</header>
<main class="p-4">
<div class="flex items-center gap-2 mb-[-1px] no-print" id="college-tabs-container"></div>
<div id="print-area">
<div class="view-container active" id="main-timetable-view"><div class="bg-white p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-center mb-4" id="main-timetable-title"></h2><div class="timetable-grid-container"><div class="timetable-main-grid" id="main-timetable-grid"><div class="text-center p-10 col-span-6 text-gray-500">Load sample data or add your own to begin.</div></div></div></div></div>
<div class="view-container" id="staff-summary-view"><div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto"><h2 class="text-xl font-bold text-center mb-4" id="staff-summary-title"></h2><div id="staff-summary-table"></div></div></div>
<div class="view-container" id="dispute-log-view"></div>
<div class="view-container" id="course-print-view"></div>
<div class="view-container" id="teacher-print-view"></div>
<div class="view-container" id="tasks-view">
<div class="bg-white p-6 rounded-lg shadow-lg">
<div class="flex justify-between items-center mb-4">
    <div>
        <h2 class="text-2xl font-bold text-blue-900"><i class="fa-solid fa-clipboard-list mr-2"></i> Task Management</h2>
        <p class="text-gray-600 mt-1">Semester: <span id="tasksSemesterLabel" class="font-bold text-blue-900"></span></p>
    </div>
    <div class="flex items-center gap-4">
        <label class="flex items-center gap-2 text-gray-700 cursor-pointer select-none font-medium">
            <input type="checkbox" id="hideCompletedTasks" class="w-5 h-5"> Hide Completed
        </label>
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="addTaskBtn"><i class="fa-solid fa-plus mr-2"></i> Add New Task</button>
    </div>
</div>
<div id="tasks-container"></div>
</div>
</div>
</div>
</main>
</div>
<div class="context-menu" id="contextMenu"></div>
<div class="modal-overlay" id="managementModal"><div class="modal-container"><div class="management-modal-header"><h2 class="management-modal-title" id="modalTitle">Manage</h2><div class="management-modal-actions"><button class="add-btn" id="addItemBtn" style="display: none;"><i class="fa-solid fa-plus"></i> Add</button><button class="close-btn" id="closeModalBtn">×</button></div></div><div id="modalContent"></div></div></div>

<!-- Semester Wizard Modal -->
<div class="modal-overlay" id="semesterWizardModal">
    <div class="modal-container" style="max-width: 700px;">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-2xl font-bold text-blue-900"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i> New Semester Setup</h2>
            <button class="text-3xl font-bold text-gray-500 hover:text-gray-700" id="closeSemesterWizardBtn">×</button>
        </div>
        <form id="semesterWizardForm" class="space-y-6">
            <!-- Name -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Semester Name</label>
                <input type="text" name="wizardName" placeholder="e.g. Semester 2 2025" class="w-full border p-3 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
            </div>

            <!-- Data Source -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <label class="block text-sm font-bold text-blue-900 mb-3">Data Source</label>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="wizardSource" value="blank" class="w-5 h-5 text-blue-600" checked>
                        <span>Start Fresh (Empty Timetable)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="wizardSource" value="copy" class="w-5 h-5 text-blue-600">
                        <span>Copy Data from Existing Semester:</span>
                    </label>
                    <select name="wizardCopyFrom" class="w-full border p-2 rounded ml-8 mt-1" disabled>
                        <option value="">-- Select Semester --</option>
                    </select>
                </div>
            </div>

            <!-- College Configuration -->
            <div class="border p-4 rounded-lg">
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-sm font-bold text-gray-700">College Configuration</label>
                    <button type="button" id="addCollegeBtn" class="text-sm text-blue-600 font-bold hover:underline">+ Add College</button>
                </div>
                <div id="wizardCollegeList" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Dynamic list -->
                </div>
                <p class="text-xs text-gray-500 mt-2 italic">These colleges will be available for this semester only.</p>
            </div>

            <!-- Time Configuration -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Grid Start Hour</label>
                    <input type="number" name="wizardStartHour" value="8" min="6" max="12" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Grid End Hour</label>
                    <input type="number" name="wizardEndHour" value="18" min="13" max="23" class="w-full border p-2 rounded">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button type="button" class="px-6 py-2 rounded text-gray-600 font-bold hover:bg-gray-100" id="cancelWizardBtn">Cancel</button>
                <button type="submit" class="px-6 py-2 rounded bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg transform hover:-translate-y-0.5 transition-all">Create Semester</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="sessionModal"><div class="modal-container" style="max-width: 500px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="sessionModalTitle">Add/Edit Session</h2><button class="text-3xl font-bold" id="closeSessionModalBtn" type="button">×</button></div><form class="space-y-4" id="sessionForm"><input id="sessionId" type="hidden"/><input id="sessionDay" type="hidden"/><div><label class="block font-medium">Course</label><select class="w-full border p-2 rounded" id="sessionCourse" required=""></select></div><div><label class="block font-medium">Subject</label><select class="w-full border p-2 rounded" id="sessionSubject" required=""></select></div><div><label class="block font-medium">Teacher 1 (Primary) <span class="text-gray-500 text-sm">(Optional)</span></label><select class="w-full border p-2 rounded" id="sessionTeacher"></select></div><div><label class="block font-medium">Teacher 2 (Co-teacher - Optional)</label><select class="w-full border p-2 rounded" id="sessionTeacher2"><option value="">-- None --</option></select></div><div><label class="block font-medium">Room</label><input class="w-full border p-2 rounded" id="sessionRoom" required="" type="text"/></div><div><label class="block font-medium mb-2">Colleges (select one or more)</label><div class="college-checkboxes" id="sessionModalCollegeCheckboxes"><!-- Dynamic --></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Start Time</label><input class="w-full border p-2 rounded" id="sessionStartTime" required="" step="1800" type="time"/></div><div><label class="block font-medium">End Time</label><input class="w-full border p-2 rounded" id="sessionEndTime" required="" step="1800" type="time"/></div></div><div><label class="block font-medium">Notes (e.g., Face-to-Face)</label><textarea class="w-full border p-2 rounded" id="sessionNotes" rows="2"></textarea></div><div class="flex justify-between items-center mt-6"><button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteSessionBtn" type="button">Delete</button><button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" type="submit">Save Session</button></div></form></div></div>
<div class="modal-overlay" id="duplicateDayModal"><div class="modal-container" style="max-width: 400px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Duplicate to Another Day</h2><button class="text-3xl font-bold" id="closeDuplicateDayModalBtn">×</button></div><div class="space-y-3" id="duplicateDayContent"></div></div></div>
<div class="modal-overlay" id="addTeacherModal"><div class="modal-container" style="max-width: 500px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Add / Edit Teacher</h2><button class="text-3xl font-bold" id="closeAddTeacherModalBtn">×</button></div><form class="space-y-4" id="addTeacherForm"><input type="hidden" name="editIndex"><div><label class="block text-sm font-medium">Name</label><input type="text" name="Name" class="w-full border p-2 rounded" required></div><div><label class="block text-sm font-medium">Surname</label><input type="text" name="Surname" class="w-full border p-2 rounded" required></div><div><label class="block text-sm font-medium">Initials</label><input type="text" name="Initials" class="w-full border p-2 rounded bg-gray-200" readonly></div><div><label class="block text-sm font-medium">Email</label><input type="email" name="Email" class="w-full border p-2 rounded" required></div><div><label class="block text-sm font-medium">Home College</label><select name="HomeCollege" id="teacherHomeCollegeSelect" class="w-full border p-2 rounded" required><!-- Dynamic --></select></div><div><label class="block text-sm font-medium">Employment Type</label><select name="EmploymentType" class="w-full border p-2 rounded" required><option value="Full-Time">Full-Time</option><option value="Casual">Casual</option></select></div><div><label class="block text-sm font-medium">Total Hours</label><input type="number" name="TotalHours" class="w-full border p-2 rounded" required value="0" step="0.5"></div><div class="flex items-center gap-2 border p-2 rounded bg-blue-50"><input type="checkbox" name="isHeadTeacher" id="isHeadTeacher" class="w-5 h-5 text-blue-600"><label for="isHeadTeacher" class="cursor-pointer font-medium text-blue-900">Head Teacher</label></div><div class="flex gap-2 justify-end"><button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" id="cancelAddTeacherBtn">Cancel</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save Teacher</button></div></form></div></div>
<div class="modal-overlay" id="taskModal"><div class="modal-container" style="max-width: 600px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="taskModalTitle">Add New Task</h2><button class="text-3xl font-bold" id="closeTaskModalBtn">×</button></div><form class="space-y-4" id="taskForm"><input id="taskId" type="hidden"/><div><label class="block font-medium">Task Title</label><input type="text" id="taskTitle" class="w-full border p-2 rounded" required placeholder="Enter task title"/></div><div><label class="block font-medium">Description</label><textarea id="taskDescription" class="w-full border p-2 rounded" rows="3" placeholder="Enter task description (optional)"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Assign to Teacher</label><select id="taskTeacher" class="w-full border p-2 rounded"><option value="">-- None --</option></select></div><div><label class="block font-medium">Assign to Course</label><select id="taskCourse" class="w-full border p-2 rounded"><option value="">-- None --</option></select></div></div><div><label class="block font-medium mb-2">Colleges (select one or more)</label><div class="college-checkboxes" id="taskCollegeCheckboxes"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Priority</label><select id="taskPriority" class="w-full border p-2 rounded" required><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div><div><label class="block font-medium">Status</label><select id="taskStatus" class="w-full border p-2 rounded" required><option value="todo" selected>To Do</option><option value="inprogress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div></div><div><label class="block font-medium">Due Date</label><input type="date" id="taskDueDate" class="w-full border p-2 rounded"/></div><div class="flex justify-between items-center mt-6"><button type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteTaskBtn" style="display: none;">Delete Task</button><div class="flex gap-2"><button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" id="cancelTaskBtn">Cancel</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save Task</button></div></div></form></div></div>
<div class="modal-overlay" id="loadingOverlay" style="display: none; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.9); z-index: 200;">
<div class="text-center p-8 bg-white rounded-lg shadow-xl border-2 border-blue-500">
<div style="width: 60px; height: 60px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
<h2 class="text-2xl font-bold text-blue-900 mb-2">Generating PDF...</h2>
<p class="text-gray-600">Please wait, this may take a moment.</p>
</div>
</div>
<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<!-- PDF Generator Script -->
<script src="pdf-generator.js"></script>

<script>
// Global State for persistence
window.appState = {
    selectedCourse: null,
    selectedTeacher: null,
    hideCompletedTasks: false
};

let selectedCourseForSubjects = null;
let sidebarOpen = false;

document.addEventListener('DOMContentLoaded', () => {
let db = {};
const defaultColleges = ['Moss Vale', 'Goulburn', 'Queanbeyan'];
const getNewSemesterData = (collegeList = defaultColleges, config = { startHour: 8, endHour: 18 }) => ({ 
    courses: [], 
    teachers: [], 
    subjects: [], 
    schedule: [], 
    currentCollege: 'Master View', 
    staffNotes: {}, 
    tasks: [], 
    colleges: [...collegeList],
    config: config
});

const saveData = () => localStorage.setItem('timetableDataV2', JSON.stringify(db));
const loadData = () => {
    const savedData = localStorage.getItem('timetableDataV2');
    if (savedData) {
        db = JSON.parse(savedData);
        Object.keys(db.semesters).forEach(semKey => {
            // Migration: Ensure colleges list exists
            if (!db.semesters[semKey].colleges) {
                db.semesters[semKey].colleges = [...defaultColleges];
            }
            // Migration: Ensure config exists
            if (!db.semesters[semKey].config) {
                db.semesters[semKey].config = { startHour: 8, endHour: 18 };
            }
            if (db.semesters[semKey].subjects) {
                db.semesters[semKey].subjects.forEach(subj => {
                    if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
                });
            }
            if (!db.semesters[semKey].staffNotes) {
                db.semesters[semKey].staffNotes = {};
            }
            if (!db.semesters[semKey].tasks) {
                db.semesters[semKey].tasks = [];
            }
        });
    } else {
        db = {
            semesters: { 'Semester 1 2024': getNewSemesterData() },
            currentSemester: 'Semester 1 2024'
        };
    }
};

const exportData = () => {
const dataStr = JSON.stringify(db, null, 2);
const dataBlob = new Blob([dataStr], { type: 'application/json' });
const url = URL.createObjectURL(dataBlob);
const link = document.createElement('a');
link.href = url;
link.download = `timetable-backup-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);
alert('Data exported successfully!');
};

const importData = () => {
document.getElementById('importFileInput').click();
};

document.getElementById('importFileInput').addEventListener('change', (e) => {
const file = e.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = (event) => {
try {
const importedData = JSON.parse(event.target.result);

if (!importedData.semesters || !importedData.currentSemester) {
throw new Error('Invalid data format. Missing semesters or currentSemester.');
}

if (confirm('This will replace all your current data. Are you sure?')) {
db = importedData;
// Run migration on imported data
Object.keys(db.semesters).forEach(semKey => {
    if (!db.semesters[semKey].colleges) db.semesters[semKey].colleges = [...defaultColleges];
    if (!db.semesters[semKey].config) db.semesters[semKey].config = { startHour: 8, endHour: 18 };
    if (db.semesters[semKey].subjects) {
        db.semesters[semKey].subjects.forEach(subj => {
            if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
        });
    }
    if (!db.semesters[semKey].staffNotes) {
        db.semesters[semKey].staffNotes = {};
    }
    if (!db.semesters[semKey].tasks) {
        db.semesters[semKey].tasks = [];
    }
});
saveData();
processAndRenderAll();
alert('Data imported successfully!');
}
} catch (error) {
alert(`Error importing data: ${error.message}`);
}
};
reader.readAsText(file);

e.target.value = '';
});

const getCurrentSemesterData = () => {
if (!db.semesters[db.currentSemester]) {
const firstSemester = Object.keys(db.semesters)[0];
if (firstSemester) {
db.currentSemester = firstSemester;
} else {
db.semesters['Default Semester'] = getNewSemesterData();
db.currentSemester = 'Default Semester';
}
}
return db.semesters[db.currentSemester];
};

// Get available colleges for the CURRENT semester
const getCurrentColleges = () => {
    return getCurrentSemesterData().colleges || defaultColleges;
};

const collegeTabsContainer = document.getElementById('college-tabs-container');
const sessionForm = document.getElementById('sessionForm');
const managementModal = document.getElementById('managementModal');
// Removed old semesterModal logic, replaced with Wizard
const semesterWizardModal = document.getElementById('semesterWizardModal');
const contextMenu = document.getElementById('contextMenu');
const duplicateDayModal = document.getElementById('duplicateDayModal');
const taskModal = document.getElementById('taskModal');
const taskForm = document.getElementById('taskForm');
const secondarySelectorsContainer = document.getElementById('secondary-selectors');
const sidebar = document.getElementById('sidebar');
const openSidebarBtn = document.getElementById('openSidebarBtn');
const closeSidebarBtn = document.getElementById('closeSidebarBtn');

openSidebarBtn.addEventListener('click', () => {
sidebarOpen = !sidebarOpen;
if (sidebarOpen) {
sidebar.classList.add('sidebar-open');
} else {
sidebar.classList.remove('sidebar-open');
}
});

closeSidebarBtn.addEventListener('click', () => {
sidebarOpen = false;
sidebar.classList.remove('sidebar-open');
});

document.getElementById('printBtn').addEventListener('click', () => {
const pdfGen = new PDFGenerator(db, getCurrentSemesterData);
pdfGen.generate();
});

document.getElementById('exportDataBtn').addEventListener('click', exportData);
document.getElementById('importDataBtn').addEventListener('click', importData);
document.getElementById('addTaskBtn').addEventListener('click', openTaskModal);
document.getElementById('closeTaskModalBtn').addEventListener('click', () => taskModal.classList.remove('active'));
document.getElementById('cancelTaskBtn').addEventListener('click', () => taskModal.classList.remove('active'));
// Tasks Filter
document.getElementById('hideCompletedTasks').addEventListener('change', (e) => {
    window.appState.hideCompletedTasks = e.target.checked;
    renderTasksView();
});

document.getElementById('addTeacherForm').addEventListener('submit', (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const editIndex = formData.get('editIndex');
const semesterData = getCurrentSemesterData();

const teacherData = {
Name: formData.get('Name'),
Surname: formData.get('Surname'),
Initials: formData.get('Initials'),
Email: formData.get('Email'),
HomeCollege: formData.get('HomeCollege'),
EmploymentType: formData.get('EmploymentType'),
TotalHours: parseFloat(formData.get('TotalHours')) || 0,
isHeadTeacher: document.getElementById('isHeadTeacher').checked // Capture Head Teacher status
};

if (editIndex) {
semesterData.teachers[parseInt(editIndex, 10)] = teacherData;
} else {
semesterData.teachers.push(teacherData);
}

document.getElementById('addTeacherModal').classList.remove('active');
openManagementModal('Teachers', semesterData.teachers, ['Name', 'Surname', 'Initials', 'Email', 'HomeCollege', 'EmploymentType', 'TotalHours']);
processAndRenderAll();
});

// Auto-generate initials
const nameInput = document.querySelector('#addTeacherForm input[name="Name"]');
const surnameInput = document.querySelector('#addTeacherForm input[name="Surname"]');
const initialsInput = document.querySelector('#addTeacherForm input[name="Initials"]');
const updateInitials = () => {
const firstInitial = nameInput.value.trim()[0]?.toUpperCase() || '';
const secondInitial = surnameInput.value.trim()[0]?.toUpperCase() || '';
initialsInput.value = `${firstInitial}${secondInitial}`;
};
nameInput.addEventListener('input', updateInitials);
surnameInput.addEventListener('input', updateInitials);
document.getElementById('deleteTaskBtn').addEventListener('click', deleteTask);
taskForm.addEventListener('submit', saveTask);
document.getElementById('closeModalBtn').addEventListener('click', () => managementModal.classList.remove('active'));
document.getElementById('closeSessionModalBtn').addEventListener('click', () => document.getElementById('sessionModal').classList.remove('active'));
document.getElementById('closeDuplicateDayModalBtn').addEventListener('click', () => duplicateDayModal.classList.remove('active'));
document.getElementById('closeAddTeacherModalBtn').addEventListener('click', () => document.getElementById('addTeacherModal').classList.remove('active'));
document.getElementById('cancelAddTeacherBtn').addEventListener('click', () => document.getElementById('addTeacherModal').classList.remove('active'));
document.getElementById('loadSampleDataBtn').addEventListener('click', () => {
// Sample loader logic can remain simple or be updated to use current colleges
// For simplicity, we'll load data into current context
const currentData = getCurrentSemesterData();
// ... (Keep existing simple sample loading for now)
alert(`Sample data loaded!`);
});

// Updated: openSemesterModal now opens the Wizard
document.getElementById('manageSemestersBtn').addEventListener('click', openSemesterWizard);

document.getElementById('manageTeachersBtn').addEventListener('click', () => openManagementModal('Teachers', getCurrentSemesterData().teachers, ['Name', 'Surname', 'Initials', 'Email', 'HomeCollege', 'EmploymentType', 'TotalHours']));
document.getElementById('manageCoursesBtn').addEventListener('click', () => openManagementModal('Courses', getCurrentSemesterData().courses, ['Code', 'Name']));
document.getElementById('manageSubjectsBtn').addEventListener('click', () => openManagementModal('Subjects', getCurrentSemesterData().subjects, ['Subject', 'CourseCode', 'Color', 'Units', 'Compulsory', 'DeliveryMode']));
sessionForm.addEventListener('submit', handleSessionFormSubmit);
document.getElementById('deleteSessionBtn').addEventListener('click', handleDeleteSession);
document.getElementById('sessionModal').addEventListener('click', (e) => { if (e.target.id === 'sessionModal') e.currentTarget.classList.remove('active'); });
document.addEventListener('click', () => contextMenu.classList.remove('active'));

// Semester Wizard Logic
const wizardModal = document.getElementById('semesterWizardModal');
const wizardForm = document.getElementById('semesterWizardForm');
const wizardSourceRadios = document.getElementsByName('wizardSource');
const wizardCopySelect = document.querySelector('select[name="wizardCopyFrom"]');
const wizardCollegeList = document.getElementById('wizardCollegeList');
const addCollegeBtn = document.getElementById('addCollegeBtn');

// Set up Wizard Event Listeners
document.getElementById('closeSemesterWizardBtn').addEventListener('click', () => wizardModal.classList.remove('active'));
document.getElementById('cancelWizardBtn').addEventListener('click', () => wizardModal.classList.remove('active'));

// Toggle Copy Dropdown
wizardSourceRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
        wizardCopySelect.disabled = e.target.value !== 'copy';
    });
});

// Add College Button in Wizard
addCollegeBtn.addEventListener('click', () => {
    const newName = prompt("Enter college name (e.g. 'North Campus'):");
    if (newName && newName.trim() !== "") {
        addCollegeToWizardList(newName.trim());
    }
});

function addCollegeToWizardList(name) {
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200';
    div.innerHTML = `
        <span class="font-medium text-gray-700">${name}</span>
        <input type="hidden" name="wizardColleges" value="${name}">
        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.remove()">
            <i class="fa-solid fa-trash"></i>
        </button>
    `;
    wizardCollegeList.appendChild(div);
}

function openSemesterWizard() {
    // Populate Copy Dropdown
    wizardCopySelect.innerHTML = '<option value="">-- Select Semester --</option>';
    Object.keys(db.semesters).sort().forEach(sem => {
        wizardCopySelect.innerHTML += `<option value="${sem}">${sem}</option>`;
    });

    // Populate Colleges (Clone from current semester)
    wizardCollegeList.innerHTML = '';
    const currentCols = getCurrentColleges();
    currentCols.forEach(col => addCollegeToWizardList(col));

    // Populate Time Config
    const currentConfig = getCurrentSemesterData().config || { startHour: 8, endHour: 18 };
    document.querySelector('input[name="wizardStartHour"]').value = currentConfig.startHour;
    document.querySelector('input[name="wizardEndHour"]').value = currentConfig.endHour;

    // Reset Form state
    wizardForm.reset();
    wizardSourceRadios[0].checked = true; // Default to Blank
    wizardCopySelect.disabled = true;

    wizardModal.classList.add('active');
}

wizardForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newName = formData.get('wizardName').trim();
    const source = formData.get('wizardSource');
    const copyFrom = formData.get('wizardCopyFrom');
    
    // Get colleges
    const newColleges = Array.from(wizardForm.querySelectorAll('input[name="wizardColleges"]')).map(i => i.value);
    if (newColleges.length === 0) {
        alert("You must have at least one college.");
        return;
    }

    const newConfig = {
        startHour: parseInt(formData.get('wizardStartHour')),
        endHour: parseInt(formData.get('wizardEndHour'))
    };

    if (!newName) { alert("Please enter a semester name."); return; }
    if (db.semesters[newName]) { alert("A semester with this name already exists."); return; }

    let newData;

    if (source === 'copy' && copyFrom && db.semesters[copyFrom]) {
        // Deep Clone
        const sourceData = db.semesters[copyFrom];
        newData = JSON.parse(JSON.stringify(sourceData));
        // Override with new configs
        newData.colleges = newColleges;
        newData.config = newConfig;
        // Reset currentCollege if it's invalid in new list
        if (!newColleges.includes(newData.currentCollege) && newData.currentCollege !== 'Master View') {
            newData.currentCollege = 'Master View';
        }
    } else {
        // Start Blank
        newData = getNewSemesterData(newColleges, newConfig);
    }

    db.semesters[newName] = newData;
    db.currentSemester = newName;
    
    wizardModal.classList.remove('active');
    processAndRenderAll();
    alert(`Semester "${newName}" created successfully!`);
});


const semesterDropdownBtn = document.getElementById('semesterDropdownBtn');
const semesterDropdown = document.getElementById('semesterDropdown');
const viewDropdownBtn = document.getElementById('viewDropdownBtn');
const viewDropdown = document.getElementById('viewDropdown');

semesterDropdownBtn.addEventListener('click', (e) => {
e.stopPropagation();
semesterDropdown.classList.toggle('show');
viewDropdown.classList.remove('show');
document.getElementById('courseDropdown')?.classList.remove('show');
document.getElementById('teacherDropdown')?.classList.remove('show');
});

viewDropdownBtn.addEventListener('click', (e) => {
e.stopPropagation();
viewDropdown.classList.toggle('show');
semesterDropdown.classList.remove('show');
document.getElementById('courseDropdown')?.classList.remove('show');
document.getElementById('teacherDropdown')?.classList.remove('show');
});

document.addEventListener('click', () => {
semesterDropdown.classList.remove('show');
viewDropdown.classList.remove('show');
document.getElementById('courseDropdown')?.classList.remove('show');
document.getElementById('teacherDropdown')?.classList.remove('show');
});


function processAndRenderAll() {
detectDisputes();
renderSemesterDropdown();
renderViewDropdown();
renderCollegeTabs();
handleViewChange();
saveData();
}

const timeToMinutes = (timeStr) => !timeStr ? 0 : timeStr.split(':').map(Number).reduce((h, m) => h * 60 + m);
const dayOrder = { 'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3, 'Friday': 4 };
const sortSessionsChronologically = (sessions) => {
return [...sessions].sort((a, b) => {
const dayDiff = (dayOrder[a.Day] || 0) - (dayOrder[b.Day] || 0);
if (dayDiff !== 0) return dayDiff;
return timeToMinutes(a.ClassStart) - timeToMinutes(b.ClassStart);
});
};

function detectDisputes() {
const semesterData = getCurrentSemesterData();
if (!semesterData.schedule) semesterData.schedule = [];
semesterData.schedule.forEach(s => s.dispute = null);
for (let i = 0; i < semesterData.schedule.length; i++) {
for (let j = i + 1; j < semesterData.schedule.length; j++) {
const s1 = semesterData.schedule[i];
const s2 = semesterData.schedule[j];

const sharedColleges = s1.colleges?.filter(c => s2.colleges?.includes(c)) || [];
if (sharedColleges.length === 0) continue;

if (s1.Day !== s2.Day) continue;

const timeOverlap = timeToMinutes(s1.ClassStart) < timeToMinutes(s2.ClassEnd) && timeToMinutes(s2.ClassStart) < timeToMinutes(s1.ClassEnd);
if (timeOverlap) {
let reason = null;
const s1Teachers = [s1.TeacherInitials, s1.TeacherInitials2].filter(Boolean);
const s2Teachers = [s2.TeacherInitials, s2.TeacherInitials2].filter(Boolean);
const commonTeachers = s1Teachers.filter(t => s2Teachers.includes(t));

if (commonTeachers.length > 0) reason = `Teacher Conflict: ${commonTeachers.join(', ')}`;
else if (s1.Room === s2.Room) reason = `Room Conflict: ${s1.Room}`;

if (reason) {
s1.dispute = { reason: reason, conflictingSessionId: s2.id };
s2.dispute = { reason: reason, conflictingSessionId: s1.id };
}
}
}
}
}

function renderSemesterDropdown() {
const semesterNames = Object.keys(db.semesters).sort();
let html = '';
semesterNames.forEach(name => {
html += `<div class="dropdown-item ${db.currentSemester === name ? 'font-bold text-purple-600' : ''}" onclick="changeSemester('${name}')">${name}</div>`;
});
semesterDropdown.innerHTML = html + '<div class="border-t my-1"></div><div class="dropdown-item text-blue-600 font-bold" onclick="openSemesterWizard()"><i class="fa-solid fa-plus mr-2"></i> CREATE NEW</div>';
}

function renderViewDropdown() {
const views = [
{ value: 'main-timetable', label: 'Main Timetable', icon: 'fa-table-columns' },
{ value: 'staff-summary', label: 'Staff Summary', icon: 'fa-users' },
{ value: 'dispute-log', label: 'Dispute Log', icon: 'fa-triangle-exclamation' },
{ value: 'course-print', label: 'Course Print', icon: 'fa-book' },
{ value: 'teacher-print', label: 'Teacher Print', icon: 'fa-chalkboard-user' },
{ value: 'tasks', label: 'Tasks', icon: 'fa-clipboard-list' }
];

let html = '';
views.forEach(view => {
html += `<div class="dropdown-item" onclick="changeView('${view.value}')"><i class="fa-solid ${view.icon} mr-2 text-blue-900"></i> ${view.label}</div>`;
});
viewDropdown.innerHTML = html;
}

window.changeSemester = (semesterName) => {
db.currentSemester = semesterName;
processAndRenderAll();
semesterDropdown.classList.remove('show');
};

window.changeView = (viewName) => {
const viewSelector = document.getElementById('viewSelector');
if (!viewSelector) {
window.currentView = viewName;
} else {
viewSelector.value = viewName;
}
handleViewChange(viewName);
viewDropdown.classList.remove('show');
};

function renderCollegeTabs() {
const currentData = getCurrentSemesterData();
// Use dynamic colleges
const colleges = getCurrentColleges();
let tabsHTML = `<button class="college-tab ${currentData.currentCollege === 'Master View' ? 'active' : ''}" data-college="Master View"><i class="fa-solid fa-globe"></i> Master View</button>`;
tabsHTML += colleges.map(c => `<button class="college-tab ${currentData.currentCollege === c ? 'active' : ''}" data-college="${c}"><i class="fa-solid fa-school"></i> ${c}</button>`).join('');
collegeTabsContainer.innerHTML = tabsHTML;
collegeTabsContainer.querySelectorAll('.college-tab').forEach(tab => tab.addEventListener('click', (e) => {
getCurrentSemesterData().currentCollege = e.currentTarget.dataset.college;
processAndRenderAll();
}));
}

function openTaskModal(taskId = null) {
const semesterData = getCurrentSemesterData();
const task = taskId ? semesterData.tasks.find(t => t.id === taskId) : null;

document.getElementById('taskModalTitle').textContent = task ? 'Edit Task' : 'Add New Task';
document.getElementById('taskId').value = task?.id || '';
document.getElementById('taskTitle').value = task?.title || '';
document.getElementById('taskDescription').value = task?.description || '';
document.getElementById('taskTeacher').value = task?.teacher || '';
document.getElementById('taskCourse').value = task?.course || '';
document.getElementById('taskPriority').value = task?.priority || 'medium';
document.getElementById('taskStatus').value = task?.status || 'todo';
document.getElementById('taskDueDate').value = task?.dueDate || '';
document.getElementById('deleteTaskBtn').style.display = task ? 'block' : 'none';

const teacherSelect = document.getElementById('taskTeacher');
const courseSelect = document.getElementById('taskCourse');
const collegeCheckboxesContainer = document.getElementById('taskCollegeCheckboxes');

const sortedTeachers = [...semesterData.teachers].sort((a, b) => {
const surnameA = (a.Surname || '').toLowerCase();
const surnameB = (b.Surname || '').toLowerCase();
if (surnameA !== surnameB) return surnameA.localeCompare(surnameB);
const nameA = (a.Name || '').toLowerCase();
const nameB = (b.Name || '').toLowerCase();
return nameA.localeCompare(nameB);
});

const sortedCourses = [...semesterData.courses].sort((a, b) => (a.Code || '').localeCompare(b.Code || ''));
// Use Dynamic Colleges
const sortedColleges = getCurrentColleges().sort();

teacherSelect.innerHTML = '<option value="">-- None --</option>' + sortedTeachers.map(t => `<option value="${t.Initials}">${t.Name} ${t.Surname}</option>`).join('');
courseSelect.innerHTML = '<option value="">-- None --</option>' + sortedCourses.map(c => `<option value="${c.Code}">${c.Code} - ${c.Name}</option>`).join('');

let collegeCheckboxesHTML = '';
sortedColleges.forEach(col => {
const isChecked = task?.colleges?.includes(col) ? 'checked' : '';
collegeCheckboxesHTML += `<label class="college-checkbox-label"><input type="checkbox" name="taskCollege" value="${col}" ${isChecked}> ${col}</label>`;
});
collegeCheckboxesContainer.innerHTML = collegeCheckboxesHTML;

if (task) {
teacherSelect.value = task.teacher || '';
courseSelect.value = task.course || '';
}

taskModal.classList.add('active');
}

function saveTask(e) {
e.preventDefault();
const semesterData = getCurrentSemesterData();
const taskId = document.getElementById('taskId').value;

const selectedColleges = Array.from(document.querySelectorAll('input[name="taskCollege"]:checked')).map(cb => cb.value);

const taskData = {
id: taskId || Date.now(),
title: document.getElementById('taskTitle').value,
description: document.getElementById('taskDescription').value,
teacher: document.getElementById('taskTeacher').value,
course: document.getElementById('taskCourse').value,
colleges: selectedColleges.length > 0 ? selectedColleges : [],
priority: document.getElementById('taskPriority').value,
status: document.getElementById('taskStatus').value,
dueDate: document.getElementById('taskDueDate').value
};

if (taskId) {
const index = semesterData.tasks.findIndex(t => t.id == taskId);
if (index !== -1) {
semesterData.tasks[index] = taskData;
}
} else {
semesterData.tasks.push(taskData);
}

taskModal.classList.remove('active');
processAndRenderAll();
}

function deleteTask() {
const taskId = document.getElementById('taskId').value;
if (confirm('Are you sure you want to delete this task?')) {
const semesterData = getCurrentSemesterData();
semesterData.tasks = semesterData.tasks.filter(t => t.id != taskId);
taskModal.classList.remove('active');
processAndRenderAll();
}
}

// QUICK ACTION: Mark as Done
window.markTaskDone = (taskId) => {
    const semesterData = getCurrentSemesterData();
    const task = semesterData.tasks.find(t => t.id === taskId);
    if (task) {
        task.status = 'done';
        processAndRenderAll();
    }
};

function renderTasksView() {
const container = document.getElementById('tasks-container');
const semesterLabel = document.getElementById('tasksSemesterLabel');
const semesterData = getCurrentSemesterData();
let tasks = semesterData.tasks || [];

semesterLabel.textContent = db.currentSemester;

// FILTER: Hide Completed
if (window.appState.hideCompletedTasks) {
    tasks = tasks.filter(t => t.status !== 'done');
}

if (tasks.length === 0) {
container.innerHTML = '<p class="text-center text-gray-500 py-8">No tasks found.</p>';
return;
}

let html = '';
tasks.forEach(task => {
const teacher = semesterData.teachers.find(t => t.Initials === task.teacher);
const course = semesterData.courses.find(c => c.Code === task.course);
const teacherDisplay = teacher ? `${teacher.Name} ${teacher.Surname}` : 'Unassigned';
const courseDisplay = course ? `${course.Code}` : 'Unassigned';
const collegeDisplay = task.colleges && task.colleges.length > 0 ? task.colleges.join(', ') : 'All Colleges';
const statusClass = `task-status-${task.status}`;
const statusText = task.status === 'inprogress' ? 'In Progress' : (task.status === 'todo' ? 'To Do' : (task.status === 'done' ? 'Done' : 'Blocked'));
const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';

// Add Done Button Logic
const doneButton = task.status !== 'done' 
    ? `<button class="task-done-btn" onclick="window.markTaskDone(${task.id})" title="Mark Completed"><i class="fa-solid fa-check"></i> Done</button>` 
    : '';

html += `
<div class="task-card ${task.priority}">
<div class="task-header">
<div class="task-title">${task.title}</div>
<span class="task-status-badge ${statusClass}">${statusText}</span>
</div>
<div class="task-meta">
<span><i class="fa-solid fa-user mr-1 text-blue-900"></i> ${teacherDisplay}</span>
<span><i class="fa-solid fa-book mr-1 text-blue-900"></i> ${courseDisplay}</span>
<span><i class="fa-solid fa-school mr-1 text-blue-900"></i> ${collegeDisplay}</span>
<span><i class="fa-solid fa-calendar-days mr-1 text-blue-900"></i> ${dueDate}</span>
<span><i class="fa-solid fa-bullseye mr-1 text-blue-900"></i> ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
</div>
${task.description ? `<div class="task-description">${task.description}</div>` : ''}
<div class="task-actions">
${doneButton}
<button class="task-edit-btn" onclick="window.editTask(${task.id})"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
<button class="task-delete-btn" onclick="window.deleteTaskFromList(${task.id})"><i class="fa-solid fa-trash"></i> Delete</button>
</div>
</div>
`;
});

container.innerHTML = html;
}

window.editTask = (taskId) => {
openTaskModal(taskId);
};

window.deleteTaskFromList = (taskId) => {
if (confirm('Are you sure you want to delete this task?')) {
const semesterData = getCurrentSemesterData();
semesterData.tasks = semesterData.tasks.filter(t => t.id !== taskId);
processAndRenderAll();
}
};

// Management Configuration for global handlers
const MANAGEMENT_FIELDS = {
    'teachers': ['Name', 'Surname', 'Initials', 'Email', 'HomeCollege', 'EmploymentType', 'TotalHours'],
    'courses': ['Code', 'Name'],
    'subjects': ['Subject', 'CourseCode', 'Color', 'Units', 'Compulsory', 'DeliveryMode']
};

// Global Management Handlers
window.handleManagementDelete = (type, index) => {
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        const semesterData = getCurrentSemesterData();
        const dataCollection = semesterData[type];
        dataCollection.splice(parseInt(index, 10), 1);
        
        const capitalType = type.charAt(0).toUpperCase() + type.slice(1);
        const data = dataCollection;
        const fields = MANAGEMENT_FIELDS[type];

        openManagementModal(capitalType, data, fields);
        processAndRenderAll();
    }
};

window.handleManagementEdit = (type, index) => {
    const semesterData = getCurrentSemesterData();
    const dataCollection = semesterData[type];
    const item = dataCollection[parseInt(index, 10)];
    const capitalType = type.charAt(0).toUpperCase() + type.slice(1);

    if (type === 'teachers') {
        document.getElementById('addTeacherModal').classList.add('active');
        document.getElementById('addTeacherForm').reset();
        document.querySelector('#addTeacherForm input[name="Name"]').value = item.Name;
        document.querySelector('#addTeacherForm input[name="Surname"]').value = item.Surname;
        document.querySelector('#addTeacherForm input[name="Initials"]').value = item.Initials;
        document.querySelector('#addTeacherForm input[name="Email"]').value = item.Email;
        
        // Populate dynamic colleges BEFORE setting value
        const homeCollegeSelect = document.querySelector('#addTeacherForm select[name="HomeCollege"]');
        homeCollegeSelect.innerHTML = getCurrentColleges().map(c => `<option value="${c}">${c}</option>`).join('');
        homeCollegeSelect.value = item.HomeCollege;

        document.querySelector('#addTeacherForm select[name="EmploymentType"]').value = item.EmploymentType;
        document.querySelector('#addTeacherForm input[name="TotalHours"]').value = item.TotalHours;
        document.querySelector('#addTeacherForm input[name="editIndex"]').value = index;
        document.getElementById('isHeadTeacher').checked = item.isHeadTeacher || false; // Set Checkbox
    } else {
        const form = document.getElementById('addForm');
        if (form) {
            for (const key in item) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = item[key];
                    } else {
                        input.value = Array.isArray(item[key]) ? item[key].join(', ') : item[key];
                    }
                }
            }
            form.querySelector('[name="editIndex"]').value = index;
            form.querySelector('button[type="submit"]').textContent = `Update ${capitalType.slice(0, -1)}`;
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.style.display = 'block';
        }
    }
};

function openManagementModal(title, data, fields) {
    document.getElementById('modalTitle').textContent = `Manage ${title}`;
    const addItemBtn = document.getElementById('addItemBtn');
    
    // Reset addItemBtn handler to prevent stacking
    addItemBtn.onclick = null;

    if (title === 'Subjects') {
        addItemBtn.style.display = 'none';
        const semesterData = getCurrentSemesterData();
        if (!selectedCourseForSubjects && semesterData.courses.length > 0) {
            selectedCourseForSubjects = semesterData.courses[0].Code;
        }

        const renderSubjectsModal = () => {
            const filteredSubjects = data.filter(s => s.CourseCode === selectedCourseForSubjects);
            const sortedSubjects = [...filteredSubjects].sort((a, b) => {
                const subjectA = (a.Subject || '').toLowerCase();
                const subjectB = (b.Subject || '').toLowerCase();
                return subjectA.localeCompare(subjectB);
            });

            let contentHTML = `<div style="display: flex; gap: 1.5rem;">`;
            contentHTML += `<div style="flex: 0 0 30%; background: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
            <h3 class="text-lg font-bold mb-3">Courses</h3>
            <div class="space-y-2">`;

            const sortedCourses = [...semesterData.courses].sort((a, b) => (a.Code || '').localeCompare(b.Code || ''));
            sortedCourses.forEach(course => {
                const isActive = course.Code === selectedCourseForSubjects;
                contentHTML += `<div class="course-list-item ${isActive ? 'active' : ''}" data-course-code="${course.Code}">
                <div class="font-bold">${course.Code}</div>
                <div class="text-sm text-gray-600">${course.Name}</div>
                </div>`;
            });

            contentHTML += `</div></div>`;
            contentHTML += `<div style="flex: 1;">`;
            contentHTML += `<div class="management-table-wrapper"><table class="management-table"><thead><tr><th>Subject</th><th>Color</th><th>Units</th><th>Compulsory</th><th>Delivery</th><th>Actions</th></tr></thead><tbody>`;

            sortedSubjects.forEach((item) => {
                const compulsoryBadge = item.Compulsory ? '<span class="bg-yellow-300 text-black px-2 py-1 rounded font-bold text-xs">Yes</span>' : '<span class="bg-gray-300 text-black px-2 py-1 rounded text-xs">No</span>';
                const deliveryMode = item.DeliveryMode || 'Face-to-Face';
                const deliveryBadge = deliveryMode === 'Online' ? '<span class="bg-blue-500 text-white px-2 py-1 rounded font-bold text-xs">Online</span>' : (deliveryMode === 'Blended' ? '<span class="bg-blue-400 text-white px-2 py-1 rounded font-bold text-xs">Blended</span>' : '<span class="bg-gray-300 text-black px-2 py-1 rounded text-xs">F2F</span>');
                const originalIndex = data.indexOf(item);
                contentHTML += `<tr><td><span class="color-circle" style="background-color: ${item.Color};"></span>${item.Subject}</td><td>${item.Color}</td><td>${Array.isArray(item.Units) ? item.Units.join(', ') : (item.Units || '')}</td><td>${compulsoryBadge}</td><td>${deliveryBadge}</td><td><div class="action-buttons"><button class="action-btn edit-btn" onclick="window.handleManagementEdit('subjects', ${originalIndex})"><i class="fa-solid fa-pen-to-square"></i> Edit</button><button class="action-btn delete-btn" onclick="window.handleManagementDelete('subjects', ${originalIndex})"><i class="fa-solid fa-trash"></i> Delete</button></div></td></tr>`;
            });

            contentHTML += `</tbody></table></div>`;

            const formHTML = `<div class="management-form-section">
            <h3>Add / Edit Subject for ${selectedCourseForSubjects}</h3>
            <form id="addForm" class="space-y-4">
            <div class="form-grid">
            <div class="form-group"><label>Subject</label><input type="text" name="Subject" required></div>
            <div class="form-group"><label>Color</label><input type="color" name="Color" required></div>
            <div class="form-group"><label>Units</label><input type="text" name="Units" placeholder="Unit1, Unit2" required></div>
            <div class="form-group"><label><input type="checkbox" name="Compulsory"> Mark as Compulsory</label></div>
            <div class="form-group"><label>Delivery Mode</label><select name="DeliveryMode" required><option value="Face-to-Face">Face-to-Face</option><option value="Online">Online</option><option value="Blended">Blended</option></select></div>
            </div>
            <input type="hidden" name="editIndex">
            <input type="hidden" name="CourseCode" value="${selectedCourseForSubjects}">
            <div class="form-actions">
            <button type="submit" class="form-btn form-btn-submit">Add Subject</button>
            <button type="button" id="cancelEditBtn" class="form-btn form-btn-cancel" style="display: none;">Cancel Edit</button>
            </div>
            </form>
            </div>`;

            contentHTML += formHTML;
            contentHTML += `</div></div>`;

            document.getElementById('modalContent').innerHTML = contentHTML;
            managementModal.classList.add('active');

            const form = document.getElementById('addForm');
            const cancelBtn = document.getElementById('cancelEditBtn');

            cancelBtn.addEventListener('click', () => {
                form.reset();
                form.querySelector('[name="editIndex"]').value = '';
                form.querySelector('[name="CourseCode"]').value = selectedCourseForSubjects;
                form.querySelector('button[type="submit"]').textContent = 'Add Subject';
                cancelBtn.style.display = 'none';
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const editIndex = formData.get('editIndex');

                const subjectData = {
                    Subject: formData.get('Subject'),
                    CourseCode: selectedCourseForSubjects,
                    Color: formData.get('Color'),
                    Units: formData.get('Units') ? formData.get('Units').split(',').map(u => u.trim()).filter(Boolean) : [],
                    Compulsory: formData.has('Compulsory') && formData.get('Compulsory') === 'on',
                    DeliveryMode: formData.get('DeliveryMode') || 'Face-to-Face'
                };

                if (editIndex) {
                    data[parseInt(editIndex, 10)] = subjectData;
                } else {
                    data.push(subjectData);
                }
                openManagementModal('Subjects', data, fields);
                processAndRenderAll();
            });

            document.querySelectorAll('.course-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    selectedCourseForSubjects = e.currentTarget.dataset.courseCode;
                    renderSubjectsModal();
                });
            });
        };

        renderSubjectsModal();
        return;
    }

    let displayData = data;
    if (title === 'Teachers') {
        addItemBtn.style.display = 'flex';
        addItemBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Teacher';
        addItemBtn.onclick = () => {
            document.getElementById('addTeacherModal').classList.add('active');
            document.getElementById('addTeacherForm').reset();
            document.querySelector('#addTeacherForm input[name="editIndex"]').value = '';
            document.querySelector('#addTeacherForm input[name="Initials"]').value = '';
            document.getElementById('isHeadTeacher').checked = false;
            // Populate Dynamic Colleges for New Teacher
            const homeCollegeSelect = document.querySelector('#addTeacherForm select[name="HomeCollege"]');
            homeCollegeSelect.innerHTML = getCurrentColleges().map(c => `<option value="${c}">${c}</option>`).join('');
        };

        displayData = [...data].sort((a, b) => {
            const surnameA = (a.Surname || '').toLowerCase();
            const surnameB = (b.Surname || '').toLowerCase();
            if (surnameA < surnameB) return -1;
            if (surnameA > surnameB) return 1;
            const nameA = (a.Name || '').toLowerCase();
            const nameB = (b.Name || '').toLowerCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
        });
    } else if (title === 'Courses') {
        addItemBtn.style.display = 'flex';
        addItemBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Course';
        addItemBtn.onclick = () => {
            const form = document.getElementById('addForm');
            if (form) {
                form.reset();
                form.querySelector('[name="editIndex"]').value = '';
                form.querySelector('button[type="submit"]').textContent = 'Add Course';
                const cancelBtn = document.getElementById('cancelEditBtn');
                if (cancelBtn) cancelBtn.style.display = 'none';
            }
        };
        displayData = [...data].sort((a, b) => (a.Code || '').localeCompare(b.Code || ''));
    }

    let contentHTML = `<div class="management-table-wrapper"><table class="management-table"><thead><tr>`;
    contentHTML += fields.map(f => `<th>${f}</th>`).join('') + `<th>Actions</th></tr></thead><tbody>`;
    displayData.forEach((item, index) => {
        const originalIndex = data.indexOf(item);
        const type = title.toLowerCase();
        contentHTML += `<tr>${fields.map(f => `<td>${Array.isArray(item[f]) ? item[f].join(', ') : (item[f] || '')}</td>`).join('')}<td><div class="action-buttons"><button class="action-btn edit-btn" onclick="window.handleManagementEdit('${type}', ${originalIndex})"><i class="fa-solid fa-pen-to-square"></i> Edit</button><button class="action-btn delete-btn" onclick="window.handleManagementDelete('${type}', ${originalIndex})"><i class="fa-solid fa-trash"></i> Delete</button></div></td></tr>`;
    });
    contentHTML += `</tbody></table></div>`;

    let formHTML = '';
    if (title !== 'Teachers') {
        formHTML = `<div class="management-form-section">
        <h3>Add / Edit ${title.slice(0, -1)}</h3>
        <form id="addForm" class="space-y-4">
        <div class="form-grid">
        ${fields.map(f => `<div class="form-group"><label>${f}</label><input type="${f.toLowerCase().includes('color') ? 'color' : 'text'}" name="${f}" placeholder="${f === 'Units' ? 'Unit1, Unit2' : ''}" required></div>`).join('')}
        </div>
        <input type="hidden" name="editIndex">
        <div class="form-actions">
        <button type="submit" class="form-btn form-btn-submit">Add ${title.slice(0, -1)}</button>
        <button type="button" id="cancelEditBtn" class="form-btn form-btn-cancel" style="display: none;">Cancel Edit</button>
        </div>
        </form>
        </div>`;
    }

    document.getElementById('modalContent').innerHTML = contentHTML + formHTML;
    managementModal.classList.add('active');

    const form = document.getElementById('addForm');
    const cancelBtn = document.getElementById('cancelEditBtn');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            form.reset();
            form.querySelector('[name="editIndex"]').value = '';
            form.querySelector('button[type="submit"]').textContent = `Add ${title.slice(0, -1)}`;
            cancelBtn.style.display = 'none';
            if (title === 'Teachers') {
                const initialsInput = form.querySelector('input[name="Initials"]');
                initialsInput.value = '';
            }
        });
    }

    if (title === 'Teachers') {
        const nameInput = form.querySelector('input[name="Name"]');
        const surnameInput = form.querySelector('input[name="Surname"]');
        const initialsInput = form.querySelector('input[name="Initials"]');
        const updateInitials = () => {
            const firstInitial = nameInput.value.trim()[0]?.toUpperCase() || '';
            const secondInitial = surnameInput.value.trim()[0]?.toUpperCase() || '';
            initialsInput.value = `${firstInitial}${secondInitial}`;
        };
        nameInput.addEventListener('input', updateInitials);
        surnameInput.addEventListener('input', updateInitials);
    }

    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editIndex = formData.get('editIndex');
            const semesterData = getCurrentSemesterData();

            if (title === 'Teachers') {
                // Handled by addTeacherForm listener
            } else {
                const newItem = {};
                fields.forEach(f => {
                    const value = formData.get(f)
                    newItem[f] = f === 'Units' ? (value ? value.split(',').map(u => u.trim()).filter(Boolean) : []) : value
                });
                if (editIndex) {
                    data[parseInt(editIndex, 10)] = newItem;
                } else {
                    data.push(newItem);
                }
            }
            openManagementModal(title, data, fields);
            processAndRenderAll();
        });
    }
}

const renderers = { 'main-timetable': renderMainTimetableView, 'staff-summary': renderStaffSummaryView, 'dispute-log': renderDisputeLogView, 'course-print': renderCoursePrintView, 'teacher-print': renderTeacherPrintView, 'tasks': renderTasksView };
function handleViewChange(viewName) {
const selectedView = viewName || window.currentView || 'main-timetable';
document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
document.getElementById(`${selectedView}-view`).classList.add('active');
populateSelectors(selectedView);
renderers[selectedView]?.();
}

function populateSelectors(selectedView) {
const semesterData = getCurrentSemesterData();
secondarySelectorsContainer.innerHTML = '';
if (selectedView === 'course-print') {
if (semesterData.courses.length > 0) {
const sortedCourses = [...semesterData.courses].sort((a, b) => (a.Code || '').localeCompare(b.Code || ''));
let selector = `<div class="dropdown-menu"><button class="dropdown-btn" id="courseDropdownBtn"><i class="fa-solid fa-book mr-2"></i> Course <i class="fa-solid fa-caret-down ml-1"></i></button><div class="dropdown-content" id="courseDropdown">${sortedCourses.map(c => `<div class="dropdown-item" onclick="selectCourse('${c.Code}')">${c.Code} - ${c.Name}</div>`).join('')}</div></div>`;
secondarySelectorsContainer.innerHTML = selector;
document.getElementById('courseDropdownBtn').addEventListener('click', (e) => {
e.stopPropagation();
semesterDropdown.classList.remove('show');
viewDropdown.classList.remove('show');
document.getElementById('teacherDropdown')?.classList.remove('show');
document.getElementById('courseDropdown').classList.toggle('show');
});
}
} else if (selectedView === 'teacher-print') {
if (semesterData.teachers.length > 0) {
const sortedTeachers = [...semesterData.teachers].sort((a, b) => {
const surnameA = (a.Surname || '').toLowerCase();
const surnameB = (b.Surname || '').toLowerCase();
if (surnameA !== surnameB) return surnameA.localeCompare(surnameB);
const nameA = (a.Name || '').toLowerCase();
const nameB = (b.Name || '').toLowerCase();
return nameA.localeCompare(nameB);
});
let selector = `<div class="dropdown-menu"><button class="dropdown-btn" id="teacherDropdownBtn"><i class="fa-solid fa-chalkboard-user mr-2"></i> Teacher <i class="fa-solid fa-caret-down ml-1"></i></button><div class="dropdown-content" id="teacherDropdown">${sortedTeachers.map(t => `<div class="dropdown-item" onclick="selectTeacher('${t.Initials}')">${t.Name} ${t.Surname}</div>`).join('')}</div></div>`;
secondarySelectorsContainer.innerHTML = selector;
document.getElementById('teacherDropdownBtn').addEventListener('click', (e) => {
e.stopPropagation();
semesterDropdown.classList.remove('show');
viewDropdown.classList.remove('show');
document.getElementById('courseDropdown')?.classList.remove('show');
document.getElementById('teacherDropdown').classList.toggle('show');
});
}
}
}
  
window.selectCourse = (courseCode) => {
window.appState.selectedCourse = courseCode;
renderCoursePrintView(courseCode);
document.getElementById('courseDropdown').classList.remove('show');
};

window.selectTeacher = (teacherInitials) => {
window.appState.selectedTeacher = teacherInitials;
renderTeacherPrintView(teacherInitials);
document.getElementById('teacherDropdown').classList.remove('show');
};

function arrangeOverlappingSessions(dayCol, sessions) {
const groups = [];
sessions.forEach(session => {
let addedToGroup = false;
for (let group of groups) {
const overlaps = group.some(s => {
const s1Start = timeToMinutes(session.ClassStart);
const s1End = timeToMinutes(session.ClassEnd);
const s2Start = timeToMinutes(s.ClassStart);
const s2End = timeToMinutes(s.ClassEnd);
return s1Start < s2End && s2Start < s1End;
});
if (overlaps) {
group.push(session);
addedToGroup = true;
break;
}
}
if (!addedToGroup) {
groups.push([session]);
}
});

groups.forEach(group => {
const count = group.length;
if (count > 1) {
group.forEach((session, index) => {
const block = dayCol.querySelector(`[data-session-id="${session.id}"]`);
if (block) {
const widthPercent = (100 / count);
const leftPercent = (100 / count) * index;
block.style.left = `${leftPercent}%`;
block.style.right = `${100 - leftPercent - widthPercent}%`;
block.style.width = 'auto';
}
});
}
});
}

function renderMainTimetableView() {
const grid = document.getElementById('main-timetable-grid');
const titleEl = document.getElementById('main-timetable-title');
const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
const semesterData = getCurrentSemesterData();
const config = semesterData.config || { startHour: 8, endHour: 18 };
const startTime = config.startHour;
const endTime = config.endHour;
const slotHeight = 30;
const totalRows = (endTime - startTime) * 2; // 30 min slots

titleEl.textContent = `${semesterData.currentCollege} Timetable - ${db.currentSemester}`;

let gridHTML = `<div style="grid-row: 1; grid-column: 1;"></div>` + days.map((day, i) => `<div class="timetable-header" style="grid-column: ${i + 2};">${day}</div>`).join('');
gridHTML += `<div class="time-labels">${Array.from({length: totalRows}, (_, i) => `<div class="time-label">${(i % 2 === 0) ? `<strong>${startTime + i/2}:00</strong>` : ''}</div>`).join('')}</div>`;
gridHTML += days.map((day, i) => {
let dayColHTML = `<div class="day-column" data-day="${day}" style="grid-column: ${i + 2}; height: ${totalRows * slotHeight}px">`;
for (let j = 0; j < totalRows; j++) {
const time = startTime + j * 0.5;
const timeString = `${Math.floor(time).toString().padStart(2, '0')}:${((time % 1) * 60).toString().padStart(2, '0')}`;
dayColHTML += `<div class="time-slot" data-day="${day}" data-time="${timeString}" data-slot-index="${j}"></div>`;
}
return dayColHTML + `</div>`;
}).join('');
grid.innerHTML = gridHTML;

const scheduleToRender = semesterData.currentCollege === 'Master View' 
? semesterData.schedule 
: semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));

const sessionsByDay = {};
days.forEach(day => sessionsByDay[day] = []);

scheduleToRender.forEach(session => {
const dayCol = grid.querySelector(`.day-column[data-day="${session.Day}"]`);
if (!dayCol) return;

sessionsByDay[session.Day].push(session);

const start = timeToMinutes(session.ClassStart) / 30 - startTime * 2;
const height = (timeToMinutes(session.ClassEnd) - timeToMinutes(session.ClassStart)) / 30 * slotHeight;
const subjectInfo = semesterData.subjects.find(s => s.Subject === session.Subject);
const teacher1Info = semesterData.teachers.find(t => t.Initials === session.TeacherInitials);
const teacher2Info = session.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === session.TeacherInitials2) : null;
const teacherDisplay = session.TeacherInitials 
? (teacher2Info 
? `${teacher1Info?.Name || session.TeacherInitials} & ${teacher2Info.Name}` 
: (teacher1Info ? `${teacher1Info.Name} ${teacher1Info.Surname}` : session.TeacherInitials))
: '<span class="unassigned-badge">UNASSIGNED</span>';
const notesHTML = session.notes ? `<div class="text-xs italic text-gray-600 truncate" title="${session.notes}">${session.notes}</div>` : '';
const collegeInfo = semesterData.currentCollege === 'Master View' ? `<div class="font-bold text-indigo-600 text-xs">${session.colleges?.join(', ') || ''}</div>` : '';
const unitsHTML = subjectInfo?.Units?.length > 0 ? `<div class="session-units">Units: ${subjectInfo.Units.join(', ')}</div>` : '';
const compulsoryBadge = subjectInfo?.Compulsory ? `<div class="font-bold text-red-600 text-xs">COMPULSORY</div>` : '';
const deliveryMode = subjectInfo?.DeliveryMode || 'Face-to-Face';
const deliveryClass = deliveryMode === 'Online' ? 'online' : (deliveryMode === 'Blended' ? 'blended' : '');

const sessionBlock = document.createElement('div');
sessionBlock.className = `session-block ${session.dispute ? 'dispute-warning' : ''} ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${deliveryClass}`;
sessionBlock.setAttribute('data-session-id', session.id);
Object.assign(sessionBlock.style, { top: `${start * slotHeight}px`, height: `${height}px`, backgroundColor: subjectInfo?.Color || '#e5e7eb', left: '2px', right: '2px' });
sessionBlock.innerHTML = `${collegeInfo}<div class="font-bold">${session.CourseCode} - ${session.Subject}</div>${compulsoryBadge}${unitsHTML}<div>${teacherDisplay} | Room ${session.Room}</div>${notesHTML}<div class="text-xs">${session.ClassStart} - ${session.ClassEnd}</div><div class="resize-handle"></div>`;
sessionBlock.addEventListener('dblclick', () => openSessionModal(session));
sessionBlock.addEventListener('contextmenu', (e) => showContextMenu(e, session));
dayCol.appendChild(sessionBlock);
makeDraggable(sessionBlock, session, grid);
makeResizable(sessionBlock, session);
});

days.forEach(day => {
const dayCol = grid.querySelector(`.day-column[data-day="${day}"]`);
if (dayCol && sessionsByDay[day].length > 0) {
arrangeOverlappingSessions(dayCol, sessionsByDay[day]);
}
});

addSlotSelectionListeners();
}

function openSessionModal(session, day = null, startTime = null, endTime = null) {
sessionForm.reset();
const semesterData = getCurrentSemesterData();
document.getElementById('sessionModalTitle').textContent = session ? 'Edit Session' : 'Add New Session';
document.getElementById('sessionId').value = session?.id || '';
document.getElementById('sessionDay').value = session?.Day || day;
document.getElementById('sessionStartTime').value = session?.ClassStart || startTime;
document.getElementById('sessionEndTime').value = session?.ClassEnd || endTime || '';
document.getElementById('sessionRoom').value = session?.Room || '';
document.getElementById('sessionNotes').value = session?.notes || '';
document.getElementById('deleteSessionBtn').style.display = session ? 'block' : 'none';

const courseSelect = document.getElementById('sessionCourse');
const subjectSelect = document.getElementById('sessionSubject');
const teacherSelect = document.getElementById('sessionTeacher');
const teacher2Select = document.getElementById('sessionTeacher2');

courseSelect.innerHTML = semesterData.courses.map(c => `<option value="${c.Code}" ${session?.CourseCode === c.Code ? 'selected' : ''}>${c.Name}</option>`).join('');

const updateSubjects = () => {
const selectedCourseCode = courseSelect.value;
const filteredSubjects = semesterData.subjects.filter(s => s.CourseCode === selectedCourseCode);
subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + filteredSubjects.map(s => `<option value="${s.Subject}" ${session?.Subject === s.Subject ? 'selected' : ''}>${s.Subject}</option>`).join('');
};

updateSubjects();
courseSelect.addEventListener('change', updateSubjects);

const sortedTeachers = [...semesterData.teachers].sort((a, b) => {
const surnameA = (a.Surname || '').toLowerCase();
const surnameB = (b.Surname || '').toLowerCase();
if (surnameA < surnameB) return -1;
if (surnameA > surnameB) return 1;

const nameA = (a.Name || '').toLowerCase();
const nameB = (b.Name || '').toLowerCase();
if (nameA < nameB) return -1;
if (nameA > nameB) return 1;
return 0;
});

teacherSelect.innerHTML = '<option value="">-- Unassigned --</option>' + sortedTeachers.map(t => `<option value="${t.Initials}" ${session?.TeacherInitials === t.Initials ? 'selected' : ''}>${t.Name} ${t.Surname}</option>`).join('');
teacher2Select.innerHTML = `<option value="">-- None --</option>` + sortedTeachers.map(t => `<option value="${t.Initials}" ${session?.TeacherInitials2 === t.Initials ? 'selected' : ''}>${t.Name} ${t.Surname}</option>`).join('');

// Populate Dynamic Colleges
const collegeCheckboxesContainer = document.getElementById('sessionModalCollegeCheckboxes');
let checkboxesHTML = '';
const currentColleges = getCurrentColleges();
currentColleges.forEach(col => {
    const isChecked = session?.colleges?.includes(col) ? 'checked' : (col === semesterData.currentCollege ? 'checked' : '');
    checkboxesHTML += `<label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="${col}" class="w-4 h-4" ${isChecked}> ${col}</label>`;
});
collegeCheckboxesContainer.className = "flex gap-4 flex-wrap";
collegeCheckboxesContainer.innerHTML = checkboxesHTML;

document.getElementById('sessionModal').classList.add('active');
}

// Rest of functions: handleSessionFormSubmit, etc needs updates?
// handleSessionFormSubmit reads name="colleges" which is dynamic so it just works.

function renderCoursePrintView(courseCode) {
    const container = document.getElementById('course-print-view');
    const semesterData = getCurrentSemesterData();

    if (!courseCode && window.appState.selectedCourse) {
        const exists = semesterData.courses.some(c => c.Code === window.appState.selectedCourse);
        if (exists) courseCode = window.appState.selectedCourse;
    }

    if (!courseCode && semesterData.courses.length > 0) {
        courseCode = semesterData.courses[0].Code;
    }

    if (!courseCode) {
        container.innerHTML = `<div class="p-6 bg-white rounded shadow text-center text-gray-500 font-semibold">Please add courses in the Data Hub to use this view.</div>`;
        return;
    }

    window.appState.selectedCourse = courseCode;

    const courseInfo = semesterData.courses.find(c => c.Code === courseCode);
    const scheduleToFilter = semesterData.currentCollege === 'Master View'
        ? semesterData.schedule
        : semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));

    let sessions = scheduleToFilter.filter(s => s.CourseCode === courseCode);
    sessions = sortSessionsChronologically(sessions);

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const startTimes = new Set();
    sessions.forEach(s => startTimes.add(s.ClassStart));
    const sortedStartTimes = Array.from(startTimes).sort((a, b) => timeToMinutes(a) - timeToMinutes(b));

    let gridHTML = `<table class="pdf-print-grid">
    <thead><tr><th class="pdf-print-grid">Time</th>${days.map(d => `<th class="pdf-day-header">${d}</th>`).join('')}</tr></thead>
    <tbody>`;

    sortedStartTimes.forEach(startTime => {
        let lateEndTime = startTime;
        sessions.filter(s => s.ClassStart === startTime).forEach(s => {
             if (timeToMinutes(s.ClassEnd) > timeToMinutes(lateEndTime)) lateEndTime = s.ClassEnd;
        });
        const rowLabel = `${startTime} - ${lateEndTime}`;
        gridHTML += `<tr><td class="pdf-period-label">${rowLabel}</td>`;
        days.forEach(day => {
            const daySessions = sessions.filter(s => s.ClassStart === startTime && s.Day === day);
            if (daySessions.length === 0) {
                gridHTML += `<td class="pdf-cell" style="background-color: #f9f9f9;"></td>`;
            } else {
                const sessionsHTML = daySessions.map(s => {
                    const subjectInfo = semesterData.subjects.find(sub => sub.Subject === s.Subject);
                    const teacher1Info = semesterData.teachers.find(t => t.Initials === s.TeacherInitials);
                    const teacher2Info = s.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === s.TeacherInitials2) : null;
                    const teacherDisplay = s.TeacherInitials ? (teacher2Info ? `${teacher1Info?.Name || s.TeacherInitials} & ${teacher2Info.Name}` : (teacher1Info ? `${teacher1Info.Name} ${teacher1Info.Surname}` : s.TeacherInitials)) : 'UNASSIGNED';
                    const hours = (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60;
                    const collegeHTML = semesterData.currentCollege === 'Master View' ? `<div style="font-weight: bold; font-size: 11px; color: #4338ca; margin-bottom: 3px;">${s.colleges?.join(', ') || ''}</div>` : '';
                    const notesHTML = s.notes ? `<div style="font-style: italic; font-size: 11px; margin-top: 3px;">${s.notes}</div>` : '';
                    return `<div class="pdf-session ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${(subjectInfo?.DeliveryMode === 'Online' ? 'online' : (subjectInfo?.DeliveryMode === 'Blended' ? 'blended' : ''))}" style="background-color:${subjectInfo?.Color || '#eee'}">${collegeHTML}<div style="font-weight: bold; margin-bottom: 3px; font-size: 12px;">${s.CourseCode} | ${s.Subject}</div>${subjectInfo?.Compulsory ? '<div style="font-weight: bold; font-size: 10px; color: #d32f2f; margin-top: 2px;">COMPULSORY</div>' : ''}<div style="margin-top: 3px; font-size: 11px;">${teacherDisplay} | ${hours.toFixed(2)} Hrs | Room ${s.Room}</div>${notesHTML}<div style="margin-top: 3px; font-size: 11px;">${s.ClassStart} - ${s.ClassEnd}</div></div>`;
                }).join('');
                gridHTML += `<td class="pdf-cell">${sessionsHTML}</td>`;
            }
        });
        gridHTML += `</tr>`;
    });
    gridHTML += `</tbody></table>`;

    const totalHours = sessions.reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);
    if (!semesterData.courseNotes) semesterData.courseNotes = {};
    const courseNotes = semesterData.courseNotes[courseCode] || '';

    const uniqueTeacherInitials = new Set();
    sessions.forEach(s => { if (s.TeacherInitials) uniqueTeacherInitials.add(s.TeacherInitials); if (s.TeacherInitials2) uniqueTeacherInitials.add(s.TeacherInitials2); });
    const courseTeachers = Array.from(uniqueTeacherInitials).map(i => semesterData.teachers.find(t => t.Initials === i)).filter(t => t).sort((a, b) => a.Name.localeCompare(b.Name));

    // NEW: Filter ALL Head Teachers for this Semester (to display at bottom)
    const headTeachers = semesterData.teachers.filter(t => t.isHeadTeacher).sort((a, b) => a.Name.localeCompare(b.Name));

    let teacherContactHTML = '';
    if (courseTeachers.length > 0 || headTeachers.length > 0) {
        teacherContactHTML = `<div class="pdf-teacher-info"><h4>Teacher Contact:</h4><div class="pdf-teacher-info-content">`;
        
        // Regular Teachers
        if (courseTeachers.length > 0) {
            courseTeachers.forEach(t => {
                teacherContactHTML += `<div class="pdf-teacher-info-item"><span>${t.Name} ${t.Surname}:</span>${t.Email ? `<a href="mailto:${t.Email}">${t.Email}</a>` : ''}</div>`;
            });
        }

        // Head Teachers Section
        if (headTeachers.length > 0) {
            teacherContactHTML += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ccc;"><strong>Head Teachers:</strong></div>`;
            headTeachers.forEach(ht => {
                // Only show HT if not already listed above as a regular teacher for this course
                if (!courseTeachers.find(t => t.Initials === ht.Initials)) {
                     teacherContactHTML += `<div class="pdf-teacher-info-item"><span>${ht.Name} ${ht.Surname}:</span>${ht.Email ? `<a href="mailto:${ht.Email}">${ht.Email}</a>` : ''}</div>`;
                }
            });
        }
        teacherContactHTML += `</div></div>`;
    }

    // Legend logic remains same...
    const hasCompulsory = sessions.some(s => semesterData.subjects.find(sub => sub.Subject === s.Subject)?.Compulsory);
    const hasOnline = sessions.some(s => (semesterData.subjects.find(sub => sub.Subject === s.Subject)?.DeliveryMode === 'Online'));
    const hasBlended = sessions.some(s => (semesterData.subjects.find(sub => sub.Subject === s.Subject)?.DeliveryMode === 'Blended'));
    let legendHTML = '';
    if (hasCompulsory || hasOnline || hasBlended) {
    legendHTML = `<div class="pdf-legend-section"><h4>Legend:</h4>${hasCompulsory ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #ffff00; border: 2px solid #ffd700;"></div><span>Compulsory</span></div>' : ''}${hasOnline ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #3b82f6;"></div><span>Online</span></div>' : ''}${hasBlended ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #3b82f6;"></div><span>Blended</span></div>' : ''}</div>`;
    }

    const bottomSections = `<div class="pdf-bottom-section">${teacherContactHTML}<div class="pdf-notes-section"><h4>Course Notes:</h4><div class="pdf-notes-content">${courseNotes || '(No notes added)'}</div></div>${legendHTML}</div>`;
    container.innerHTML = `<div class="pdf-container"><div class="pdf-title"><h2>${courseInfo.Name} (${courseCode})</h2><h3>TAFE NSW Timetable (${db.currentSemester})</h3></div>${gridHTML}<div class="pdf-total-hours">Total Hours: <span class="pdf-total-hours-value">${totalHours.toFixed(2)}</span></div>${bottomSections}</div>`;
    
    // Re-attach listeners
    const noteBox = container.querySelector('.pdf-notes-content');
    if (noteBox) { noteBox.contentEditable = true; noteBox.addEventListener('blur', (e) => { semesterData.courseNotes[courseCode] = e.target.textContent; saveData(); }); }
}

loadData();
processAndRenderAll();
});
</script>
</body>
</html>
