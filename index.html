<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="TAFE Interactive Timetabling Application" property="og:title"/>
<meta content="A multi-college, interactive timetabling solution for TAFE NSW with data persistence and class notes." property="og:description"/>
<meta content="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762158838/u1103083349_img_120x40_8aa3ecf2_m66f6i.png" property="og:image"/>
<meta content="website" property="og:type"/>
<link href="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762158838/u1103083350_img_64x64_ad306614_xji6gn.png" rel="icon"/>
<title>TAFE Interactive Timetabling Application</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
.sidebar { transition: transform 0.3s ease-in-out; }
.sidebar-open { transform: translateX(0) !important; }
.view-container { display: none; }
.view-container.active { display: block; }
.college-tab { padding: 8px 16px; border: 1px solid transparent; border-bottom: none; background: #f3f4f6; color: #4b5563; cursor: pointer; border-radius: 6px 6px 0 0; }
.college-tab.active { background: white; border-color: #d1d5db; border-bottom-color: white; font-weight: bold; color: #1e3a8a; }
.timetable-main-grid { display: grid; grid-template-columns: 50px repeat(5, minmax(200px, 1fr)); grid-template-rows: auto 1fr; border: 1px solid #d1d5db; }
.timetable-header { background-color: #007bff; color: white; font-weight: bold; padding: 0.75rem 0.5rem; text-align: center; border-left: 1px solid #d1d5db; grid-row: 1; word-wrap: break-word; }
.time-labels { grid-row: 2; grid-column: 1; display: flex; flex-direction: column; }
.time-label { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6b7280; border-top: 1px solid #e5e7eb; box-sizing: border-box; }
.day-column { grid-row: 2; position: relative; border-left: 1px solid #d1d5db; }
.time-slot { height: 30px; border-top: 1px solid #e5e7eb; box-sizing: border-box; cursor: pointer; }
.time-slot:hover { background-color: rgba(229, 231, 235, 0.5); }
.dragging .time-slot:hover { background-color: transparent !important; }
.dragging .time-slot { cursor: default !important; }
.time-slot.slot-selected { background-color: rgba(59, 130, 246, 0.3); }
.session-block { position: absolute; border-radius: 4px; padding: 6px; font-size: 14px; line-height: 1.3; overflow: hidden; border: 1px solid rgba(0,0,0,0.4); z-index: 10; cursor: grab; }
.session-block.compulsory { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700; }
.session-block.online { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.blended { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.compulsory.online { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.session-block.compulsory.blended { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.dispute-warning { border: 3px solid #ef4444 !important; z-index: 15; animation: pulse-border 1.5s infinite; }
.dispute-warning::after { content: '‚ö†Ô∏è DISPUTED'; position: absolute; top: 2px; right: 4px; font-weight: bold; color: #ef4444; font-size: 10px; background: white; padding: 0 2px; border-radius: 3px;}
@keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
.resize-handle { position: absolute; bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; z-index: 20; }
.context-menu { position: fixed; background: #2d3748; color: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-width: 200px; display: none; }
.context-menu.active { display: block; }
.context-menu-item { padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #4a5568; }
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:hover { background: #4a5568; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: none; }
.modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; z-index: 101; }
.modal-overlay.active { display: block; }
.print-grid { display: grid; grid-template-columns: 80px repeat(5, 1fr); border: 2px solid #000; }
.print-header { font-weight: bold; text-align: center; padding: 8px 4px; border: 1px solid #999; background: #d9d9d9; font-size: 16px; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; }
.print-day-header { background: #595959; color: white; }
.print-period-label { display: flex; align-items: center; justify-content: center; text-align: center; font-weight: bold; background: #fde9d9; border: 1px solid #999; font-size: 13px; min-height: 160px; }
.print-cell { border: 1px solid #999; padding: 6px; vertical-align: top; min-height: 160px; }
.print-session { border-radius: 4px; padding: 8px; font-size: 13px; margin-bottom: 6px; border: 1px solid black; line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; }
.print-session.compulsory { border: 4px solid #ffff00; box-shadow: 0 0 0 1px #ffd700; }
.print-session.online { border: 3px solid #3b82f6; }
.print-session.blended { border: 3px solid #3b82f6; }
.print-session.compulsory.online { border: 4px solid #ffff00; box-shadow: 0 0 0 1px #ffd700, 0 0 0 4px #3b82f6; }
.print-session.compulsory.blended { border: 4px solid #ffff00; box-shadow: 0 0 0 1px #ffd700, 0 0 0 4px #3b82f6; }
.session-units { font-size: 11px; color: #555; margin-top: 2px; font-style: italic; }
.color-circle { display: inline-block; width: 22px; height: 22px; border-radius: 50%; border: 1px solid #999; margin-right: 8px; vertical-align: middle; }
.bottom-sections-container { display: flex; gap: 1.5rem; margin-top: 1.5rem; flex-wrap: wrap; }
.teacher-contact-info { flex: 1 1 300px; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #f3f4f6; }
.teacher-contact-info h4 { font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; font-size: 1rem; }
.teacher-contact-info p { margin: 0.25rem 0; font-size: 0.95rem; color: #374151; }
.notes-section { flex: 1 1 400px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; display: flex; flex-direction: column; }
.notes-section label { display: block; font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; font-size: 1rem; }
.notes-section textarea { flex: 1; width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.875rem; resize: vertical; min-height: 120px; }
.notes-display { white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #ffffff; font-size: 0.875rem; line-height: 1.6; min-height: 120px; }
.legend-section { flex: 1 1 200px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; }
.legend-section h4 { font-weight: bold; margin-bottom: 0.75rem; color: #1f2937; font-size: 1rem; }
.legend-item { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.95rem; color: #374151; }
.legend-circle { display: inline-block; width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0; }
.course-list-item { padding: 12px; margin-bottom: 8px; background: #f3f4f6; border: 2px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.course-list-item:hover { background: #e5e7eb; }
.course-list-item.active { background: #dbeafe; border-color: #3b82f6; font-weight: bold; }
.staff-notes-input { max-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
.task-card { padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; background: white; }
.task-card.high { border-left: 4px solid #dc2626; background: #fee2e2; }
.task-card.medium { border-left: 4px solid #f59e0b; background: #fef3c7; }
.task-card.low { border-left: 4px solid #10b981; background: #ecfdf5; }
.task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
.task-title { font-weight: bold; font-size: 1.1rem; color: #1f2937; }
.task-status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
.task-status-todo { background: #e5e7eb; color: #374151; }
.task-status-inprogress { background: #dbeafe; color: #1e40af; }
.task-status-done { background: #dcfce7; color: #166534; }
.task-status-blocked { background: #fee2e2; color: #991b1b; }
.task-meta { display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; flex-wrap: wrap; }
.task-description { color: #4b5563; margin-bottom: 0.75rem; }
.task-actions { display: flex; gap: 0.5rem; }
.task-actions button { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; border: none; cursor: pointer; }
.task-edit-btn { background: #3b82f6; color: white; }
.task-edit-btn:hover { background: #2563eb; }
.task-delete-btn { background: #ef4444; color: white; }
.task-delete-btn:hover { background: #dc2626; }
.dropdown-menu { position: relative; display: inline-block; }
.dropdown-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.dropdown-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.dropdown-content { position: absolute; background: white; min-width: 250px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 0.375rem; z-index: 1; top: 100%; left: 0; margin-top: 0.5rem; display: none; border: 2px solid #667eea; max-height: 400px; overflow-y: auto; }
.dropdown-content.show { display: block; }
.dropdown-item { color: #1f2937; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: all 0.2s; }
.dropdown-item:last-child { border-bottom: none; }
.dropdown-item:hover { background: #f3f4f6; color: #667eea; font-weight: 500; }
.college-checkboxes { display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
.college-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; }
.college-checkbox-label input { cursor: pointer; width: 18px; height: 18px; }
.unassigned-badge { display: inline-block; background: #fbbf24; color: #78350f; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
.total-hours-section { margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; }
.total-hours-label { font-size: 1.25rem; font-weight: bold; color: #1f2937; display: inline-block; margin-right: 1rem; }
.total-hours-value { font-size: 1.5rem; font-weight: bold; background: #1f2937; color: white; padding: 0.5rem 1.5rem; border-radius: 0.375rem; display: inline-block; }

#pdf-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; overflow: auto; }
#pdf-container.show { display: block; }

@media print { 
  body * { visibility: hidden; } 
  #print-area, #print-area * { visibility: visible; } 
  #print-area { position: absolute; left: 0; top: 0; width: 100%; } 
  .no-print { display: none !important; } 
}
</style>
</head>
<body class="bg-gray-100">
<div class="sidebar fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 -translate-x-full" id="sidebar">
<div class="p-4 bg-blue-900 text-white flex justify-between items-center no-print"><h2 class="text-xl font-bold">Data Hub</h2><button class="text-2xl" id="closeSidebarBtn">√ó</button></div>
<div class="p-4 space-y-3 no-print">
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Management</h3>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSemestersBtn">üóìÔ∏è Manage Semesters</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageTeachersBtn">üë®‚Äçüè´ Manage Teachers</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageCoursesBtn">üìö Manage Courses</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSubjectsBtn">üé® Manage Subjects</button>
<hr class="my-4"/>
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Data Actions</h3>
<button class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" id="exportDataBtn">üíæ Export Data</button>
<button class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" id="importDataBtn">üìÇ Import Data</button>
<button class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" id="loadSampleDataBtn">üîÑ Load Sample Data</button>
<input type="file" id="importFileInput" accept=".json" style="display: none;"/>
</div>
</div>
<div class="transition-all duration-300" id="mainContent">
<header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
<div class="flex items-center gap-4"><img alt="TAFE Logo" src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762673524/ci_1595_1762673524_TAFE_logo_ecudtj.png" style="height: 50px;"/><h1 class="text-2xl font-bold text-blue-900">Interactive Timetabling App</h1></div>
<div class="flex items-center gap-3">
<button class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded" id="openSidebarBtn">Open Menu</button>
<div class="dropdown-menu">
<button class="dropdown-btn" id="semesterDropdownBtn">üìÖ Semester <span>‚ñº</span></button>
<div class="dropdown-content" id="semesterDropdown"></div>
</div>
<div class="dropdown-menu">
<button class="dropdown-btn" id="viewDropdownBtn">üëÅÔ∏è View <span>‚ñº</span></button>
<div class="dropdown-content" id="viewDropdown"></div>
</div>
<div id="secondary-selectors"></div>
<button class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded" id="printBtn">üìÑ Download PDF</button>
</div>
</header>
<main class="p-4">
<div class="flex items-center gap-2 mb-[-1px] no-print" id="college-tabs-container"></div>
<div id="print-area">
<div class="view-container active" id="main-timetable-view"><div class="bg-white p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-center mb-4" id="main-timetable-title"></h2><div class="timetable-grid-container"><div class="timetable-main-grid" id="main-timetable-grid"><div class="text-center p-10 col-span-6 text-gray-500">Load sample data or add your own to begin.</div></div></div></div></div>
<div class="view-container" id="staff-summary-view"><div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto"><h2 class="text-xl font-bold text-center mb-4" id="staff-summary-title"></h2><div id="staff-summary-table"></div></div></div>
<div class="view-container" id="dispute-log-view"></div>
<div class="view-container" id="course-print-view"></div>
<div class="view-container" id="teacher-print-view"></div>
<div class="view-container" id="tasks-view"><div class="bg-white p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-2">üìã Task Management</h2><p class="text-gray-600 mb-4">Semester: <span id="tasksSemesterLabel" class="font-bold text-blue-900"></span></p><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-6" id="addTaskBtn">+ Add New Task</button><div id="tasks-container"></div></div></div>
</div>
</main>
</div>
<div class="context-menu" id="contextMenu"></div>
<div class="modal-overlay" id="managementModal"><div class="modal-container"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="modalTitle">Manage</h2><button class="text-3xl font-bold" id="closeModalBtn">√ó</button></div><div class="space-y-4" id="modalContent"></div></div></div>
<div class="modal-overlay" id="semesterModal"><div class="modal-container" style="max-width: 600px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Manage Semesters</h2><button class="text-3xl font-bold" id="closeSemesterModalBtn">√ó</button></div><div id="semesterModalContent"></div></div></div>
<div class="modal-overlay" id="sessionModal"><div class="modal-container" style="max-width: 500px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="sessionModalTitle">Add/Edit Session</h2><button class="text-3xl font-bold" id="closeSessionModalBtn" type="button">√ó</button></div><form class="space-y-4" id="sessionForm"><input id="sessionId" type="hidden"/><input id="sessionDay" type="hidden"/><div><label class="block font-medium">Course</label><select class="w-full border p-2 rounded" id="sessionCourse" required=""></select></div><div><label class="block font-medium">Subject</label><select class="w-full border p-2 rounded" id="sessionSubject" required=""></select></div><div><label class="block font-medium">Teacher 1 (Primary) <span class="text-gray-500 text-sm">(Optional)</span></label><select class="w-full border p-2 rounded" id="sessionTeacher"></select></div><div><label class="block font-medium">Teacher 2 (Co-teacher - Optional)</label><select class="w-full border p-2 rounded" id="sessionTeacher2"><option value="">-- None --</option></select></div><div><label class="block font-medium">Room</label><input class="w-full border p-2 rounded" id="sessionRoom" required="" type="text"/></div><div><label class="block font-medium mb-2">Colleges (select one or more)</label><div class="flex gap-4"><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Moss Vale" class="w-4 h-4"> Moss Vale</label><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Goulburn" class="w-4 h-4"> Goulburn</label><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Queanbeyan" class="w-4 h-4"> Queanbeyan</label></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Start Time</label><input class="w-full border p-2 rounded" id="sessionStartTime" required="" step="1800" type="time"/></div><div><label class="block font-medium">End Time</label><input class="w-full border p-2 rounded" id="sessionEndTime" required="" step="1800" type="time"/></div></div><div><label class="block font-medium">Notes (e.g., Face-to-Face)</label><textarea class="w-full border p-2 rounded" id="sessionNotes" rows="2"></textarea></div><div class="flex justify-between items-center mt-6"><button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteSessionBtn" type="button">Delete</button><button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" type="submit">Save Session</button></div></form></div></div>
<div class="modal-overlay" id="duplicateDayModal"><div class="modal-container" style="max-width: 400px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Duplicate to Another Day</h2><button class="text-3xl font-bold" id="closeDuplicateDayModalBtn">√ó</button></div><div class="space-y-3" id="duplicateDayContent"></div></div></div>
<div class="modal-overlay" id="taskModal"><div class="modal-container" style="max-width: 600px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="taskModalTitle">Add New Task</h2><button class="text-3xl font-bold" id="closeTaskModalBtn">√ó</button></div><form class="space-y-4" id="taskForm"><input id="taskId" type="hidden"/><div><label class="block font-medium">Task Title</label><input type="text" id="taskTitle" class="w-full border p-2 rounded" required placeholder="Enter task title"/></div><div><label class="block font-medium">Description</label><textarea id="taskDescription" class="w-full border p-2 rounded" rows="3" placeholder="Enter task description (optional)"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Assign to Teacher</label><select id="taskTeacher" class="w-full border p-2 rounded"><option value="">-- None --</option></select></div><div><label class="block font-medium">Assign to Course</label><select id="taskCourse" class="w-full border p-2 rounded"><option value="">-- None --</option></select></div></div><div><label class="block font-medium mb-2">Colleges (select one or more)</label><div class="college-checkboxes" id="taskCollegeCheckboxes"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Priority</label><select id="taskPriority" class="w-full border p-2 rounded" required><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div><div><label class="block font-medium">Status</label><select id="taskStatus" class="w-full border p-2 rounded" required><option value="todo" selected>To Do</option><option value="inprogress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div></div><div><label class="block font-medium">Due Date</label><input type="date" id="taskDueDate" class="w-full border p-2 rounded"/></div><div class="flex justify-between items-center mt-6"><button type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteTaskBtn" style="display: none;">Delete Task</button><div class="flex gap-2"><button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" id="cancelTaskBtn">Cancel</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save Task</button></div></div></form></div></div>
<div class="modal-overlay" id="loadingOverlay" style="display: none; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.9); z-index: 200;">
<div class="text-center p-8 bg-white rounded-lg shadow-xl border-2 border-blue-500">
<div style="width: 60px; height: 60px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
<h2 class="text-2xl font-bold text-blue-900 mb-2">Generating PDF...</h2>
<p class="text-gray-600">Please wait, this may take a moment.</p>
</div>
</div>
<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
<script src="pdf-generator.js"></script>
<script>
let selectedCourseForSubjects = null;
let sidebarOpen = false;

document.addEventListener('DOMContentLoaded', () => {
let db = {};
const colleges = ['Moss Vale', 'Goulburn', 'Queanbeyan'];
const getNewSemesterData = () => ({ courses: [], teachers: [], subjects: [], schedule: [], currentCollege: 'Moss Vale', staffNotes: {}, tasks: [] });

const saveData = () => localStorage.setItem('timetableDataV2', JSON.stringify(db));
const loadData = () => {
const savedData = localStorage.getItem('timetableDataV2');
if (savedData) {
db = JSON.parse(savedData);
Object.keys(db.semesters).forEach(semKey => {
if (db.semesters[semKey].subjects) {
db.semesters[semKey].subjects.forEach(subj => {
if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
});
}
if (!db.semesters[semKey].staffNotes) {
db.semesters[semKey].staffNotes = {};
}
if (!db.semesters[semKey].tasks) {
db.semesters[semKey].tasks = [];
}
});
} else {
db = {
semesters: { 'Semester 1 2024': getNewSemesterData(), 'Semester 2 2024': getNewSemesterData() },
currentSemester: 'Semester 1 2024'
};
}
};

const exportData = () => {
const dataStr = JSON.stringify(db, null, 2);
const dataBlob = new Blob([dataStr], { type: 'application/json' });
const url = URL.createObjectURL(dataBlob);
const link = document.createElement('a');
link.href = url;
link.download = `timetable-backup-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);
alert('ementModal.classList.remove('active'));
document.getElementById('closeSemesterModalBtn').addEventListener('click', () => semesterModal.classList.remove('active'));
document.getElementById('closeSessionModalBtn').addEventListener('click', () => document.getElementById('sessionModal').classList.remove('active'));
document.getElementById('closeDuplicateDayModalBtn').addEventListener('click', () => duplicateDayModal.classList.remove('active'));
document.getElementById('loadSampleDataBtn').addEventListener('click', () => {
const currentData = getCurrentSemesterData();
const sampleData = getSampleData();
currentData.courses = sampleData.courses;
currentData.teachers = sampleData.teachers;
currentData.subjects = sampleData.subjects;
currentData.schedule = sampleData.schedule;
currentData.courseNotes = sampleData.courseNotes || {};
currentData.tasks = sampleData.tasks || [];
processAndRenderAll();
alert(`Sample data loaded into ${db.currentSemester}!`);
});

document.getElementById('manageSemestersBtn').addEventListener('click', openSemesterModal);
document.getElementById('manageTeachersBtn').addEventListener('click', () => openManagementModal('Teachers', getCurrentSemesterData().teachers, ['Name', 'Surname', 'Initials', 'Email', 'HomeCollege', 'EmploymentType', 'TotalHours']));
document.getElementById('manageCoursesBtn').addEventListener('click', () => openManagementModal('Courses', getCurrentSemesterData().courses, ['Code', 'Name']));
document.getElementById('manageSubjectsBtn').addEventListener('click', () => openManagementModal('Subjects', getCurrentSemesterData().subjects, ['Subject', 'CourseCode', 'Color', 'Units', 'Compulsory', 'DeliveryMode']));
sessionForm.addEventListener('submit', handleSessionFormSubmit);
document.getElementById('deleteSessionBtn').addEventListener('click', handleDeleteSession);
document.getElementById('sessionModal').addEventListener('click', (e) => { if (e.target.id === 'sessionModal') e.currentTarget.classList.remove('active'); });
document.addEventListener('click', () => contextMenu.classList.remove('active'));

const semesterDropdownBtn = document.getElementById('semesterDropdownBtn');
const semesterDropdown = document.getElementById('semesterDropdown');
const viewDropdownBtn = document.getElementById('viewDropdownBtn');
const viewDropdown = document.getElementById('viewDropdown');

semesterDropdownBtn.addEventListener('click', (e) => {
e.stopPropagation();
semesterDropdown.classList.toggle('show');
viewDropdown.classList.remove('show');
});

viewDropdownBtn.addEventListener('click', (e) => {
e.stopPropagation();
viewDropdown.classList.toggle('show');
semesterDropdown.classList.remove('show');
});

document.addEventListener('click', () => {
semesterDropdown.classList.remove('show');
viewDropdown.classList.remove('show');
});

function processAndRenderAll() {
detectDisputes();
renderSemesterDropdown();
renderViewDropdown();
renderCollegeTabs();
handleViewChange();
saveData();
}

const timeToMinutes = (timeStr) => !timeStr ? 0 : timeStr.split(':').map(Number).reduce((h, m) => h * 60 + m);
const dayOrder = { 'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3, 'Friday': 4 };
const sortSessionsChronologically = (sessions) => {
return [...sessions].sort((a, b) => {
const dayDiff = (dayOrder[a.Day] || 0) - (dayOrder[b.Day] || 0);
if (dayDiff !== 0) return dayDiff;
return timeToMinutes(a.ClassStart) - timeToMinutes(b.ClassStart);
});
};

function detectDisputes() {
const semesterData = getCurrentSemesterData();
if (!semesterData.schedule) semesterData.schedule = [];
semesterData.schedule.forEach(s => s.dispute = null);
for (let i = 0; i < semesterData.schedule.length; i++) {
for (let j = i + 1; j < semesterData.schedule.length; j++) {
const s1 = semesterData.schedule[i];
const s2 = semesterData.schedule[j];

const sharedColleges = s1.colleges?.filter(c => s2.colleges?.includes(c)) || [];
if (sharedColleges.length === 0) continue;

if (s1.Day !== s2.Day) continue;

const timeOverlap = timeToMinutes(s1.ClassStart) < timeToMinutes(s2.ClassEnd) && timeToMinutes(s2.ClassStart) < timeToMinutes(s1.ClassEnd);
if (timeOverlap) {
let reason = null;
const s1Teachers = [s1.TeacherInitials, s1.TeacherInitials2].filter(Boolean);
const s2Teachers = [s2.TeacherInitials, s2.TeacherInitials2].filter(Boolean);
const commonTeachers = s1Teachers.filter(t => s2Teachers.includes(t));

if (commonTeachers.length > 0) reason = `Teacher Conflict: ${commonTeachers.join(', ')}`;
else if (s1.Room === s2.Room) reason = `Room Conflict: ${s1.Room}`;

if (reason) {
s1.dispute = { reason: reason, conflictingSessionId: s2.id };
s2.dispute = { reason: reason, conflictingSessionId: s1.id };
}
}
}
}
}

function renderSemesterDropdown() {
const semesterNames = Object.keys(db.semesters).sort();
let html = '';
semesterNames.forEach(name => {
html += `<div class="dropdown-item ${db.currentSemester === name ? 'font-bold text-purple-600' : ''}" onclick="changeSemester('${name}')">${name}</div>`;
});
semesterDropdown.innerHTML = html;
}

function renderViewDropdown() {
const views = [
{ value: 'main-timetable', label: 'üìä Main Timetable' },
{ value: 'staff-summary', label: 'üë• Staff Summary' },
{ value: 'dispute-log', label: '‚ö†Ô∏è Dispute Log' },
{ value: 'course-print', label: 'üìö Course Print' },
{ value: 'teacher-print', label: 'üë®‚Äçüè´ Teacher Print' },
{ value: 'tasks', label: 'üìã Tasks' }
];

let html = '';
views.forEach(<td class="p-2 border"><span class="color-circle" style="background-color: ${item.Color};"></span>${item.Subject}</td><td class="p-2 border">${item.Color}</td><td class="p-2 border">${Array.isArray(item.Units) ? item.Units.join(', ') : (item.Units || '')}</td><td class="p-2 border">${compulsoryBadge}</td><td class="p-2 border">${deliveryBadge}</td><td class="p-2 border"><button class="text-blue-600 hover:text-blue-800 font-semibold mr-3" data-type="subjects" data-index="${originalIndex}" data-action="edit">Edit</button><button class="text-red-600 hover:text-red-800 font-semibold" data-type="subjects" data-index="${originalIndex}" data-action="delete">Delete</button></td></tr>`;
});

contentHTML += `</tbody></table></div>`;

const formHTML = `<form id="addForm" class="mt-6 grid grid-cols-2 gap-4 border-t pt-4">
<h3 class="text-lg font-bold col-span-full mb-2">Add / Edit Subject for ${selectedCourseForSubjects}</h3>
<div><label class="block text-sm font-medium">Subject</label><input type="text" name="Subject" class="w-full border p-2 rounded" required></div>
<div><label class="block text-sm font-medium">Color</label><input type="color" name="Color" class="w-full border p-2 rounded" required></div>
<div class="col-span-full"><label class="block text-sm font-medium">Units</label><input type="text" name="Units" placeholder="Unit1, Unit2" class="w-full border p-2 rounded" required></div>
<div><label class="flex items-center gap-2"><input type="checkbox" name="Compulsory" class="w-4 h-4"> <span class="text-sm font-medium">Mark as Compulsory</span></label></div>
<div><label class="block text-sm font-medium">Delivery Mode</label><select name="DeliveryMode" class="w-full border p-2 rounded" required><option value="Face-to-Face">Face-to-Face</option><option value="Online">Online</option><option value="Blended">Blended</option></select></div>
<input type="hidden" name="editIndex">
<input type="hidden" name="CourseCode" value="${selectedCourseForSubjects}">
<div class="col-span-full flex items-center gap-4">
<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Subject</button>
<button type="button" id="cancelEditBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 hidden">Cancel Edit</button>
</div>
</form>`;

contentHTML += formHTML;
contentHTML += `</div></div>`;

document.getElementById('modalContent').innerHTML = contentHTML;
managementModal.classList.add('active');

const form = document.getElementById('addForm');
const cancelBtn = document.getElementById('cancelEditBtn');

cancelBtn.addEventListener('click', () => {
form.reset();
form.querySelector('[name="editIndex"]').value = '';
form.querySelector('[name="CourseCode"]').value = selectedCourseForSubjects;
form.querySelector('button[type="submit"]').textContent = 'Add Subject';
cancelBtn.classList.add('hidden');
});

form.addEventListener('submit', (e) => {
e.preventDefault();
const formData = new FormData(e.target);
const editIndex = formData.get('editIndex');

const subjectData = {
Subject: formData.get('Subject'),
CourseCode: selectedCourseForSubjects,
Color: formData.get('Color'),
Units: formData.get('Units') ? formData.get('Units').split(',').map(u => u.trim()).filter(Boolean) : [],
Compulsory: formData.has('Compulsory') && formData.get('Compulsory') === 'on',
DeliveryMode: formData.get('DeliveryMode') || 'Face-to-Face'
};

if (editIndex) {
data[parseInt(editIndex, 10)] = subjectData;
} else {
data.push(subjectData);
}
openManagementModal('Subjects', data, fields);
processAndRenderAll();
});

document.querySelectorAll('.course-list-item').forEach(item => {
item.addEventListener('click', (e) => {
selectedCourseForSubjects = e.currentTarget.dataset.courseCode;
renderSubjectsModal();
});
});

document.getElementById('modalContent').querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', (e) => {
const { type, index, action } = e.currentTarget.dataset;
const dataCollection = getCurrentSemesterData()[type];

if (action === 'delete') {
if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
dataCollection.splice(index, 1);
openManagementModal('Subjects', dataCollection, fields);
processAndRenderAll();
}
} else if (action === 'edit') {
const item = dataCollection[index];
for (const key in item) {
const input = form.querySelector(`[name="${key}d.querySelector(`.day-column[data-day="${session.Day}"]`);
if (!dayCol) return;

sessionsByDay[session.Day].push(session);

const start = timeToMinutes(session.ClassStart) / 30 - startTime * 2;
const height = (timeToMinutes(session.ClassEnd) - timeToMinutes(session.ClassStart)) / 30 * slotHeight;
const subjectInfo = semesterData.subjects.find(s => s.Subject === session.Subject);
const teacher1Info = semesterData.teachers.find(t => t.Initials === session.TeacherInitials);
const teacher2Info = session.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === session.TeacherInitials2) : null;
const teacherDisplay = session.TeacherInitials 
? (teacher2Info 
? `${teacher1Info?.Name || session.TeacherInitials} & ${teacher2Info.Name}` 
: (teacher1Info ? `${teacher1Info.Name} ${teacher1Info.Surname}` : session.TeacherInitials))
: '<span class="unassigned-badge">UNASSIGNED</span>';
const notesHTML = session.notes ? `<div class="text-xs italic text-gray-600 truncate" title="${session.notes}">${session.notes}</div>` : '';
const collegeInfo = semesterData.currentCollege === 'Master View' ? `<div class="font-bold text-indigo-600 text-xs">${session.colleges?.join(', ') || ''}</div>` : '';
const unitsHTML = subjectInfo?.Units?.length > 0 ? `<div class="session-units">Units: ${subjectInfo.Units.join(', ')}</div>` : '';
const compulsoryBadge = subjectInfo?.Compulsory ? `<div class="font-bold text-red-600 text-xs">COMPULSORY</div>` : '';
const deliveryMode = subjectInfo?.DeliveryMode || 'Face-to-Face';
const deliveryClass = deliveryMode === 'Online' ? 'online' : (deliveryMode === 'Blended' ? 'blended' : '');

const sessionBlock = document.createElement('div');
sessionBlock.className = `session-block ${session.dispute ? 'dispute-warning' : ''} ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${deliveryClass}`;
sessionBlock.setAttribute('data-session-id', session.id);
Object.assign(sessionBlock.style, { top: `${start * slotHeight}px`, height: `${height}px`, backgroundColor: subjectInfo?.Color || '#e5e7eb', left: '2px', right: '2px' });
sessionBlock.innerHTML = `${collegeInfo}<div class="font-bold">${session.CourseCode} - ${session.Subject}</div>${compulsoryBadge}${unitsHTML}<div>${teacherDisplay} | Room ${session.Room}</div>${notesHTML}<div class="text-xs">${session.ClassStart} - ${session.ClassEnd}</div><div class="resize-handle"></div>`;
sessionBlock.addEventListener('dblclick', () => openSessionModal(session));
sessionBlock.addEventListener('contextmenu', (e) => showContextMenu(e, session));
dayCol.appendChild(sessionBlock);
makeDraggable(sessionBlock, session, grid);
makeResizable(sessionBlock, session);
});

days.forEach(day => {
const dayCol = grid.querySelector(`.day-column[data-day="${day}"]`);
if (dayCol && sessionsByDay[day].length > 0) {
arrangeOverlappingSessions(dayCol, sessionsByDay[day]);
}
});

addSlotSelectionListeners();
}

function showContextMenu(e, session) {
e.preventDefault();
e.stopPropagation();
const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
let menuHTML = `
<div class="context-menu-item" onclick="${teacherNote}" placeholder="Add notes..."></td></tr>`;
});
container.innerHTML = tableHTML + `</tbody></table>`;

container.querySelectorAll('.staff-notes-input').forEach(input => {
input.addEventListener('change', (e) => {
const teacherInitials = e.target.dataset.teacher;
semesterData.staffNotes[teacherInitials] = e.target.value;
saveData();
});
});
}

function renderDisputeLogView() {
const container = document.getElementById('dispute-log-view');
const semesterData = getCurrentSemesterData();
const disputedSessions = semesterData.schedule.filter(s => s.dispute);

let contentHTML = `<div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto">
<h2 class="text-xl font-bold text-center mb-4">Dispute Log - ${semesterData.currentCollege} (${db.currentSemester})</h2>`;

if (disputedSessions.length === 0) {
contentHTML += `<p class="text-center text-gray-500">No disputes found in this view.</p>`;
} else {
const headers = ['Day', 'Time', 'Course', 'Subject', 'Teacher', 'Room', 'Colleges', 'Reason for Dispute'];
contentHTML += `<table class="w-full text-sm border-collapse"><thead><tr class="bg-red-800 text-white">${headers.map(h => `<th class="border p-2">${h}</th>`).join('')}</tr></thead><tbody>`;
disputedSessions.forEach(session => {
const teachers = [session.TeacherInitials, session.TeacherInitials2].filter(Boolean).join(', ') || 'Unassigned';
contentHTML += `<tr class="border-b hover:bg-red-50">
<td class="border p-2">${session.Day}</td>
<td class="border p-2">${session.ClassStart} - ${session.ClassEnd}</td>
<td class="border p-2">${session.CourseCode}</td>
<td class="border p-2">${session.Subject}</td>
<td class="border p-2">${teachers}</td>
<td class="border p-2">Room ${session.Room}</td>
<td class="border p-2">${session.colleges?.join(', ') || ''}</td>
<td class="border p-2 font-bold text-red-600">${session.dispute.reason}</td>
</tr>`;
});
contentHTML += `</tbody></table>`;
}
contentHTML += `</div>`;
container.innerHTML = contentHTML;
}

function renderCoursePrintView(courseCode) {
const container = document.getElementById('course-print-view');
const semesterData = getCurrentSemesterData();

if (!courseCode && semesterData.courses.length > 0) {
courseCode = semesterData.courses[0].Code;
}

if (!courseCode) {
container.innerHTML = `<div class="p-6 bg-white rounded shadow text-center text-gray-500 font-semibold">Please add courses in the Data Hub to use this view.</div>`;
return;
}

const courseInfo = semesterData.courses.find(c => c.Code === courseCode);

const scheduleToFilter = semesterData.currentCollege === 'Master View'
? semesterData.schedule
: semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));

let sessions = scheduleToFilter.filter(s => s.CourseCode === courseCode);
sessions = sortSessionsChronologically(sessions);
const totalHours = sessions.reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);

if (!semesterData.courseNotes) semesterData.courseNotes = {};
const courseNotes = semesterData.courseNotes[courseCode] || '';

const title200px';
    tempContainer.appendChild(clonedElement);
    document.body.appendChild(tempContainer);

    // Wait for images to load
    await new Promise(resolve => setTimeout(resolve, 500));

    // Use html2canvas to convert to image
    const canvas = await html2canvas(clonedElement, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff',
      windowWidth: 1200,
      windowHeight: clonedElement.scrollHeight
    });

    // Remove temporary container
    document.body.removeChild(tempContainer);

    // Create PDF using jsPDF
    const { jsPDF } = window.jspdf;
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210; // A4 width in mm
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    const pdf = new jsPDF({
      orientation: imgHeight > imgWidth ? 'portrait' : 'landscape',
      unit: 'mm',
      format: 'a4'
    });

    let heightLeft = imgHeight;
    let position = 0;

    // Add image to PDF with pagination
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pdf.internal.pageSize.getHeight();

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pdf.internal.pageSize.getHeight();
    }

    // Save the PDF
    pdf.save(filename);

    loadingOverlay.style.display = 'none';
    alert('‚úÖ PDF downloaded successfully!');

  } catch (error) {
    console.error('PDF generation error:', error);
    loadingOverlay.style.display = 'none';
    alert(`‚ùå Error generating PDF: ${error.message}`);
  }
}
