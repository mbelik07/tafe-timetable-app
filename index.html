<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="TAFE Interactive Timetabling Application" property="og:title"/>
<meta content="A multi-college, interactive timetabling solution for TAFE NSW with data persistence and class notes." property="og:description"/>
<meta content="website" property="og:type"/>
<title>TAFE Interactive Timetabling Application</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
* { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
.sidebar { transition: transform 0.3s ease-in-out; }
.sidebar-open { transform: translateX(0) !important; }
.view-container { display: none; }
.view-container.active { display: block; }
.college-tab { padding: 8px 16px; border: 1px solid transparent; border-bottom: none; background: #f3f4f6; color: #4b5563; cursor: pointer; border-radius: 6px 6px 0 0; }
.college-tab.active { background: white; border-color: #d1d5db; border-bottom-color: white; font-weight: bold; color: #1e3a8a; }
.timetable-main-grid { display: grid; grid-template-columns: 50px repeat(5, minmax(200px, 1fr)); grid-template-rows: auto 1fr; border: 1px solid #d1d5db; }
.timetable-header { background-color: #007bff; color: white; font-weight: bold; padding: 0.75rem 0.5rem; text-align: center; border-left: 1px solid #d1d5db; grid-row: 1; }
.time-labels { grid-row: 2; grid-column: 1; display: flex; flex-direction: column; }
.time-label { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6b7280; border-top: 1px solid #e5e7eb; box-sizing: border-box; }
.day-column { grid-row: 2; position: relative; border-left: 1px solid #d1d5db; }
.time-slot { height: 30px; border-top: 1px solid #e5e7eb; box-sizing: border-box; cursor: pointer; }
.time-slot:hover { background-color: rgba(229, 231, 235, 0.5); }
.dragging .time-slot:hover { background-color: transparent !important; }
.dragging .time-slot { cursor: default !important; }
.time-slot.slot-selected { background-color: rgba(59, 130, 246, 0.3); }
.session-block { position: absolute; border-radius: 4px; padding: 6px; font-size: 14px; line-height: 1.3; overflow: hidden; border: 1px solid rgba(0,0,0,0.4); z-index: 10; cursor: grab; }
.session-block.compulsory { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700; }
.session-block.online { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.blended { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.compulsory.online { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.session-block.compulsory.blended { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.dispute-warning { border: 3px solid #ef4444 !important; z-index: 15; animation: pulse-border 1.5s infinite; }
.dispute-warning::after { content: '‚ö†Ô∏è DISPUTED'; position: absolute; top: 2px; right: 4px; font-weight: bold; color: #ef4444; font-size: 10px; background: white; padding: 0 2px; border-radius: 3px;}
@keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
.resize-handle { position: absolute; bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; z-index: 20; }
.context-menu { position: fixed; background: #2d3748; color: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-width: 200px; display: none; }
.context-menu.active { display: block; }
.context-menu-item { padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #4a5568; }
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:hover { background: #4a5568; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: none; }
.modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; z-index: 101; }
.modal-overlay.active { display: block; }
.print-grid { display: grid; grid-template-columns: 80px repeat(5, 1fr); border: 2px solid #000; }
.print-header { font-weight: bold; text-align: center; padding: 4px; border: 1px solid #999; background: #d9d9d9; font-size: 18px; line-height: 1.2; }
.print-day-header { background: #595959; color: white; }
.print-period-label { display: flex; align-items: center; justify-content: center; text-align: center; font-weight: bold; background: #fde9d9; border: 1px solid #999; font-size: 13px; min-height: 140px; }
.print-cell { border: 1px solid #999; padding: 4px; vertical-align: top; min-height: 140px; }
.print-session { border-radius: 4px; padding: 6px; font-size: 15px; margin-top: 5px; border: 1px solid black; line-height: 1.3; }
.print-session.compulsory { border: 4px solid #ffff00; box-shadow: 0 0 0 1px #ffd700; }
.print-session.online { border: 3px solid #3b82f6; }
.print-session.blended { border: 3px solid #3b82f6; }
.print-session.compulsory.online { border: 4px solid #ffff00; box-shadow: 0 0 0 1px #ffd700, 0 0 0 4px #3b82f6; }
.print-session.compulsory.blended { border: 4px solid #ffff00; box-shadow: 0 0 0 1px #ffd700, 0 0 0 4px #3b82f6; }
.session-units { font-size: 11px; color: #555; margin-top: 2px; font-style: italic; }
.color-circle { display: inline-block; width: 22px; height: 22px; border-radius: 50%; border: 1px solid #999; margin-right: 8px; vertical-align: middle; }
.bottom-sections-container { display: flex; gap: 1.5rem; margin-top: 1rem; }
.teacher-contact-info { flex: 3.5; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #f3f4f6; }
.teacher-contact-info h4 { font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; font-size: 1rem; }
.teacher-contact-info p { margin: 0.25rem 0; font-size: 1rem; color: #374151; }
.notes-section { flex: 3.5; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; display: flex; flex-direction: column; }
.notes-section label { display: block; font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; font-size: 1rem; }
.notes-section textarea { flex: 1; width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.875rem; resize: vertical; min-height: 80px; }
.legend-section { flex: 1; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; }
.legend-section h4 { font-weight: bold; margin-bottom: 0.75rem; color: #1f2937; font-size: 1rem; }
.legend-item { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.95rem; color: #374151; }
.legend-circle { display: inline-block; width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0; }
.course-list-item { padding: 12px; margin-bottom: 8px; background: #f3f4f6; border: 2px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.course-list-item:hover { background: #e5e7eb; }
.course-list-item.active { background: #dbeafe; border-color: #3b82f6; font-weight: bold; }
.staff-notes-input { max-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }

/* Enhanced Task Styles */
.task-card { padding: 1.25rem; border-left: 5px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; background: white; border: 1px solid #d1d5db; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.task-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.task-card.critical { border-left: 5px solid #dc2626; background: #fee2e2; }
.task-card.high { border-left: 5px solid #f59e0b; background: #fef3c7; }
.task-card.medium { border-left: 5px solid #3b82f6; background: #dbeafe; }
.task-card.low { border-left: 5px solid #10b981; background: #ecfdf5; }
.task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; gap: 1rem; }
.task-title { font-weight: bold; font-size: 1.1rem; color: #1f2937; flex: 1; }
.task-status-badge { display: inline-block; padding: 0.35rem 0.85rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; white-space: nowrap; }
.task-status-todo { background: #e5e7eb; color: #374151; }
.task-status-inprogress { background: #fbbf24; color: #78350f; }
.task-status-done { background: #dcfce7; color: #166534; }
.task-status-blocked { background: #fee2e2; color: #991b1b; }
.task-meta { display: flex; gap: 1.5rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem; flex-wrap: wrap; }
.task-meta-item { display: flex; align-items: center; gap: 0.5rem; }
.task-description { color: #4b5563; margin-bottom: 1rem; line-height: 1.5; }
.task-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.task-actions button { padding: 0.35rem 0.85rem; font-size: 0.875rem; border-radius: 0.375rem; border: none; cursor: pointer; transition: all 0.2s; font-weight: 500; }
.task-edit-btn { background: #3b82f6; color: white; }
.task-edit-btn:hover { background: #2563eb; }
.task-delete-btn { background: #ef4444; color: white; }
.task-delete-btn:hover { background: #dc2626; }
.task-complete-btn { background: #10b981; color: white; }
.task-complete-btn:hover { background: #059669; }
.task-filters { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
.task-filter-btn { padding: 0.5rem 1rem; border: 2px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
.task-filter-btn:hover { border-color: #3b82f6; }
.task-filter-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
.task-empty-state { text-align: center; padding: 3rem 1rem; color: #6b7280; }
.task-empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
.task-type-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: bold; margin-bottom: 0.5rem; }
.task-type-course { background: #dbeafe; color: #1e40af; }
.task-type-teacher { background: #fce7f3; color: #831843; }
.task-type-custom { background: #f3e8ff; color: #6b21a8; }

@media print { 
  body * { visibility: hidden; } 
  #print-area, #print-area * { visibility: visible; } 
  #print-area { position: absolute; left: 0; top: 0; width: 100%; } 
  .no-print { display: none; } 
  .bottom-sections-container { page-break-inside: avoid; } 
}
</style>
</head>
<body class="bg-gray-100">
<div class="sidebar fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 -translate-x-full" id="sidebar">
<div class="p-4 bg-blue-900 text-white flex justify-between items-center no-print"><h2 class="text-xl font-bold">Data Hub</h2><button class="text-2xl" id="closeSidebarBtn">√ó</button></div>
<div class="p-4 space-y-3 no-print">
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Management</h3>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSemestersBtn">üìã Manage Semesters</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageTeachersBtn">üë®‚Äçüè´ Manage Teachers</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageCoursesBtn">üìö Manage Courses</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSubjectsBtn">üé® Manage Subjects</button>
<hr class="my-4"/>
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Data Actions</h3>
<button class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" id="exportDataBtn">üíæ Export Data</button>
<button class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" id="importDataBtn">üìÇ Import Data</button>
<button class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" id="loadSampleDataBtn">üîÑ Load Sample Data</button>
<input type="file" id="importFileInput" accept=".json" style="display: none;"/>
</div>
</div>
<div class="transition-all duration-300" id="mainContent">
<header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
<div class="flex items-center gap-4"><h1 class="text-2xl font-bold text-blue-900">Interactive Timetabling App</h1></div>
<div class="flex items-center gap-3">
<button class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded" id="openSidebarBtn">Open Menu</button>
<select class="border border-gray-300 rounded px-3 py-2 font-bold" id="semesterSelector"></select>
<select class="border border-gray-300 rounded px-3 py-2" id="viewSelector"><option value="main-timetable">Main Timetable</option><option value="staff-summary">Staff Summary</option><option value="dispute-log">Dispute Log</option><option value="course-print">Course Print</option><option value="teacher-print">Teacher Print</option><option value="tasks">Tasks</option></select>
<div class="flex gap-2" id="secondary-selectors"></div>
<button class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded" id="printBtn">üìÑ Download PDF</button>
</div>
</header>
<main class="p-4">
<div class="flex items-center gap-2 mb-[-1px] no-print" id="college-tabs-container"></div>
<div id="print-area">
<div class="view-container active" id="main-timetable-view"><div class="bg-white p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-center mb-4" id="main-timetable-title"></h2><div class="timetable-grid-container"><div class="timetable-main-grid" id="main-timetable-grid"><div class="text-center p-10 col-span-6 text-gray-500">Load sample data or add your own to begin.</div></div></div></div></div>
<div class="view-container" id="staff-summary-view"><div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto"><h2 class="text-xl font-bold text-center mb-4" id="staff-summary-title"></h2><div id="staff-summary-table"></div></div></div>
<div class="view-container" id="dispute-log-view"></div>
<div class="view-container" id="course-print-view"></div>
<div class="view-container" id="teacher-print-view"></div>
<div class="view-container" id="tasks-view"><div class="bg-white p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-6">üìã Task Management & Issues</h2><div class="mb-6 flex gap-3 flex-wrap"><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="addTaskBtn">+ Add Custom Task</button><button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" id="scanIssuesBtn">üîç Scan for Issues</button></div><div class="task-filters" id="taskFilters"></div><div id="tasks-container"></div></div></div>
</div>
</main>
</div>
<div class="context-menu" id="contextMenu"></div>
<div class="modal-overlay" id="managementModal"><div class="modal-container"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="modalTitle">Manage</h2><button class="text-3xl font-bold" id="closeModalBtn">√ó</button></div><div class="space-y-4" id="modalContent"></div></div></div>
<div class="modal-overlay" id="semesterModal"><div class="modal-container" style="max-width: 600px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Manage Semesters</h2><button class="text-3xl font-bold" id="closeSemesterModalBtn">√ó</button></div><div id="semesterModalContent"></div></div></div>
<div class="modal-overlay" id="sessionModal"><div class="modal-container" style="max-width: 500px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="sessionModalTitle">Add/Edit Session</h2><button class="text-3xl font-bold" id="closeSessionModalBtn" type="button">√ó</button></div><form class="space-y-4" id="sessionForm"><input id="sessionId" type="hidden"/><input id="sessionDay" type="hidden"/><div><label class="block font-medium">Course</label><select class="w-full border p-2 rounded" id="sessionCourse" required=""></select></div><div><label class="block font-medium">Subject</label><select class="w-full border p-2 rounded" id="sessionSubject" required=""></select></div><div><label class="block font-medium">Teacher 1 (Primary)</label><select class="w-full border p-2 rounded" id="sessionTeacher" required=""></select></div><div><label class="block font-medium">Teacher 2 (Co-teacher - Optional)</label><select class="w-full border p-2 rounded" id="sessionTeacher2"><option value="">-- None --</option></select></div><div><label class="block font-medium">Room</label><input class="w-full border p-2 rounded" id="sessionRoom" required="" type="text"/></div><div><label class="block font-medium mb-2">Colleges (select one or more)</label><div class="flex gap-4"><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Moss Vale" class="w-4 h-4"> Moss Vale</label><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Goulburn" class="w-4 h-4"> Goulburn</label><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Queanbeyan" class="w-4 h-4"> Queanbeyan</label></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Start Time</label><input class="w-full border p-2 rounded" id="sessionStartTime" required="" step="1800" type="time"/></div><div><label class="block font-medium">End Time</label><input class="w-full border p-2 rounded" id="sessionEndTime" required="" step="1800" type="time"/></div></div><div><label class="block font-medium">Notes (e.g., Face-to-Face)</label><textarea class="w-full border p-2 rounded" id="sessionNotes" rows="2"></textarea></div><div class="flex justify-between items-center mt-6"><button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteSessionBtn" type="button">Delete</button><button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" type="submit">Save Session</button></div></form></div></div>
<div class="modal-overlay" id="duplicateDayModal"><div class="modal-container" style="max-width: 400px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Duplicate to Another Day</h2><button class="text-3xl font-bold" id="closeDuplicateDayModalBtn">√ó</button></div><div class="space-y-3" id="duplicateDayContent"></div></div></div>
<div class="modal-overlay" id="taskModal"><div class="modal-container" style="max-width: 600px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="taskModalTitle">Add New Task</h2><button class="text-3xl font-bold" id="closeTaskModalBtn">√ó</button></div><form class="space-y-4" id="taskForm"><input id="taskId" type="hidden"/><div><label class="block font-medium">Task Title</label><input type="text" id="taskTitle" class="w-full border p-2 rounded" required placeholder="Enter task title"/></div><div><label class="block font-medium">Description</label><textarea id="taskDescription" class="w-full border p-2 rounded" rows="3" placeholder="Enter task description (optional)"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Priority</label><select id="taskPriority" class="w-full border p-2 rounded" required><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div><div><label class="block font-medium">Status</label><select id="taskStatus" class="w-full border p-2 rounded" required><option value="todo" selected>To Do</option><option value="inprogress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div></div><div><label class="block font-medium">Due Date</label><input type="date" id="taskDueDate" class="w-full border p-2 rounded"/></div><div class="flex justify-between items-center mt-6"><button type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteTaskBtn" style="display: none;">Delete Task</button><div class="flex gap-2"><button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" id="cancelTaskBtn">Cancel</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save Task</button></div></div></form></div></div>
<div class="modal-overlay" id="loadingOverlay" style="display: none; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.8); z-index: 200;">
<div class="text-center p-8 bg-white rounded-lg shadow-xl">
<h2 class="text-2xl font-bold text-blue-900 mb-2">Generating PDF...</h2>
<p class="text-gray-600">Please wait, this may take a moment.</p>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js/dist/html2pdf.bundle.min.js"></script>
<script>
let selectedCourseForSubjects = null;
let sidebarOpen = false;
let taskFilterStatus = 'all';

document.addEventListener('DOMContentLoaded', () => {
let db = {};
const colleges = ['Moss Vale', 'Goulburn', 'Queanbeyan'];
const getNewSemesterData = () => ({ courses: [], teachers: [], subjects: [], schedule: [], currentCollege: 'Moss Vale', staffNotes: {}, tasks: [] });

const saveData = () => localStorage.setItem('timetableDataV2', JSON.stringify(db));
const loadData = () => {
const savedData = localStorage.getItem('timetableDataV2');
if (savedData) {
db = JSON.parse(savedData);
Object.keys(db.semesters).forEach(semKey => {
if (db.semesters[semKey].subjects) {
db.semesters[semKey].subjects.forEach(subj => {
if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
});
}
if (!db.semesters[semKey].staffNotes) {
db.semesters[semKey].staffNotes = {};
}
if (!db.semesters[semKey].tasks) {
db.semesters[semKey].tasks = [];
}
});
} else {
db = {
semesters: { 'Semester 1 2024': getNewSemesterData() },
currentSemester: 'Semester 1 2024'
};
}
};

const exportData = () => {
const dataStr = JSON.stringify(db, null, 2);
const dataBlob = new Blob([dataStr], { type: 'application/json' });
const url = URL.createObjectURL(dataBlob);
const link = document.createElement('a');
link.href = url;
link.download = `timetable-backup-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);
alert('‚úÖ Data exported successfully!');
};

const importData = () => {
document.getElementById('importFileInput').click();
};

document.getElementById('importFileInput').addEventListener('change', (e) => {
const file = e.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = (event) => {
try {
const importedData = JSON.parse(event.target.result);

if (!importedData.semesters || !importedData.currentSemester) {
throw new Error('Invalid data format. Missing semesters or currentSemester.');
}

if (confirm('‚ö†Ô∏è This will replace all your current data. Are you sure?')) {
db = importedData;
Object.keys(db.semesters).forEach(semKey => {
if (db.semesters[semKey].subjects) {
db.semesters[semKey].subjects.forEach(subj => {
if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
});
}
if (!db.semesters[semKey].staffNotes) {
db.semesters[semKey].staffNotes = {};
}
if (!db.semesters[semKey].tasks) {
db.semesters[semKey].tasks = [];
}
});
saveData();
processAndRenderAll();
alert('‚úÖ Data imported successfully!');
}
} catch (error) {
alert(`‚ùå Error importing data: ${error.message}`);
}
};
reader.readAsText(file);

e.target.value = '';
});

const getCurrentSemesterData = () => {
if (!db.semesters[db.currentSemester]) {
const firstSemester = Object.keys(db.semesters)[0];
if (firstSemester) {
db.currentSemester = firstSemester;
} else {
db.semesters['Default Semester'] = getNewSemesterData();
db.currentSemester = 'Default Semester';
}
}
return db.semesters[db.currentSemester];
};

const collegeTabsContainer = document.getElementById('college-tabs-container');
const sessionForm = document.getElementById('sessionForm');
const managementModal = document.getElementById('managementModal');
const semesterModal = document.getElementById('semesterModal');
const contextMenu = document.getElementById('contextMenu');
const duplicateDayModal = document.getElementById('duplicateDayModal');
const taskModal = document.getElementById('taskModal');
const taskForm = document.getElementById('taskForm');
const secondarySelectorsContainer = document.getElementById('secondary-selectors');
const viewSelector = document.getElementById('viewSelector');
const semesterSelector = document.getElementById('semesterSelector');
const sidebar = document.getElementById('sidebar');
const openSidebarBtn = document.getElementById('openSidebarBtn');
const closeSidebarBtn = document.getElementById('closeSidebarBtn');

const getSampleData = () => ({
courses: [{ Code: 'FSK20119', Name: 'Cert II Skills for Work' }, { Code: '11225NAT', Name: 'Cert IV Tertiary Prep' }],
teachers: [
{ Name: 'Juan', Surname: 'Aburto', Initials: 'JA', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'juan.aburto@tafe.edu.au' },
{ Name: 'Cary', Surname: 'Buecher', Initials: 'CB', HomeCollege: 'Goulburn', EmploymentType: 'Casual', TotalHours: 8, Email: 'cary.buecher@tafe.edu.au' },
{ Name: 'Miroslav', Surname: 'Belik', Initials: 'MB', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'miroslav.belik@tafe.edu.au' },
{ Name: 'Carlie', Surname: 'Dally', Initials: 'CD', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'carlie.dally@tafe.edu.au' },
{ Name: 'Bernadette', Surname: 'Flynn-Whitehall', Initials: 'BF', HomeCollege: 'Moss Vale', EmploymentType: 'Casual', TotalHours: 4, Email: 'bernadette.flynn@tafe.edu.au' },
{ Name: 'Christopher', Surname: 'Worland', Initials: 'CW', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'christopher.worland@tafe.edu.au' },
{ Name: 'David', Surname: 'Baird', Initials: 'DB', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'david.baird@tafe.edu.au' },
{ Name: 'David', Surname: 'Cole', Initials: 'DC', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'david.cole@tafe.edu.au' },
{ Name: 'Georgina', Surname: 'Templeton', Initials: 'GT', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'georgina.templeton@tafe.edu.au' },
{ Name: 'Ian', Surname: 'Willis', Initials: 'IW', HomeCollege: 'Goulburn', EmploymentType: 'Casual', TotalHours: 4, Email: 'ian.willis@tafe.edu.au' },
{ Name: 'Karen', Surname: 'Gardner', Initials: 'KG', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'karen.gardner@tafe.edu.au' },
{ Name: 'Kerri-Anne', Surname: 'Smith', Initials: 'KS', HomeCollege: 'Moss Vale', EmploymentType: 'Casual', TotalHours: 4, Email: 'kerri-anne.smith@tafe.edu.au' },
{ Name: 'Rosalind', Surname: 'Phillips', Initials: 'RP', HomeCollege: 'Queanbeyan', EmploymentType: 'Casual', TotalHours: 4, Email: 'rosalind.phillips@tafe.edu.au' },
{ Name: 'Rosalind', Surname: 'Tuohy', Initials: 'RT', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'rosalind.tuohy@tafe.edu.au' },
{ Name: 'Susan', Surname: 'Neild', Initials: 'SN', HomeCollege: 'Queanbeyan', EmploymentType: 'Casual', TotalHours: 4, Email: 'susan.neild@tafe.edu.au' },
{ Name: 'Anna', Surname: 'Nikonova', Initials: 'AN', HomeCollege: 'Queanbeyan', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'anna.nikonova@tafe.edu.au' }
],
subjects: [
{ Subject: 'Health TPC', CourseCode: 'FSK20119', Color: '#ffa57d', Units: ['NAT11225026'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
{ Subject: 'Maths B TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225020'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
{ Subject: 'History TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225017'], Compulsory: false, DeliveryMode: 'Online' },
{ Subject: 'Film and Media TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225015'], Compulsory: false, DeliveryMode: 'Blended' },
{ Subject: 'English B TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225002'], Compulsory: true, DeliveryMode: 'Face-to-Face' },
{ Subject: 'Maths B Calculus TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225021'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
{ Subject: 'Compulsory Dig Lit Units PFS', CourseCode: 'FSK20119', Color: '#ff4013', Units: ['NAT11224002', 'NAT11041009', 'NAT11039015', 'FSKDIG003'], Compulsory: true, DeliveryMode: 'Blended' },
{ Subject: 'English A PFS', CourseCode: '11225NAT', Color: '#00c7fc', Units: ['NAT11224001', 'NAT11225001'], Compulsory: true, DeliveryMode: 'Face-to-Face' },
{ Subject: 'Human Rights PFS', CourseCode: '11225NAT', Color: '#00c7fc', Units: ['NAT11224007', 'NAT11224008'], Compulsory: false, DeliveryMode: 'Online' },
{ Subject: 'Study Skills', CourseCode: '11225NAT', Color: '#90ee90', Units: ['NAT11225030'], Compulsory: true, DeliveryMode: 'Face-to-Face' }
],
schedule: [
{ id: 1, Day: 'Monday', ClassStart: '09:00', ClassEnd: '13:00', TeacherInitials: 'JA', TeacherInitials2: '', CourseCode: 'FSK20119', Subject: 'Health TPC', Room: 'C1', colleges: ['Moss Vale'], notes: 'Face-to-Face', dispute: null },
{ id: 2, Day: 'Monday', ClassStart: '09:00', ClassEnd: '12:00', TeacherInitials: 'CB', TeacherInitials2: '', CourseCode: '11225NAT', Subject: 'Maths B TPC', Room: 'C4', colleges: ['Goulburn'], notes: 'Blended Delivery', dispute: null },
],
courseNotes: {},
tasks: []
});

// Toggle sidebar
openSidebarBtn.addEventListener('click', () => {
sidebarOpen = !sidebarOpen;
if (sidebarOpen) {
sidebar.classList.add('sidebar-open');
} else {
sidebar.classList.remove('sidebar-open');
}
});

closeSidebarBtn.addEventListener('click', () => {
sidebarOpen = false;
sidebar.classList.remove('sidebar-open');
});

document.getElementById('printBtn').addEventListener('click', generatePdf);
document.getElementById('exportDataBtn').addEventListener('click', exportData);
document.getElementById('importDataBtn').addEventListener('click', importData);
document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal());
document.getElementById('scanIssuesBtn').addEventListener('click', scanForIssues);
document.getElementById('closeTaskModalBtn').addEventListener('click', () => taskModal.classList.remove('active'));
document.getElementById('cancelTaskBtn').addEventListener('click', () => taskModal.classList.remove('active'));
document.getElementById('deleteTaskBtn').addEventListener('click', deleteTask);
taskForm.addEventListener('submit', saveTask);
viewSelector.addEventListener('change', handleViewChange);
semesterSelector.addEventListener('change', (e) => {
db.currentSemester = e.target.value;
processAndRenderAll();
});
document.getElementById('closeModalBtn').addEventListener('click', () => managementModal.classList.remove('active'));
document.getElementById('closeSemesterModalBtn').addEventListener('click', () => semesterModal.classList.remove('active'));
document.getElementById('closeSessionModalBtn').addEventListener('click', () => document.getElementById('sessionModal').classList.remove('active'));
document.getElementById('closeDuplicateDayModalBtn').addEventListener('click', () => duplicateDayModal.classList.remove('active'));
document.getElementById('loadSampleDataBtn').addEventListener('click', () => {
const currentData = getCurrentSemesterData();
const sampleData = getSampleData();
currentData.courses = sampleData.courses;
currentData.teachers = sampleData.teachers;
currentData.subjects = sampleData.subjects;
currentData.schedule = sampleData.schedule;
currentData.courseNotes = sampleData.courseNotes || {};
currentData.tasks = sampleData.tasks || [];
processAndRenderAll();
alert(`Sample data loaded into ${db.currentSemester}!`);
});

document.getElementById('manageSemestersBtn').addEventListener('click', openSemesterModal);
document.getElementById('manageTeachersBtn').addEventListener('click', () => openManagementModal('Teachers', getCurrentSemesterData().teachers, ['Name', 'Surname', 'Initials', 'Email', 'HomeCollege', 'EmploymentType', 'TotalHours']));
document.getElementById('manageCoursesBtn').addEventListener('click', () => openManagementModal('Courses', getCurrentSemesterData().courses, ['Code', 'Name']));
document.getElementById('manageSubjectsBtn').addEventListener('click', () => openManagementModal('Subjects', getCurrentSemesterData().subjects, ['Subject', 'CourseCode', 'Color', 'Units', 'Compulsory', 'DeliveryMode']));
sessionForm.addEventListener('submit', handleSessionFormSubmit);
document.getElementById('deleteSessionBtn').addEventListener('click', handleDeleteSession);
document.getElementById('sessionModal').addEventListener('click', (e) => { if (e.target.id === 'sessionModal') e.currentTarget.classList.remove('active'); });
document.addEventListener('click', () => contextMenu.classList.remove('active'));

function processAndRenderAll() {
detectDisputes();
renderSemesterSelector();
renderCollegeTabs();
handleViewChange();
saveData();
}

const timeToMinutes = (timeStr) => !timeStr ? 0 : timeStr.split(':').map(Number).reduce((h, m) => h * 60 + m);
const dayOrder = { 'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3, 'Friday': 4 };
const sortSessionsChronologically = (sessions) => {
return [...sessions].sort((a, b) => {
const dayDiff = (dayOrder[a.Day] || 0) - (dayOrder[b.Day] || 0);
if (dayDiff !== 0) return dayDiff;
return timeToMinutes(a.ClassStart) - timeToMinutes(b.ClassStart);
});
};

function detectDisputes() {
const semesterData = getCurrentSemesterData();
if (!semesterData.schedule) semesterData.schedule = [];
semesterData.schedule.forEach(s => s.dispute = null);
for (let i = 0; i < semesterData.schedule.length; i++) {
for (let j = i + 1; j < semesterData.schedule.length; j++) {
const s1 = semesterData.schedule[i];
const s2 = semesterData.schedule[j];

const sharedColleges = s1.colleges?.filter(c => s2.colleges?.includes(c)) || [];
if (sharedColleges.length === 0) continue;

if (s1.Day !== s2.Day) continue;

const timeOverlap = timeToMinutes(s1.ClassStart) < timeToMinutes(s2.ClassEnd) && timeToMinutes(s2.ClassStart) < timeToMinutes(s1.ClassEnd);
if (timeOverlap) {
let reason = null;
const s1Teachers = [s1.TeacherInitials, s1.TeacherInitials2].filter(Boolean);
const s2Teachers = [s2.TeacherInitials, s2.TeacherInitials2].filter(Boolean);
const commonTeachers = s1Teachers.filter(t => s2Teachers.includes(t));

if (commonTeachers.length > 0) reason = `Teacher Conflict: ${commonTeachers.join(', ')}`;
else if (s1.Room === s2.Room) reason = `Room Conflict: ${s1.Room}`;

if (reason) {
s1.dispute = { reason: reason, conflictingSessionId: s2.id };
s2.dispute = { reason: reason, conflictingSessionId: s1.id };
}
}
}
}
}

function renderSemesterSelector() {
semesterSelector.innerHTML = Object.keys(db.semesters).map(name => `<option value="${name}" ${db.currentSemester === name ? 'selected' : ''}>${name}</option>`).join('');
}

function renderCollegeTabs() {
const currentData = getCurrentSemesterData();
let tabsHTML = `<button class="college-tab ${currentData.currentCollege === 'Master View' ? 'active' : ''}" data-college="Master View">Master View</button>`;
tabsHTML += colleges.map(c => `<button class="college-tab ${currentData.currentCollege === c ? 'active' : ''}" data-college="${c}">${c}</button>`).join('');
collegeTabsContainer.innerHTML = tabsHTML;
collegeTabsContainer.querySelectorAll('.college-tab').forEach(tab => tab.addEventListener('click', (e) => {
getCurrentSemesterData().currentCollege = e.target.dataset.college;
processAndRenderAll();
}));
}

function openSemesterModal() {
const contentEl = document.getElementById('semesterModalContent');
let contentHTML = `<h3 class="text-lg font-bold mb-2">Existing Semesters</h3><div class="space-y-2 mb-6 border p-2 rounded bg-gray-50 max-h-48 overflow-y-auto">`;

const semesterNames = Object.keys(db.semesters);
semesterNames.forEach(name => {
contentHTML += `<div class="flex justify-between items-center p-2 border-b"><span>${name}</span>
<button class="text-red-500 hover:text-red-700 ${semesterNames.length <= 1 ? 'opacity-50 cursor-not-allowed' : ''}" data-action="delete-semester" data-name="${name}" ${semesterNames.length <= 1 ? 'disabled' : ''}>Delete</button></div>`;
});
contentHTML += `</div>`;

contentHTML += `<form id="addSemesterForm" class="border-t pt-4">
<h3 class="text-lg font-bold mb-2">Create New Semester</h3>
<div class="flex gap-2">
<input type="text" name="semesterName" placeholder="e.g., Semester 2 2024" class="flex-grow border p-2 rounded" required>
<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Create</button>
</div>
</form>`;

contentEl.innerHTML = contentHTML;
semesterModal.classList.add('active');

contentEl.querySelector('#addSemesterForm').addEventListener('submit', e => {
e.preventDefault();
const newName = e.target.elements.semesterName.value.trim();
if (newName && !db.semesters[newName]) {
db.semesters[newName] = getNewSemesterData();
db.currentSemester = newName;
semesterModal.classList.remove('active');
processAndRenderAll();
} else {
alert('Semester name is empty or already exists.');
}
});

contentEl.querySelectorAll('[data-action="delete-semester"]').forEach(btn => {
btn.addEventListener('click', e => {
const nameToDelete = e.target.dataset.name;
if (confirm(`Are you sure you want to delete "${nameToDelete}"? This action cannot be undone.`)) {
delete db.semesters[nameToDelete];
if (db.currentSemester === nameToDelete) {
db.currentSemester = Object.keys(db.semesters)[0];
}
openSemesterModal();
processAndRenderAll();
}
});
});
}

function scanForIssues() {
const semesterData = getCurrentSemesterData();
const newTasks = [];

// Check for incomplete course units
semesterData.courses.forEach(course => {
const courseSubjects = semesterData.subjects.filter(s => s.CourseCode === course.Code);
const courseSessions = semesterData.schedule.filter(s => s.CourseCode === course.Code);

if (courseSessions.length === 0) {
newTasks.push({
id: Date.now() + Math.random(),
title: `Missing sessions for ${course.Code}`,
description: `Course "${course.Name}" has no scheduled sessions yet.`,
priority: 'high',
status: 'todo',
type: 'course_incomplete',
relatedCourse: course.Code,
dueDate: ''
});
}
});

// Check for teachers with incomplete hours
semesterData.teachers.forEach(teacher => {
const teacherSessions = semesterData.schedule.filter(s => s.TeacherInitials === teacher.Initials || s.TeacherInitials2 === teacher.Initials);
const allocatedHours = teacherSessions.reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);
const totalHours = teacher.TotalHours || 0;

if (allocatedHours < totalHours) {
const remainingHours = totalHours - allocatedHours;
newTasks.push({
id: Date.now() + Math.random(),
title: `Incomplete hours for ${teacher.Name} ${teacher.Surname}`,
description: `${teacher.Name} ${teacher.Surname} (${teacher.Initials}) has ${remainingHours.toFixed(2)} hours remaining to allocate. (${allocatedHours.toFixed(2)}/${totalHours} hours scheduled)`,
priority: remainingHours > 5 ? 'critical' : 'high',
status: 'todo',
type: 'teacher_incomplete',
relatedTeacher: teacher.Initials,
dueDate: ''
});
}
});

if (newTasks.length === 0) {
alert('‚úÖ No issues found! Your timetable is complete.');
return;
}

// Add new tasks
newTasks.forEach(task => {
if (!semesterData.tasks.find(t => t.type === task.type && (t.relatedCourse === task.relatedCourse || t.relatedTeacher === task.relatedTeacher))) {
semesterData.tasks.push(task);
}
});

saveData();
renderTasksView();
alert(`‚úÖ Found ${newTasks.length} issue(s) and added them as tasks!`);
}

function openTaskModal(taskId = null) {
const semesterData = getCurrentSemesterData();
const task = taskId ? semesterData.tasks.find(t => t.id === taskId) : null;

document.getElementById('taskModalTitle').textContent = task ? 'Edit Task' : 'Add New Task';
document.getElementById('taskId').value = task?.id || '';
document.getElementById('taskTitle').value = task?.title || '';
document.getElementById('taskDescription').value = task?.description || '';
document.getElementById('taskPriority').value = task?.priority || 'medium';
document.getElementById('taskStatus').value = task?.status || 'todo';
document.getElementById('taskDueDate').value = task?.dueDate || '';
document.getElementById('deleteTaskBtn').style.display = task ? 'block' : 'none';

taskModal.classList.add('active');
}

function saveTask(e) {
e.preventDefault();
const semesterData = getCurrentSemesterData();
const taskId = document.getElementById('taskId').value;

const taskData = {
id: taskId || Date.now(),
title: document.getElementById('taskTitle').value,
description: document.getElementById('taskDescription').value,
priority: document.getElementById('taskPriority').value,
status: document.getElementById('taskStatus').value,
dueDate: document.getElementById('taskDueDate').value
};

if (taskId) {
const index = semesterData.tasks.findIndex(t => t.id == taskId);
if (index !== -1) {
semesterData.tasks[index] = { ...semesterData.tasks[index], ...taskData };
}
} else {
semesterData.tasks.push(taskData);
}

taskModal.classList.remove('active');
processAndRenderAll();
}

function deleteTask() {
const taskId = document.getElementById('taskId').value;
if (confirm('Are you sure you want to delete this task?')) {
const semesterData = getCurrentSemesterData();
semesterData.tasks = semesterData.tasks.filter(t => t.id != taskId);
taskModal.classList.remove('active');
processAndRenderAll();
}
}

function renderTasksView() {
const container = document.getElementById('tasks-container');
const filtersContainer = document.getElementById('taskFilters');
const semesterData = getCurrentSemesterData();
const tasks = semesterData.tasks || [];

// Render filters
const statuses = ['all', 'todo', 'inprogress', 'done', 'blocked'];
let filtersHTML = '';
statuses.forEach(status => {
const label = status === 'all' ? 'All' : status === 'inprogress' ? 'In Progress' : status.charAt(0).toUpperCase() + status.slice(1);
filtersHTML += `<button class="task-filter-btn ${taskFilterStatus === status ? 'active' : ''}" data-filter="${status}">${label}</button>`;
});
filtersContainer.innerHTML = filtersHTML;

filtersContainer.querySelectorAll('.task-filter-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
taskFilterStatus = e.target.dataset.filter;
renderTasksView();
});
});

if (tasks.length === 0) {
container.innerHTML = `<div class="task-empty-state"><div class="task-empty-state-icon">üì≠</div><p>No tasks yet. Click "Add Custom Task" or "Scan for Issues" to create one.</p></div>`;
return;
}

const filteredTasks = taskFilterStatus === 'all' ? tasks : tasks.filter(t => t.status === taskFilterStatus);

if (filteredTasks.length === 0) {
container.innerHTML = `<div class="task-empty-state"><div class="task-empty-state-icon">‚úì</div><p>No ${taskFilterStatus} tasks.</p></div>`;
return;
}

let html = '';
filteredTasks.forEach(task => {
const statusClass = `task-status-${task.status}`;
const statusText = task.status === 'inprogress' ? 'In Progress' : (task.status === 'todo' ? 'To Do' : (task.status === 'done' ? 'Done' : 'Blocked'));
const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
const priorityLabel = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
let typeLabel = 'üìù Custom';
let typeBadgeClass = 'task-type-custom';
if (task.type === 'course_incomplete') {
typeLabel = 'üìö Course Issue';
typeBadgeClass = 'task-type-course';
} else if (task.type === 'teacher_incomplete') {
typeLabel = 'üë®‚Äçüè´ Teacher Issue';
typeBadgeClass = 'task-type-teacher';
}

html += `
<div class="task-card ${task.priority}">
<div class="task-header">
<div style="flex: 1;">
<div class="task-title">${task.title}</div>
<div class="task-type-badge ${typeBadgeClass}">${typeLabel}</div>
</div>
<span class="task-status-badge ${statusClass}">${statusText}</span>
</div>
<div class="task-meta">
<div class="task-meta-item">üéØ <strong>${priorityLabel}</strong></div>
<div class="task-meta-item">üìÖ ${dueDate}</div>
</div>
${task.description ? `<div class="task-description">${task.description}</div>` : ''}
<div class="task-actions">
<button class="task-edit-btn" onclick="window.editTask(${task.id})">‚úèÔ∏è Edit</button>
${task.status !== 'done' ? `<button class="task-complete-btn" onclick="window.completeTask(${task.id})">‚úì Mark Done</button>` : ''}
<button class="task-delete-btn" onclick="window.deleteTaskFromList(${task.id})">üóëÔ∏è Delete</button>
</div>
</div>
`;
});

container.innerHTML = html;
}

window.editTask = (taskId) => {
openTaskModal(taskId);
};

window.completeTask = (taskId) => {
const semesterData = getCurrentSemesterData();
const task = semesterData.tasks.find(t => t.id === taskId);
if (task) {
task.status = 'done';
saveData();
renderTasksView();
}
};

window.deleteTaskFromList = (taskId) => {
if (confirm('Are you sure you want to delete this task?')) {
const semesterData = getCurrentSemesterData();
semesterData.tasks = semesterData.tasks.filter(t => t.id !== taskId);
processAndRenderAll();
}
};

// Rest of the code continues with all the other functions...
// (Including openManagementModal, renderMainTimetableView, etc.)

function generatePdf() {
const loadingOverlay = document.getElementById('loadingOverlay');
loadingOverlay.style.display = 'flex';

setTimeout(() => {
const element = document.getElementById('print-area');
const opt = {
margin: 10,
filename: `timetable-${db.currentSemester}-${new Date().toISOString().split('T')[0]}.pdf`,
image: { type: 'jpeg', quality: 0.98 },
html2canvas: { scale: 2 },
jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' }
};
html2pdf().set(opt).from(element).save();
loadingOverlay.style.display = 'none';
}, 100);
}

loadData();
processAndRenderAll();
});
</script>
</body>
</html>