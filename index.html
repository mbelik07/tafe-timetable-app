<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="TAFE Interactive Timetabling Application" property="og:title"/>
<meta content="A multi-college, interactive timetabling solution for TAFE NSW with data persistence and class notes." property="og:description"/>
<meta content="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762158838/u1103083349_img_120x40_8aa3ecf2_m66f6i.png" property="og:image"/>
<meta content="website" property="og:type"/>
<link href="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762158838/u1103083350_img_64x64_ad306614_xji6gn.png" rel="icon"/>
<title>TAFE Interactive Timetabling Application</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
.sidebar { transition: transform 0.3s ease-in-out; }
.sidebar-open { transform: translateX(0) !important; }
.view-container { display: none; }
.view-container.active { display: block; }
.college-tab { padding: 8px 16px; border: 1px solid transparent; border-bottom: none; background: #f3f4f6; color: #4b5563; cursor: pointer; border-radius: 6px 6px 0 0; }
.college-tab.active { background: white; border-color: #d1d5db; border-bottom-color: white; font-weight: bold; color: #1e3a8a; }
.timetable-main-grid { display: grid; grid-template-columns: 50px repeat(5, minmax(200px, 1fr)); grid-template-rows: auto 1fr; border: 1px solid #d1d5db; }
.timetable-header { background-color: #007bff; color: white; font-weight: bold; padding: 0.75rem 0.5rem; text-align: center; border-left: 1px solid #d1d5db; grid-row: 1; }
.time-labels { grid-row: 2; grid-column: 1; display: flex; flex-direction: column; }
.time-label { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6b7280; border-top: 1px solid #e5e7eb; box-sizing: border-box; }
.day-column { grid-row: 2; position: relative; border-left: 1px solid #d1d5db; }
.time-slot { height: 30px; border-top: 1px solid #e5e7eb; box-sizing: border-box; cursor: pointer; }
.time-slot:hover { background-color: rgba(229, 231, 235, 0.5); }
.dragging .time-slot:hover { background-color: transparent !important; }
.dragging .time-slot { cursor: default !important; }
.time-slot.slot-selected { background-color: rgba(59, 130, 246, 0.3); }
.session-block { position: absolute; border-radius: 4px; padding: 6px; font-size: 14px; line-height: 1.3; overflow: hidden; border: 1px solid rgba(0,0,0,0.4); z-index: 10; cursor: grab; }
.session-block.compulsory { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700; }
.session-block.online { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.blended { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.compulsory.online { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.session-block.compulsory.blended { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.dispute-warning { border: 3px solid #ef4444 !important; z-index: 15; animation: pulse-border 1.5s infinite; }
.dispute-warning::after { content: '⚠️ DISPUTED'; position: absolute; top: 2px; right: 4px; font-weight: bold; color: #ef4444; font-size: 10px; background: white; padding: 0 2px; border-radius: 3px;}
@keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
.resize-handle { position: absolute; bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; z-index: 20; }
.context-menu { position: fixed; background: #2d3748; color: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-width: 200px; display: none; }
.context-menu.active { display: block; }
.context-menu-item { padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #4a5568; }
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:hover { background: #4a5568; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: none; }
.modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; z-index: 101; }
.modal-overlay.active { display: block; }

/* Management Modal Improvements */
.management-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; }
.management-modal-title { font-size: 1.875rem; font-weight: bold; color: #1e3a8a; margin: 0; }
.management-modal-actions { display: flex; gap: 0.75rem; }
.add-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold; padding: 0.625rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.close-btn { background: none; border: none; font-size: 1.875rem; font-weight: bold; color: #6b7280; cursor: pointer; padding: 0; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; transition: all 0.2s; }
.close-btn:hover { background: #f3f4f6; color: #1f2937; }

/* Compact Table Styling */
.management-table-wrapper { overflow-x: auto; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
.management-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
.management-table thead { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; position: sticky; top: 0; }
.management-table th { padding: 0.875rem; text-align: left; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2); }
.management-table th:last-child { border-right: none; }
.management-table tbody tr { border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
.management-table tbody tr:hover { background-color: #f9fafb; }
.management-table td { padding: 0.875rem; }
.management-table td:first-child { font-weight: 600; color: #1f2937; }

/* Action Buttons - Compact */
.action-buttons { display: flex; gap: 0.5rem; justify-content: center; }
.action-btn { padding: 0.375rem 0.75rem; border: none; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 0.25rem; }
.edit-btn { background: #3b82f6; color: white; }
.edit-btn:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3); }
.delete-btn { background: #ef4444; color: white; }
.delete-btn:hover { background: #dc2626; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3); }

/* Form Section */
.management-form-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb; }
.management-form-section h3 { font-size: 1.125rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem; }
.form-group input, .form-group select { padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; transition: border-color 0.2s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
.form-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1rem; }
.form-btn { padding: 0.625rem 1.25rem; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.form-btn-submit { background: #10b981; color: white; }
.form-btn-submit:hover { background: #059669; transform: translateY(-1px); }
.form-btn-cancel { background: #9ca3af; color: white; }
.form-btn-cancel:hover { background: #6b7280; transform: translateY(-1px); }

/* PDF Print Styles */
.pdf-print-grid { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
.pdf-print-grid th, .pdf-print-grid td { border: 1px solid #000; padding: 4px; text-align: left; font-size: 9px; }
.pdf-print-grid th { background-color: #595959; color: white; font-weight: bold; }
.pdf-print-grid td:first-child, .pdf-print-grid th:first-child { width: 65px !important; max-width: 65px !important; }
.pdf-day-header { background-color: #595959; color: white; font-weight: bold; text-align: center; }
.pdf-period-label { background-color: #fde9d9; font-weight: bold; text-align: center; vertical-align: middle; min-height: 120px; width: 65px !important; max-width: 65px !important; padding: 4px 2px; font-size: 10px; word-break: break-word; overflow-wrap: break-word; }
.pdf-cell { vertical-align: top; min-height: 120px; padding: 3px !important; }
.pdf-session { border: 1px solid #000; border-radius: 2px; padding: 3px; margin-bottom: 2px; font-size: 9px; line-height: 1.2; }
.pdf-session.compulsory { border: 2px solid #ffff00; background-color: #fffacd; box-shadow: 0 0 0 2px #ffd700; }
.pdf-session.online { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
.pdf-session.blended { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }

.pdf-container { width: 100%; padding: 10px; background: white; }
.pdf-title { text-align: center; margin-bottom: 6px; }
.pdf-title h2 { font-size: 18px; font-weight: bold; margin: 0; }
.pdf-title h3 { font-size: 12px; margin: 2px 0 0 0; color: #666; }

.pdf-bottom-section { margin-top: 8px; display: flex; gap: 8px; }
.pdf-teacher-info { flex: 1.2; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; display: flex; flex-direction: column; height: fit-content; }
.pdf-teacher-info h4 { font-weight: bold; margin: 0 0 6px 0; font-size: 13px; flex-shrink: 0; }
.pdf-teacher-info-content { flex: 0; overflow-y: auto; }
.pdf-teacher-info-item { margin-bottom: 6px; font-size: 13px; line-height: 1.4; color: #222; word-break: break-word; display: flex; gap: 4px; align-items: flex-start; }
.pdf-teacher-info-item span { font-weight: 600; flex-shrink: 0; }
.pdf-teacher-info-item a { color: #0066cc; text-decoration: underline; font-size: 12px; word-break: break-all; letter-spacing: 0.2px; flex: 1; }

.pdf-notes-section { flex: 1.3; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; display: flex; flex-direction: column; height: fit-content; }
.pdf-notes-section h4 { font-weight: bold; margin: 0 0 6px 0; font-size: 13px; flex-shrink: 0; }
.pdf-notes-content { font-family: "Helvetica Neue", Arial, sans-serif; font-size: 13px; letter-spacing: 0.3px; line-height: 1.6; color: #222; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px 12px; flex: 0; white-space: pre-wrap; word-wrap: break-word; hyphens: auto; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-y: auto; }

.pdf-legend-section { flex: 0; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; display: flex; flex-direction: column; height: fit-content; }
.pdf-legend-section h4 { font-weight: bold; margin: 0 0 6px 0; font-size: 13px; flex-shrink: 0; }
.pdf-legend-item { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; font-size: 12px; }
.pdf-legend-circle { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

.pdf-total-hours { margin-top: 8px; text-align: right; font-size: 11px; font-weight: bold; }
.pdf-total-hours-value { display: inline-block; background: #1f2937; color: white; padding: 4px 10px; border-radius: 2px; margin-left: 6px; font-size: 10px; }

.color-circle { display: inline-block; width: 22px; height: 22px; border-radius: 50%; border: 1px solid #999; margin-right: 8px; vertical-align: middle; }
.course-list-item { padding: 12px; margin-bottom: 8px; background: #f3f4f6; border: 2px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.course-list-item:hover { background: #e5e7eb; }
.course-list-item.active { background: #dbeafe; border-color: #3b82f6; font-weight: bold; }
.staff-notes-input { max-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
.task-card { padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; background: white; }
.task-card.high { border-left: 4px solid #dc2626; background: #fee2e2; }
.task-card.medium { border-left: 4px solid #f59e0b; background: #fef3c7; }
.task-card.low { border-left: 4px solid #10b981; background: #ecfdf5; }
.task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
.task-title { font-weight: bold; font-size: 1.1rem; color: #1f2937; }
.task-status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
.task-status-todo { background: #e5e7eb; color: #374151; }
.task-status-inprogress { background: #dbeafe; color: #1e40af; }
.task-status-done { background: #dcfce7; color: #166534; }
.task-status-blocked { background: #fee2e2; color: #991b1b; }
.task-meta { display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; flex-wrap: wrap; }
.task-description { color: #4b5563; margin-bottom: 0.75rem; }
.task-actions { display: flex; gap: 0.5rem; }
.task-actions button { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; border: none; cursor: pointer; }
.task-edit-btn { background: #3b82f6; color: white; }
.task-edit-btn:hover { background: #2563eb; }
.task-delete-btn { background: #ef4444; color: white; }
.task-delete-btn:hover { background: #dc2626; }
.dropdown-menu { position: relative; display: inline-block; }
.dropdown-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.dropdown-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.dropdown-content { position: absolute; background: white; min-width: 250px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 0.375rem; z-index: 1; top: 100%; left: 0; margin-top: 0.5rem; display: none; border: 2px solid #667eea; max-height: 400px; overflow-y: auto; }
.dropdown-content.show { display: block; }
.dropdown-item { color: #1f2937; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: all 0.2s; }
.dropdown-item:last-child { border-bottom: none; }
.dropdown-item:hover { background: #f3f4f6; color: #667eea; font-weight: 500; }
.college-checkboxes { display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
.college-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; }
.college-checkbox-label input { cursor: pointer; width: 18px; height: 18px; }
.unassigned-badge { display: inline-block; background: #fbbf24; color: #78350f; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }

@media print { 
  body * { visibility: hidden; } 
  #print-area, #print-area * { visibility: visible; } 
  #print-area { position: absolute; left: 0; top: 0; width: 100%; } 
  .no-print { display: none !important; }
  .pdf-container { padding: 8px; }
  .pdf-print-grid { margin-bottom: 6px; }
}
</style>
</head>
<body class="bg-gray-100">
<div class="sidebar fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 -translate-x-full" id="sidebar">
<div class="p-4 bg-blue-900 text-white flex justify-between items-center no-print"><h2 class="text-xl font-bold"><i class="fas fa-database mr-2"></i> Data Hub</h2><button class="text-2xl hover:text-gray-300 transition-colors" id="closeSidebarBtn"><i class="fas fa-times"></i></button></div>
<div class="p-4 space-y-3 no-print">
<h3 class="text-lg font-bold text-gray-700 border-b pb-2 flex items-center"><i class="fas fa-tools mr-2"></i> Management</h3>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold transition-colors" id="manageSemestersBtn"><i class="fas fa-calendar-alt mr-2 text-blue-700"></i> Manage Semesters</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold transition-colors" id="manageTeachersBtn"><i class="fas fa-chalkboard-teacher mr-2 text-blue-700"></i> Manage Teachers</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold transition-colors" id="manageCoursesBtn"><i class="fas fa-book mr-2 text-blue-700"></i> Manage Courses</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold transition-colors" id="manageSubjectsBtn"><i class="fas fa-book-open mr-2 text-blue-700"></i> Manage Subjects</button>
<hr class="my-4"/>
<h3 class="text-lg font-bold text-gray-700 border-b pb-2 flex items-center"><i class="fas fa-database mr-2"></i> Data Actions</h3>
<button class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center transition-colors" id="exportDataBtn"><i class="fas fa-file-export mr-2"></i> Export Data</button>
<button class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center transition-colors" id="importDataBtn"><i class="fas fa-file-import mr-2"></i> Import Data</button>
<button class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded flex items-center justify-center transition-colors" id="loadSampleDataBtn"><i class="fas fa-sync-alt mr-2"></i> Load Sample Data</button>
<input type="file" id="importFileInput" accept=".json" style="display: none;"/>
</div>
</div>
<div class="transition-all duration-300" id="mainContent">
<header class="relative bg-cover bg-center shadow-md p-4 flex justify-between items-center no-print" style="background-image: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9)), url('https://cdn.simtheory.ai/image/upload/v1763700203/ideogram_generated_1595_1763700202_wxa6ge.png');">
<div class="flex items-center gap-4 relative z-10"><img alt="TAFE Logo" src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1762673524/ci_1595_1762673524_TAFE_logo_ecudtj.png" style="height: 50px;"/><h1 class="text-2xl font-bold text-blue-900">Interactive Timetabling App</h1></div>
<div class="flex items-center gap-3 relative z-10">
<button class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded transition-colors shadow-sm" id="openSidebarBtn"><i class="fas fa-bars mr-2"></i> Open Menu</button>
<div class="dropdown-menu">
<button class="dropdown-btn" id="semesterDropdownBtn"><i class="fas fa-calendar mr-2"></i> Semester <span><i class="fas fa-caret-down ml-2"></i></span></button>
<div class="dropdown-content" id="semesterDropdown"></div>
</div>
<div class="dropdown-menu">
<button class="dropdown-btn" id="viewDropdownBtn"><i class="fas fa-eye mr-2"></i> View <span><i class="fas fa-caret-down ml-2"></i></span></button>
<div class="dropdown-content" id="viewDropdown"></div>
</div>
<div id="secondary-selectors"></div>
<button class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm" id="printBtn"><i class="fas fa-file-pdf mr-2"></i> Download PDF</button>
</div>
</header>
<main class="p-4">
<div class="flex items-center gap-2 mb-[-1px] no-print" id="college-tabs-container"></div>
<div id="print-area">
<div class="view-container active" id="main-timetable-view"><div class="bg-white p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-center mb-4" id="main-timetable-title"></h2><div class="timetable-grid-container"><div class="timetable-main-grid" id="main-timetable-grid"><div class="text-center p-10 col-span-6 text-gray-500">Load sample data or add your own to begin.</div></div></div></div></div>
<div class="view-container" id="staff-summary-view"><div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto"><h2 class="text-xl font-bold text-center mb-4" id="staff-summary-title"></h2><div id="staff-summary-table"></div></div></div>
<div class="view-container" id="dispute-log-view"></div>
<div class="view-container" id="course-print-view"></div>
<div class="view-container" id="teacher-print-view"></div>
<div class="view-container" id="tasks-view"><div class="bg-white p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-2"><i class="fas fa-tasks mr-2"></i> Task Management</h2><p class="text-gray-600 mb-4">Semester: <span id="tasksSemesterLabel" class="font-bold text-blue-900"></span></p><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-6" id="addTaskBtn"><i class="fas fa-plus mr-2"></i> Add New Task</button><div id="tasks-container"></div></div></div>
</div>
</main>
</div>
<div class="context-menu" id="contextMenu"></div>
<div class="modal-overlay" id="managementModal"><div class="modal-container"><div class="management-modal-header"><h2 class="management-modal-title" id="modalTitle">Manage</h2><div class="management-modal-actions"><button class="add-btn" id="addItemBtn" style="display: none;"><i class="fas fa-plus mr-1"></i> Add</button><button class="close-btn" id="closeModalBtn"><i class="fas fa-times"></i></button></div></div><div id="modalContent"></div></div></div>
<div class="modal-overlay" id="semesterModal"><div class="modal-container" style="max-width: 600px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Manage Semesters</h2><button class="text-3xl font-bold" id="closeSemesterModalBtn">×</button></div><div id="semesterModalContent"></div></div></div>
<div class="modal-overlay" id="sessionModal"><div class="modal-container" style="max-width: 500px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900" id="sessionModalTitle">Add/Edit Session</h2><button class="text-3xl font-bold" id="closeSessionModalBtn" type="button">×</button></div><form class="space-y-4" id="sessionForm"><input id="sessionId" type="hidden"/><input id="sessionDay" type="hidden"/><div><label class="block font-medium">Course</label><select class="w-full border p-2 rounded" id="sessionCourse" required=""></select></div><div><label class="block font-medium">Subject</label><select class="w-full border p-2 rounded" id="sessionSubject" required=""></select></div><div><label class="block font-medium">Teacher 1 (Primary) <span class="text-gray-500 text-sm">(Optional)</span></label><select class="w-full border p-2 rounded" id="sessionTeacher"></select></div><div><label class="block font-medium">Teacher 2 (Co-teacher - Optional)</label><select class="w-full border p-2 rounded" id="sessionTeacher2"><option value="">-- None --</option></select></div><div><label class="block font-medium">Room</label><input class="w-full border p-2 rounded" id="sessionRoom" required="" type="text"/></div><div><label class="block font-medium mb-2">Colleges (select one or more)</label><div class="flex gap-4"><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Moss Vale" class="w-4 h-4"> Moss Vale</label><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Goulburn" class="w-4 h-4"> Goulburn</label><label class="flex items-center gap-2"><input type="checkbox" name="colleges" value="Queanbeyan" class="w-4 h-4"> Queanbeyan</label></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-medium">Start Time</label><input class="w-full border p-2 rounded" id="sessionStartTime" required="" step="1800" type="time"/></div><div><label class="block font-medium">End Time</label><input class="w-full border p-2 rounded" id="sessionEndTime" required="" step="1800" type="time"/></div></div><div><label class="block font-medium">Notes (e.g., Face-to-Face)</label><textarea class="w-full border p-2 rounded" id="sessionNotes" rows="2"></textarea></div><div class="flex justify-between items-center mt-6"><button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" id="deleteSessionBtn" type="button">Delete</button><button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" type="submit">Save Session</button></div></form></div></div>
<div class="modal-overlay" id="duplicateDayModal"><div class="modal-container" style="max-width: 400px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Duplicate to Another Day</h2><button class="text-3xl font-bold" id="closeDuplicateDayModalBtn">×</button></div><div class="space-y-3" id="duplicateDayContent"></div></div></div>
<div class="modal-overlay" id="addTeacherModal"><div class="modal-container" style="max-width: 500px;"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-blue-900">Add / Edit Teacher</h2><button class="text-3xl font-bold" id="closeAddTeacherModalBtn">×</button></div><form class="space-y-4" id="addTeacherForm"><input type="hidden" name="editIndex"><div><label class="block text-sm font-medium">Name</label><input type="text" name="Name" class="w-full border p-2 rounded" required></div><div><label class="block text-sm font-medium">Surname</label><input type="text" name="Surname" class="w-full border p-2 rounded" required></div><div><label class="block text-sm font-medium">Initials</label><input type="text" name="Initials" class="w-full border p-2 rounded bg-gray-200" readonly></div><div><label class="block text-sm font-medium">Email</label><input type="email" name="Email" class="w-full border p-2 rounded" required></div><div><label class="block text-sm font-medium">Home College</label><select name="HomeCollege" class="w-full border p-2 rounded" required><option value="Moss Vale">Moss Vale</option><option value="Goulburn">Goulburn</option><option value="Queanbeyan">Queanbeyan</option></select></div><div><label class="block text-sm font-medium">Employment Type</label><select name="EmploymentType" class="w-full border p-2 rounded" required><option value="Full-Time">Full-Time</option><option value="Casual">Casual</option></select></div><div><label class="block text-sm font-medium">Total Hours</label><input type="number" name="TotalHours" class="w-full border p-2 rounded" required value="0" step="0.5"></div><div class="flex gap-2 justify-end"><button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" id="cancelAddTeacherBtn">Cancel</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save Teacher</button></div></form></div></div>
<div class="modal-overlay" id="loadingOverlay" style="display: none; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.9); z-index: 200;">
<div class="text-center p-8 bg-white rounded-lg shadow-xl border-2 border-blue-500">
<div style="width: 60px; height: 60px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
<h2 class="text-2xl font-bold text-blue-900 mb-2">Generating PDF...</h2>
<p class="text-gray-600">Please wait, this may take a moment.</p>
</div>
</div>
<!-- PDF Generator Script -->
<script src="pdf-generator.js"></script>

<script>
let db = {};
let selectedCourseForSubjects = null;
let sidebarOpen = false;
const colleges = ['Moss Vale', 'Goulburn', 'Queanbeyan'];

// --- Core Data Functions ---
function getNewSemesterData() {
    return { courses: [], teachers: [], subjects: [], schedule: [], currentCollege: 'Moss Vale', staffNotes: {}, tasks: [] };
}

function saveData() {
    localStorage.setItem('timetableDataV2', JSON.stringify(db));
}

function loadData() {
    try {
        const savedData = localStorage.getItem('timetableDataV2');
        if (savedData) {
            db = JSON.parse(savedData);
            Object.keys(db.semesters).forEach(semKey => {
                if (db.semesters[semKey].subjects) {
                    db.semesters[semKey].subjects.forEach(subj => {
                        if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
                    });
                }
                if (!db.semesters[semKey].staffNotes) db.semesters[semKey].staffNotes = {};
                if (!db.semesters[semKey].tasks) db.semesters[semKey].tasks = [];
            });
        } else {
            db = {
                semesters: { 'Semester 1 2024': getNewSemesterData(), 'Semester 2 2024': getNewSemesterData() },
                currentSemester: 'Semester 1 2024'
            };
        }
    } catch(err) {
        console.error("Data loading error:", err);
        db = {
            semesters: { 'Semester 1 2024': getNewSemesterData(), 'Semester 2 2024': getNewSemesterData() },
            currentSemester: 'Semester 1 2024'
        };
    }
}

function getCurrentSemesterData() {
    if (!db.semesters[db.currentSemester]) {
        const firstSemester = Object.keys(db.semesters)[0];
        if (firstSemester) {
            db.currentSemester = firstSemester;
        } else {
            db.semesters['Default Semester'] = getNewSemesterData();
            db.currentSemester = 'Default Semester';
        }
    }
    return db.semesters[db.currentSemester];
}

function getSampleData() {
    return {
        courses: [{ Code: 'FSK20119', Name: 'Cert II Skills for Work' }, { Code: '11225NAT', Name: 'Cert IV Tertiary Prep' }],
        teachers: [
            { Name: 'Juan', Surname: 'Aburto', Initials: 'JA', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'juan.aburto@tafe.edu.au' },
            { Name: 'Cary', Surname: 'Buecher', Initials: 'CB', HomeCollege: 'Goulburn', EmploymentType: 'Casual', TotalHours: 8, Email: 'cary.buecher@tafe.edu.au' },
            { Name: 'Miroslav', Surname: 'Belik', Initials: 'MB', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'miroslav.belik@tafe.edu.au' },
            { Name: 'Carlie', Surname: 'Dally', Initials: 'CD', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'carlie.dally@tafe.edu.au' },
            { Name: 'Bernadette', Surname: 'Flynn-Whitehall', Initials: 'BF', HomeCollege: 'Moss Vale', EmploymentType: 'Casual', TotalHours: 4, Email: 'bernadette.flynn@tafe.edu.au' },
            { Name: 'Cary', Surname: 'Buecher', Initials: 'CB2', HomeCollege: 'Moss Vale', EmploymentType: 'Casual', TotalHours: 8, Email: 'cary.buecher2@tafe.edu.au' },
            { Name: 'Christopher', Surname: 'Worland', Initials: 'CW', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'christopher.worland@tafe.edu.au' },
            { Name: 'David', Surname: 'Baird', Initials: 'DB', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'david.baird@tafe.edu.au' },
            { Name: 'David', Surname: 'Cole', Initials: 'DC', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'david.cole@tafe.edu.au' },
            { Name: 'Georgina', Surname: 'Templeton', Initials: 'GT', HomeCollege: 'Goulburn', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'georgina.templeton@tafe.edu.au' },
            { Name: 'Ian', Surname: 'Willis', Initials: 'IW', HomeCollege: 'Goulburn', EmploymentType: 'Casual', TotalHours: 4, Email: 'ian.willis@tafe.edu.au' },
            { Name: 'Karen', Surname: 'Gardner', Initials: 'KG', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'karen.gardner@tafe.edu.au' },
            { Name: 'Kerri-Anne', Surname: 'Smith', Initials: 'KS', HomeCollege: 'Moss Vale', EmploymentType: 'Casual', TotalHours: 4, Email: 'kerri-anne.smith@tafe.edu.au' },
            { Name: 'Rosalind', Surname: 'Phillips', Initials: 'RP', HomeCollege: 'Queanbeyan', EmploymentType: 'Casual', TotalHours: 4, Email: 'rosalind.phillips@tafe.edu.au' },
            { Name: 'Rosalind', Surname: 'Tuohy', Initials: 'RT', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'rosalind.tuohy@tafe.edu.au' },
            { Name: 'Susan', Surname: 'Neild', Initials: 'SN', HomeCollege: 'Queanbeyan', EmploymentType: 'Casual', TotalHours: 4, Email: 'susan.neild@tafe.edu.au' },
            { Name: 'Anna', Surname: 'Nikonova', Initials: 'AN', HomeCollege: 'Queanbeyan', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'anna.nikonova@tafe.edu.au' }
        ],
        subjects: [
            { Subject: 'Health TPC', CourseCode: 'FSK20119', Color: '#ffa57d', Units: ['NAT11225026'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
            { Subject: 'Maths B TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225020'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
            { Subject: 'History TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225017'], Compulsory: false, DeliveryMode: 'Online' },
            { Subject: 'Film and Media TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225015'], Compulsory: false, DeliveryMode: 'Blended' },
            { Subject: 'English B TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225002'], Compulsory: true, DeliveryMode: 'Face-to-Face' },
            { Subject: 'Maths B Calculus TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225021'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
            { Subject: 'Compulsory Dig Lit Units PFS', CourseCode: 'FSK20119', Color: '#ff4013', Units: ['NAT11224002', 'NAT11041009', 'NAT11039015', 'FSKDIG003'], Compulsory: true, DeliveryMode: 'Blended' },
            { Subject: 'English A PFS', CourseCode: '11225NAT', Color: '#00c7fc', Units: ['NAT11224001', 'NAT11225001'], Compulsory: true, DeliveryMode: 'Face-to-Face' },
            { Subject: 'Human Rights PFS', CourseCode: '11225NAT', Color: '#00c7fc', Units: ['NAT11224007', 'NAT11224008'], Compulsory: false, DeliveryMode: 'Online' },
            { Subject: 'Study Skills', CourseCode: '11225NAT', Color: '#90ee90', Units: ['NAT11225030'], Compulsory: true, DeliveryMode: 'Face-to-Face' }
        ],
        schedule: [
            { id: 1, Day: 'Monday', ClassStart: '09:00', ClassEnd: '13:00', TeacherInitials: 'JA', TeacherInitials2: '', CourseCode: 'FSK20119', Subject: 'Health TPC', Room: 'C1', colleges: ['Moss Vale'], notes: 'Face-to-Face', dispute: null },
            { id: 2, Day: 'Monday', ClassStart: '09:00', ClassEnd: '12:00', TeacherInitials: 'CB', TeacherInitials2: '', CourseCode: '11225NAT', Subject: 'Maths B TPC', Room: 'C4', colleges: ['Goulburn'], notes: 'Blended Delivery', dispute: null },
        ],
        courseNotes: {},
        tasks: [
            { id: 1, title: 'Prepare materials for FSK20119', description: 'Photocopy worksheets and prepare online resources.', teacher: 'JA', course: 'FSK20119', colleges: ['Moss Vale'], priority: 'high', status: 'todo', dueDate: '2024-08-01' },
            { id: 2, title: 'Mark mid-term exams', description: '', teacher: 'MB', course: '11225NAT', colleges: ['Moss Vale'], priority: 'medium', status: 'inprogress', dueDate: '2024-08-15' },
        ]
    };
}

// --- Helper Functions ---
function timeToMinutes(timeStr) {
    return !timeStr ? 0 : timeStr.split(':').map(Number).reduce((h, m) => h * 60 + m);
}

function sortSessionsChronologically(sessions) {
    const dayOrder = { 'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3, 'Friday': 4 };
    return [...sessions].sort((a, b) => {
        const dayDiff = (dayOrder[a.Day] || 0) - (dayOrder[b.Day] || 0);
        if (dayDiff !== 0) return dayDiff;
        return timeToMinutes(a.ClassStart) - timeToMinutes(b.ClassStart);
    });
}

// --- RENDER FUNCTIONS (Declarations Only - Hoisted) ---

function renderTeacherPrintView(teacherInitials) {
    const container = document.getElementById('teacher-print-view');
    const semesterData = getCurrentSemesterData();

    if (!teacherInitials && semesterData.teachers.length > 0) {
        teacherInitials = semesterData.teachers[0].Initials;
    }

    if (!teacherInitials) {
        container.innerHTML = `<div class="p-6 bg-white rounded shadow text-center text-gray-500 font-semibold">Please add teachers in the Data Hub to use this view.</div>`;
        return;
    }

    const teacherInfo = semesterData.teachers.find(t => t.Initials === teacherInitials);
    const scheduleToFilter = semesterData.currentCollege === 'Master View'
    ? semesterData.schedule
    : semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));

    let sessions = scheduleToFilter.filter(s => s.TeacherInitials === teacherInitials || s.TeacherInitials2 === teacherInitials);
    sessions = sortSessionsChronologically(sessions);
    const totalHours = sessions.reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);

    const title = `${teacherInfo.Name} ${teacherInfo.Surname} - ${semesterData.currentCollege}`;
    const hasNightSessions = sessions.some(s => timeToMinutes(s.ClassStart) >= 1020);

    let gridHTML = `<table class="pdf-print-grid"><thead><tr><th class="pdf-print-grid"></th>${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(d => `<th class="pdf-day-header">${d}</th>`).join('')}</tr></thead><tbody>`;

    const periods = ['Morning', 'Afternoon'];
    if (hasNightSessions) periods.push('Night');

    periods.forEach(period => {
        gridHTML += `<tr><td class="pdf-period-label">${period}</td>`;
        ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => {
            const daySessions = sessions.filter(s => {
                const start = timeToMinutes(s.ClassStart);
                return s.Day === day && (
                    (period === 'Morning' && start < 720) ||
                    (period === 'Afternoon' && start >= 720 && start < 1020) || 
                    (period === 'Night' && start >= 1020)
                );
            });

            const sessionsHTML = daySessions.map(s => {
                const subjectInfo = semesterData.subjects.find(sub => sub.Subject === s.Subject);
                const coTeacher = s.TeacherInitials === teacherInitials 
                ? (s.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === s.TeacherInitials2) : null)
                : semesterData.teachers.find(t => t.Initials === s.TeacherInitials);
                const coTeacherDisplay = coTeacher ? ` & ${coTeacher.Name}` : '';
                const hours = (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60;
                const collegeHTML = semesterData.currentCollege === 'Master View' ? `<div style="font-weight: bold; font-size: 11px; color: #4338ca; margin-bottom: 3px;">${s.colleges?.join(', ') || ''}</div>` : '';
                const notesHTML = s.notes ? `<div style="font-style: italic; font-size: 11px; margin-top: 3px;">${s.notes}</div>` : '';
                const unitsHTML = subjectInfo?.Units?.length > 0 ? `<div style="font-size: 10px; color: #555; margin-top: 2px;">Units: ${subjectInfo.Units.join(', ')}</div>` : '';
                const compulsoryBadge = subjectInfo?.Compulsory ? `<div style="font-weight: bold; font-size: 10px; color: #d32f2f; margin-top: 2px;">COMPULSORY</div>` : '';
                const deliveryMode = subjectInfo?.DeliveryMode || 'Face-to-Face';
                const deliveryClass = deliveryMode === 'Online' ? 'online' : (deliveryMode === 'Blended' ? 'blended' : '');

                return `<div class="pdf-session ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${deliveryClass}" style="background-color:${subjectInfo?.Color || '#eee'}">
                ${collegeHTML}<div style="font-weight: bold; margin-bottom: 3px; font-size: 12px;">${s.CourseCode} | ${s.Subject}</div>${compulsoryBadge}${unitsHTML}
                <div style="margin-top: 3px; font-size: 11px;">${hours.toFixed(2)} Hrs | Room ${s.Room}${coTeacherDisplay}</div>
                ${notesHTML}<div style="margin-top: 3px; font-size: 11px;">${s.ClassStart} - ${s.ClassEnd}</div></div>`;
            }).join('');
            gridHTML += `<td class="pdf-cell">${sessionsHTML}</td>`;
        });
        gridHTML += `</tr>`;
    });
    gridHTML += `</tbody></table>`;
    container.innerHTML = `<div class="pdf-container"><div class="pdf-title"><h2>${title}</h2><h3>TAFE NSW Timetable (${db.currentSemester})</h3></div>${gridHTML}<div class="pdf-total-hours">Total Hours: <span class="pdf-total-hours-value">${totalHours.toFixed(2)}</span></div></div>`;
}

function renderCoursePrintView(courseCode) {
    const container = document.getElementById('course-print-view');
    const semesterData = getCurrentSemesterData();
    if (!courseCode && semesterData.courses.length > 0) courseCode = semesterData.courses[0].Code;
    if (!courseCode) {
        container.innerHTML = `<div class="p-6 bg-white rounded shadow text-center text-gray-500 font-semibold">Please add courses in the Data Hub to use this view.</div>`;
        return;
    }
    const courseInfo = semesterData.courses.find(c => c.Code === courseCode);
    const scheduleToFilter = semesterData.currentCollege === 'Master View' ? semesterData.schedule : semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));
    let sessions = scheduleToFilter.filter(s => s.CourseCode === courseCode);
    sessions = sortSessionsChronologically(sessions);
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const timeSlots = new Set();
    sessions.forEach(s => timeSlots.add(`${s.ClassStart}-${s.ClassEnd}`));
    const sortedTimeSlots = Array.from(timeSlots).sort((a, b) => timeToMinutes(a.split('-')[0]) - timeToMinutes(b.split('-')[0]));
    const grid = {};
    sortedTimeSlots.forEach(slot => { grid[slot] = {}; days.forEach(day => grid[slot][day] = []); });
    sessions.forEach(s => {
        const slot = `${s.ClassStart}-${s.ClassEnd}`;
        if (grid[slot] && grid[slot][s.Day]) grid[slot][s.Day].push(s);
    });

    let gridHTML = `<table class="pdf-print-grid"><thead><tr><th class="pdf-print-grid">Time</th>${days.map(d => `<th class="pdf-day-header">${d}</th>`).join('')}</tr></thead><tbody>`;
    sortedTimeSlots.forEach(timeSlot => {
        gridHTML += `<tr><td class="pdf-period-label">${timeSlot}</td>`;
        days.forEach(day => {
            const daySessions = grid[timeSlot][day] || [];
            if (daySessions.length === 0) {
                gridHTML += `<td class="pdf-cell" style="background-color: #f9f9f9;"></td>`;
            } else {
                const sessionsHTML = daySessions.map(s => {
                    const subjectInfo = semesterData.subjects.find(sub => sub.Subject === s.Subject);
                    const teacher1Info = semesterData.teachers.find(t => t.Initials === s.TeacherInitials);
                    const teacher2Info = s.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === s.TeacherInitials2) : null;
                    const teacherDisplay = s.TeacherInitials ? (teacher2Info ? `${teacher1Info?.Name || s.TeacherInitials} & ${teacher2Info.Name}` : (teacher1Info ? `${teacher1Info.Name} ${teacher1Info.Surname}` : s.TeacherInitials)) : 'UNASSIGNED';
                    const hours = (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60;
                    const collegeHTML = semesterData.currentCollege === 'Master View' ? `<div style="font-weight: bold; font-size: 11px; color: #4338ca; margin-bottom: 3px;">${s.colleges?.join(', ') || ''}</div>` : '';
                    const notesHTML = s.notes ? `<div style="font-style: italic; font-size: 11px; margin-top: 3px;">${s.notes}</div>` : '';
                    const unitsHTML = subjectInfo?.Units?.length > 0 ? `<div style="font-size: 10px; color: #555; margin-top: 2px;">Units: ${subjectInfo.Units.join(', ')}</div>` : '';
                    const compulsoryBadge = subjectInfo?.Compulsory ? `<div style="font-weight: bold; font-size: 10px; color: #d32f2f; margin-top: 2px;">COMPULSORY</div>` : '';
                    const deliveryMode = subjectInfo?.DeliveryMode || 'Face-to-Face';
                    const deliveryClass = deliveryMode === 'Online' ? 'online' : (deliveryMode === 'Blended' ? 'blended' : '');
                    return `<div class="pdf-session ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${deliveryClass}" style="background-color:${subjectInfo?.Color || '#eee'}">
                    ${collegeHTML}<div style="font-weight: bold; margin-bottom: 3px; font-size: 12px;">${s.CourseCode} | ${s.Subject}</div>
                    ${compulsoryBadge}${unitsHTML}<div style="margin-top: 3px; font-size: 11px;">${teacherDisplay} | ${hours.toFixed(2)} Hrs | Room ${s.Room}</div>
                    ${notesHTML}<div style="margin-top: 3px; font-size: 11px;">${s.ClassStart} - ${s.ClassEnd}</div></div>`;
                }).join('');
                gridHTML += `<td class="pdf-cell">${sessionsHTML}</td>`;
            }
        });
        gridHTML += `</tr>`;
    });
    gridHTML += `</tbody></table>`;
    const totalHours = sessions.reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);
    if (!semesterData.courseNotes) semesterData.courseNotes = {};
    const courseNotes = semesterData.courseNotes[courseCode] || '';
    const uniqueTeacherInitials = new Set();
    sessions.forEach(s => {
        if (s.TeacherInitials) uniqueTeacherInitials.add(s.TeacherInitials);
        if (s.TeacherInitials2) uniqueTeacherInitials.add(s.TeacherInitials2);
    });
    const courseTeachers = Array.from(uniqueTeacherInitials).map(initials => semesterData.teachers.find(t => t.Initials === initials)).filter(t => t).sort((a, b) => `${a.Name} ${a.Surname}`.localeCompare(`${b.Name} ${b.Surname}`));
    const teacherContactHTML = courseTeachers.length > 0 ? `<div class="pdf-teacher-info"><h4>Teacher Contact:</h4><div class="pdf-teacher-info-content">${courseTeachers.map(t => `<div class="pdf-teacher-info-item"><span>${t.Name} ${t.Surname}:</span>${t.Email ? `<a href="mailto:${t.Email}">${t.Email}</a>` : ''}</div>`).join('')}</div></div>` : '';
    const notesSection = `<div class="pdf-notes-section"><h4>Course Notes:</h4><div class="pdf-notes-content">${courseNotes || '(No notes added)'}</div></div>`;
    const hasCompulsory = sessions.some(s => semesterData.subjects.find(sub => sub.Subject === s.Subject)?.Compulsory);
    const hasOnline = sessions.some(s => (semesterData.subjects.find(sub => sub.Subject === s.Subject)?.DeliveryMode === 'Online'));
    const hasBlended = sessions.some(s => (semesterData.subjects.find(sub => sub.Subject === s.Subject)?.DeliveryMode === 'Blended'));
    let legendHTML = '';
    if (hasCompulsory || hasOnline || hasBlended) {
        legendHTML = `<div class="pdf-legend-section"><h4>Legend:</h4>
        ${hasCompulsory ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #ffff00; border: 2px solid #ffd700;"></div><span>Compulsory</span></div>' : ''}
        ${hasOnline ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #3b82f6;"></div><span>Online</span></div>' : ''}
        ${hasBlended ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #3b82f6;"></div><span>Blended</span></div>' : ''}
        </div>`;
    }
    const bottomSections = `<div class="pdf-bottom-section">${teacherContactHTML}${notesSection}${legendHTML}</div>`;
    container.innerHTML = `<div class="pdf-container"><div class="pdf-title"><h2>${courseInfo.Name} (${courseCode})</h2><h3>TAFE NSW Timetable (${db.currentSemester})</h3></div>${gridHTML}<div class="pdf-total-hours">Total Hours: <span class="pdf-total-hours-value">${totalHours.toFixed(2)}</span></div>${bottomSections}</div>`;
    
    const courseNotesTextarea = container.querySelector('.pdf-notes-content');
    if (courseNotesTextarea) {
        courseNotesTextarea.contentEditable = true;
        courseNotesTextarea.addEventListener('blur', (e) => {
            semesterData.courseNotes[courseCode] = e.target.textContent;
            saveData();
        });
    }
}

function renderStaffSummaryView() {
    const container = document.getElementById('staff-summary-table');
    const titleEl = document.getElementById('staff-summary-title');
    const semesterData = getCurrentSemesterData();
    const scheduleToView = semesterData.currentCollege === 'Master View' ? semesterData.schedule : semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));
    if (!semesterData.teachers?.length) { container.innerHTML = `<p class="text-center text-gray-500">No teacher data.</p>`; return; }
    titleEl.textContent = `Teaching Program Summary - ${semesterData.currentCollege} (${db.currentSemester})`;
    const sortedTeachers = [...semesterData.teachers].sort((a, b) => {
        const surnameA = (a.Surname || '').toLowerCase();
        const surnameB = (b.Surname || '').toLowerCase();
        if (surnameA < surnameB) return -1;
        if (surnameA > surnameB) return 1;
        return 0;
    });
    const headers = ['Initials', 'Name', 'Surname', ...semesterData.courses.map(c => c.Code), 'Direct Teaching', 'Total Hours', 'Remaining Hours', 'Notes'];
    let tableHTML = `<table class="w-full text-sm border-collapse"><thead><tr class="bg-blue-900 text-white">${headers.map(h => `<th class="border p-2">${h}</th>`).join('')}</tr></thead><tbody>`;
    sortedTeachers.forEach(teacher => {
        tableHTML += `<tr class="border-b hover:bg-gray-100"><td class="border p-2 font-bold">${teacher.Initials}</td><td class="border p-2">${teacher.Name}</td><td class="border p-2">${teacher.Surname}</td>`;
        let directTeachingHours = 0;
        semesterData.courses.forEach(course => {
            const hours = scheduleToView.filter(s => (s.TeacherInitials === teacher.Initials || s.TeacherInitials2 === teacher.Initials) && s.CourseCode === course.Code).reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);
            tableHTML += `<td class="border p-2 text-center">${hours ? hours.toFixed(2) : ''}</td>`;
            directTeachingHours += hours;
        });
        const totalHours = teacher.TotalHours || 0;
        const remainingHours = totalHours - directTeachingHours;
        const remainingHoursClass = remainingHours < 0 ? 'text-red-600 font-bold' : '';
        const teacherNote = semesterData.staffNotes[teacher.Initials] || '';
        tableHTML += `<td class="border p-2 text-center font-bold bg-cyan-100">${directTeachingHours.toFixed(2)}</td>`;
        tableHTML += `<td class="border p-2 text-center font-bold bg-yellow-100">${totalHours.toFixed(2)}</td>`;
        tableHTML += `<td class="border p-2 text-center font-bold bg-green-100 ${remainingHoursClass}">${remainingHours.toFixed(2)}</td>`;
        tableHTML += `<td class="border p-2"><input type="text" class="staff-notes-input" data-teacher="${teacher.Initials}" value="${teacherNote}" placeholder="Add notes..."></td></tr>`;
    });
    container.innerHTML = tableHTML + `</tbody></table>`;
    container.querySelectorAll('.staff-notes-input').forEach(input => {
        input.addEventListener('change', (e) => {
            const teacherInitials = e.target.dataset.teacher;
            semesterData.staffNotes[teacherInitials] = e.target.value;
            saveData();
        });
    });
}

function renderDisputeLogView() {
    const container = document.getElementById('dispute-log-view');
    const semesterData = getCurrentSemesterData();
    const disputedSessions = semesterData.schedule.filter(s => s.dispute);
    let contentHTML = `<div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto"><h2 class="text-xl font-bold text-center mb-4">Dispute Log - ${semesterData.currentCollege} (${db.currentSemester})</h2>`;
    if (disputedSessions.length === 0) {
        contentHTML += `<p class="text-center text-gray-500">No disputes found in this view.</p>`;
    } else {
        const headers = ['Day', 'Time', 'Course', 'Subject', 'Teacher', 'Room', 'Colleges', 'Reason for Dispute'];
        contentHTML += `<table class="w-full text-sm border-collapse"><thead><tr class="bg-red-800 text-white">${headers.map(h => `<th class="border p-2">${h}</th>`).join('')}</tr></thead><tbody>`;
        disputedSessions.forEach(session => {
            const teachers = [session.TeacherInitials, session.TeacherInitials2].filter(Boolean).join(', ') || 'Unassigned';
            contentHTML += `<tr class="border-b hover:bg-red-50"><td class="border p-2">${session.Day}</td><td class="border p-2">${session.ClassStart} - ${session.ClassEnd}</td><td class="border p-2">${session.CourseCode}</td><td class="border p-2">${session.Subject}</td><td class="border p-2">${teachers}</td><td class="border p-2">Room ${session.Room}</td><td class="border p-2">${session.colleges?.join(', ') || ''}</td><td class="border p-2 font-bold text-red-600">${session.dispute.reason}</td></tr>`;
        });
        contentHTML += `</tbody></table>`;
    }
    contentHTML += `</div>`;
    container.innerHTML = contentHTML;
}

function renderTasksView() {
    const container = document.getElementById('tasks-container');
    const semesterLabel = document.getElementById('tasksSemesterLabel');
    const semesterData = getCurrentSemesterData();
    const tasks = semesterData.tasks || [];
    semesterLabel.textContent = db.currentSemester;
    if (tasks.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">No tasks yet. Click "Add New Task" to create one.</p>';
        return;
    }
    let html = '';
    tasks.forEach(task => {
        const teacher = semesterData.teachers.find(t => t.Initials === task.teacher);
        const course = semesterData.courses.find(c => c.Code === task.course);
        const teacherDisplay = teacher ? `${teacher.Name} ${teacher.Surname}` : 'Unassigned';
        const courseDisplay = course ? `${course.Code}` : 'Unassigned';
        const collegeDisplay = task.colleges && task.colleges.length > 0 ? task.colleges.join(', ') : 'All Colleges';
        const statusClass = `task-status-${task.status}`;
        const statusText = task.status === 'inprogress' ? 'In Progress' : (task.status === 'todo' ? 'To Do' : (task.status === 'done' ? 'Done' : 'Blocked'));
        const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
        html += `<div class="task-card ${task.priority}"><div class="task-header"><div class="task-title">${task.title}</div><span class="task-status-badge ${statusClass}">${statusText}</span></div>
        <div class="task-meta"><span>👤 ${teacherDisplay}</span><span>📚 ${courseDisplay}</span><span>🏫 ${collegeDisplay}</span><span>📅 ${dueDate}</span><span>🎯 ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span></div>
        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
        <div class="task-actions"><button class="task-edit-btn" onclick="window.editTask(${task.id})">Edit</button><button class="task-delete-btn" onclick="window.deleteTaskFromList(${task.id})">Delete</button></div></div>`;
    });
    container.innerHTML = html;
}

function renderMainTimetableView() {
    const grid = document.getElementById('main-timetable-grid');
    const titleEl = document.getElementById('main-timetable-title');
    const semesterData = getCurrentSemesterData();
    titleEl.textContent = `${semesterData.currentCollege} Timetable - ${db.currentSemester}`;
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const startTime = 8, endTime = 18, slotHeight = 30;
    const totalRows = (endTime - startTime) * 2;
    let gridHTML = `<div style="grid-row: 1; grid-column: 1;"></div>` + days.map((day, i) => `<div class="timetable-header" style="grid-column: ${i + 2};">${day}</div>`).join('');
    gridHTML += `<div class="time-labels">${Array.from({length: totalRows}, (_, i) => `<div class="time-label">${(i % 2 === 0) ? `<strong>${startTime + i/2}:00</strong>` : ''}</div>`).join('')}</div>`;
    gridHTML += days.map((day, i) => {
        let dayColHTML = `<div class="day-column" data-day="${day}" style="grid-column: ${i + 2}; height: ${totalRows * slotHeight}px">`;
        for (let j = 0; j < totalRows; j++) {
            const time = startTime + j * 0.5;
            const timeString = `${Math.floor(time).toString().padStart(2, '0')}:${((time % 1) * 60).toString().padStart(2, '0')}`;
            dayColHTML += `<div class="time-slot" data-day="${day}" data-time="${timeString}" data-slot-index="${j}"></div>`;
        }
        return dayColHTML + `</div>`;
    }).join('');
    grid.innerHTML = gridHTML;
    const scheduleToRender = semesterData.currentCollege === 'Master View' ? semesterData.schedule : semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));
    const sessionsByDay = {};
    days.forEach(day => sessionsByDay[day] = []);
    scheduleToRender.forEach(session => {
        const dayCol = grid.querySelector(`.day-column[data-day="${session.Day}"]`);
        if (!dayCol) return;
        sessionsByDay[session.Day].push(session);
        const start = timeToMinutes(session.ClassStart) / 30 - startTime * 2;
        const height = (timeToMinutes(session.ClassEnd) - timeToMinutes(session.ClassStart)) / 30 * slotHeight;
        const subjectInfo = semesterData.subjects.find(s => s.Subject === session.Subject);
        const teacher1Info = semesterData.teachers.find(t => t.Initials === session.TeacherInitials);
        const teacher2Info = session.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === session.TeacherInitials2) : null;
        const teacherDisplay = session.TeacherInitials ? (teacher2Info ? `${teacher1Info?.Name || session.TeacherInitials} & ${teacher2Info.Name}` : (teacher1Info ? `${teacher1Info.Name} ${teacher1Info.Surname}` : session.TeacherInitials)) : '<span class="unassigned-badge">UNASSIGNED</span>';
        const notesHTML = session.notes ? `<div class="text-xs italic text-gray-600 truncate" title="${session.notes}">${session.notes}</div>` : '';
        const collegeInfo = semesterData.currentCollege === 'Master View' ? `<div class="font-bold text-indigo-600 text-xs">${session.colleges?.join(', ') || ''}</div>` : '';
        const unitsHTML = subjectInfo?.Units?.length > 0 ? `<div class="session-units">Units: ${subjectInfo.Units.join(', ')}</div>` : '';
        const compulsoryBadge = subjectInfo?.Compulsory ? `<div class="font-bold text-red-600 text-xs">COMPULSORY</div>` : '';
        const deliveryMode = subjectInfo?.DeliveryMode || 'Face-to-Face';
        const deliveryClass = deliveryMode === 'Online' ? 'online' : (deliveryMode === 'Blended' ? 'blended' : '');
        const sessionBlock = document.createElement('div');
        sessionBlock.className = `session-block ${session.dispute ? 'dispute-warning' : ''} ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${deliveryClass}`;
        sessionBlock.setAttribute('data-session-id', session.id);
        Object.assign(sessionBlock.style, { top: `${start * slotHeight}px`, height: `${height}px`, backgroundColor: subjectInfo?.Color || '#e5e7eb', left: '2px', right: '2px' });
        sessionBlock.innerHTML = `${collegeInfo}<div class="font-bold">${session.CourseCode} - ${session.Subject}</div>${compulsoryBadge}${unitsHTML}<div>${teacherDisplay} | Room ${session.Room}</div>${notesHTML}<div class="text-xs">${session.ClassStart} - ${session.ClassEnd}</div><div class="resize-handle"></div>`;
        sessionBlock.addEventListener('dblclick', () => openSessionModal(session));
        sessionBlock.addEventListener('contextmenu', (e) => showContextMenu(e, session));
        dayCol.appendChild(sessionBlock);
        makeDraggable(sessionBlock, session, grid);
        makeResizable(sessionBlock, session);
    });
    days.forEach(day => {
        const dayCol = grid.querySelector(`.day-column[data-day="${day}"]`);
        if (dayCol && sessionsByDay[day].length > 0) {
            arrangeOverlappingSessions(dayCol, sessionsByDay[day]);
        }
    });
    addSlotSelectionListeners();
}

// --- Main Controller Functions (Hoisted) ---

function handleViewChange(viewName) {
    const selectedView = viewName || window.currentView || 'main-timetable';
    document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
    document.getElementById(`${selectedView}-view`).classList.add('active');
    window.currentView = selectedView;
    populateSelectors(selectedView);
    
    if (selectedView === 'main-timetable') renderMainTimetableView();
    else if (selectedView === 'staff-summary') renderStaffSummaryView();
    else if (selectedView === 'dispute-log') renderDisputeLogView();
    else if (selectedView === 'course-print') renderCoursePrintView(null);
    else if (selectedView === 'teacher-print') renderTeacherPrintView(null);
    else if (selectedView === 'tasks') renderTasksView();
}

function processAndRenderAll() {
    detectDisputes();
    renderSemesterDropdown();
    renderViewDropdown();
    renderCollegeTabs();
    handleViewChange(window.currentView);
    saveData();
}

// --- Event Listener Initializer ---

document.addEventListener('DOMContentLoaded', () => {
    loadData();
    
    document.getElementById('openSidebarBtn').addEventListener('click', () => {
        sidebarOpen = !sidebarOpen;
        if (sidebarOpen) document.getElementById('sidebar').classList.add('sidebar-open');
        else document.getElementById('sidebar').classList.remove('sidebar-open');
    });

    document.getElementById('closeSidebarBtn').addEventListener('click', () => {
        sidebarOpen = false;
        document.getElementById('sidebar').classList.remove('sidebar-open');
    });

    document.getElementById('printBtn').addEventListener('click', () => {
        const pdfGen = new PDFGenerator(db, getCurrentSemesterData);
        pdfGen.generate();
    });

    document.getElementById('manageSemestersBtn').addEventListener('click', openSemesterModal);
    document.getElementById('manageTeachersBtn').addEventListener('click', () => openManagementModal('Teachers', getCurrentSemesterData().teachers, ['Name', 'Surname', 'Initials', 'Email', 'HomeCollege', 'EmploymentType', 'TotalHours']));
    document.getElementById('manageCoursesBtn').addEventListener('click', () => openManagementModal('Courses', getCurrentSemesterData().courses, ['Code', 'Name']));
    document.getElementById('manageSubjectsBtn').addEventListener('click', () => openManagementModal('Subjects', getCurrentSemesterData().subjects, ['Subject', 'CourseCode', 'Color', 'Units', 'Compulsory', 'DeliveryMode']));
    document.getElementById('sessionForm').addEventListener('submit', handleSessionFormSubmit);
    document.getElementById('deleteSessionBtn').addEventListener('click', handleDeleteSession);
    document.getElementById('sessionModal').addEventListener('click', (e) => { if (e.target.id === 'sessionModal') e.currentTarget.classList.remove('active'); });
    document.addEventListener('click', () => document.getElementById('contextMenu').classList.remove('active'));
    document.getElementById('loadSampleDataBtn').addEventListener('click', () => {
        const currentData = getCurrentSemesterData();
        const sampleData = getSampleData();
        currentData.courses = sampleData.courses;
        currentData.teachers = sampleData.teachers;
        currentData.subjects = sampleData.subjects;
        currentData.schedule = sampleData.schedule;
        currentData.courseNotes = sampleData.courseNotes || {};
        currentData.tasks = sampleData.tasks || [];
        processAndRenderAll();
        alert(`Sample data loaded into ${db.currentSemester}!`);
    });
    
    document.getElementById('exportDataBtn').addEventListener('click', exportData);
    document.getElementById('importDataBtn').addEventListener('click', importData);
    document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal(null));
    document.getElementById('closeTaskModalBtn').addEventListener('click', () => document.getElementById('taskModal').classList.remove('active'));
    document.getElementById('cancelTaskBtn').addEventListener('click', () => document.getElementById('taskModal').classList.remove('active'));
    document.getElementById('closeModalBtn').addEventListener('click', () => document.getElementById('managementModal').classList.remove('active'));
    document.getElementById('closeSemesterModalBtn').addEventListener('click', () => document.getElementById('semesterModal').classList.remove('active'));
    document.getElementById('closeSessionModalBtn').addEventListener('click', () => document.getElementById('sessionModal').classList.remove('active'));
    document.getElementById('closeDuplicateDayModalBtn').addEventListener('click', () => document.getElementById('duplicateDayModal').classList.remove('active'));
    document.getElementById('closeAddTeacherModalBtn').addEventListener('click', () => document.getElementById('addTeacherModal').classList.remove('active'));
    document.getElementById('cancelAddTeacherBtn').addEventListener('click', () => document.getElementById('addTeacherModal').classList.remove('active'));
    
    processAndRenderAll();
});

// Window global assignments for HTML attributes
window.changeSemester = (name) => { db.currentSemester = name; processAndRenderAll(); document.getElementById('semesterDropdown').classList.remove('show'); };
window.changeView = (name) => { handleViewChange(name); document.getElementById('viewDropdown').classList.remove('show'); };
window.selectCourse = (code) => { renderCoursePrintView(code); document.getElementById('courseDropdown').classList.remove('show'); };
window.selectTeacher = (initials) => { renderTeacherPrintView(initials); document.getElementById('teacherDropdown').classList.remove('show'); };
window.editTask = (id) => openTaskModal(id);
window.deleteTaskFromList = (id) => { if(confirm('Delete task?')) { getCurrentSemesterData().tasks = getCurrentSemesterData().tasks.filter(t => t.id !== id); processAndRenderAll(); }};
window.handleManagementEdit = handleManagementEdit;
window.handleManagementDelete = handleManagementDelete;

</script>
</body>
</html>
