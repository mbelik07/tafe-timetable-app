<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="TAFE Interactive Timetabling Application" property="og:title"/>
<meta content="A multi-college, interactive timetabling solution for TAFE NSW with data persistence and class notes." property="og:description"/>
<title>TAFE Interactive Timetabling Application</title>
<style>
* { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
.sidebar { transition: transform 0.3s ease-in-out; }
.sidebar-open { transform: translateX(0) !important; }
.view-container { display: none; }
.view-container.active { display: block; }
.college-tab { padding: 8px 16px; border: 1px solid transparent; border-bottom: none; background: #f3f4f6; color: #4b5563; cursor: pointer; border-radius: 6px 6px 0 0; }
.college-tab.active { background: white; border-color: #d1d5db; border-bottom-color: white; font-weight: bold; color: #1e3a8a; }
.timetable-main-grid { display: grid; grid-template-columns: 50px repeat(5, minmax(200px, 1fr)); grid-template-rows: auto 1fr; border: 1px solid #d1d5db; }
.timetable-header { background-color: #007bff; color: white; font-weight: bold; padding: 0.75rem 0.5rem; text-align: center; border-left: 1px solid #d1d5db; grid-row: 1; }
.time-labels { grid-row: 2; grid-column: 1; display: flex; flex-direction: column; }
.time-label { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6b7280; border-top: 1px solid #e5e7eb; box-sizing: border-box; }
.day-column { grid-row: 2; position: relative; border-left: 1px solid #d1d5db; }
.time-slot { height: 30px; border-top: 1px solid #e5e7eb; box-sizing: border-box; cursor: pointer; }
.time-slot:hover { background-color: rgba(229, 231, 235, 0.5); }
.dragging .time-slot:hover { background-color: transparent !important; }
.dragging .time-slot { cursor: default !important; }
.time-slot.slot-selected { background-color: rgba(59, 130, 246, 0.3); }
.session-block { position: absolute; border-radius: 4px; padding: 6px; font-size: 14px; line-height: 1.3; overflow: hidden; border: 1px solid rgba(0,0,0,0.4); z-index: 10; cursor: grab; }
.session-block.compulsory { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700; }
.session-block.online { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.blended { box-shadow: 0 0 0 3px #3b82f6; }
.session-block.compulsory.online { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.session-block.compulsory.blended { box-shadow: 0 0 0 4px #ffff00, 0 0 0 5px #ffd700, 0 0 0 8px #3b82f6; }
.dispute-warning { border: 3px solid #ef4444 !important; z-index: 15; animation: pulse-border 1.5s infinite; }
.dispute-warning::after { content: '‚ö†Ô∏è DISPUTED'; position: absolute; top: 2px; right: 4px; font-weight: bold; color: #ef4444; font-size: 10px; background: white; padding: 0 2px; border-radius: 3px;}
@keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
.resize-handle { position: absolute; bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; z-index: 20; }
.context-menu { position: fixed; background: #2d3748; color: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-width: 200px; display: none; }
.context-menu.active { display: block; }
.context-menu-item { padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #4a5568; }
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:hover { background: #4a5568; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: none; }
.modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; z-index: 101; }
.modal-overlay.active { display: block; }

/* PDF Print Styles - Optimized for single page */
.pdf-print-grid { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
.pdf-print-grid th, .pdf-print-grid td { border: 1px solid #000; padding: 4px; text-align: left; font-size: 9px; }
.pdf-print-grid th { background-color: #595959; color: white; font-weight: bold; }
.pdf-print-grid td:first-child, .pdf-print-grid th:first-child { width: 65px !important; max-width: 65px !important; }
.pdf-day-header { background-color: #595959; color: white; font-weight: bold; text-align: center; }
.pdf-period-label { background-color: #fde9d9; font-weight: bold; text-align: center; vertical-align: middle; min-height: 120px; width: 65px !important; max-width: 65px !important; padding: 4px 2px; font-size: 10px; word-break: break-word; overflow-wrap: break-word; }
.pdf-cell { vertical-align: top; min-height: 120px; padding: 3px !important; }
.pdf-session { border: 1px solid #000; border-radius: 2px; padding: 3px; margin-bottom: 2px; font-size: 9px; line-height: 1.2; }
.pdf-session.compulsory { border: 2px solid #ffff00; background-color: #fffacd; }
.pdf-session.online { border: 1px solid #3b82f6; }
.pdf-session.blended { border: 1px solid #3b82f6; }

.pdf-container { width: 100%; padding: 10px; background: white; }
.pdf-title { text-align: center; margin-bottom: 6px; }
.pdf-title h2 { font-size: 18px; font-weight: bold; margin: 0; }
.pdf-title h3 { font-size: 12px; margin: 2px 0 0 0; color: #666; }

.pdf-bottom-section { margin-top: 8px; display: flex; gap: 8px; }
.pdf-teacher-info { flex: 0.7; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; }
.pdf-teacher-info h4 { font-weight: bold; margin-bottom: 6px; font-size: 13px; }
.pdf-teacher-info p { margin: 3px 0; font-size: 12px; line-height: 1.5; }

.pdf-notes-section { flex: 1.3; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; }
.pdf-notes-section h4 { font-weight: bold; margin-bottom: 6px; font-size: 13px; }
.pdf-notes-content {
 font-family: "Helvetica Neue", Arial, sans-serif;
 font-size: 12px;
 letter-spacing: 0.3px;
 line-height: 1.6;
 color: #222;
 background-color: #fff;
 border: 1px solid #e0e0e0;
 border-radius: 4px;
 padding: 12px;
 min-height: 80px;
 white-space: pre-wrap;
 word-wrap: break-word;
 hyphens: auto;
 -webkit-font-smoothing: antialiased;
 -moz-osx-font-smoothing: grayscale;
}

.pdf-legend-section { flex: 0.5; padding: 6px; border: 1px solid #ddd; border-radius: 2px; background: #f9f9f9; }
.pdf-legend-section h4 { font-weight: bold; margin-bottom: 6px; font-size: 13px; }
.pdf-legend-item { display: flex; align-items: center; gap: 4px; margin-bottom: 4px; font-size: 11px; line-height: 1.4; }
.pdf-legend-circle { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }

.pdf-total-hours { margin-top: 8px; text-align: right; font-size: 11px; font-weight: bold; }
.pdf-total-hours-value { display: inline-block; background: #1f2937; color: white; padding: 4px 10px; border-radius: 2px; margin-left: 6px; font-size: 10px; }

.color-circle { display: inline-block; width: 22px; height: 22px; border-radius: 50%; border: 1px solid #999; margin-right: 8px; vertical-align: middle; }
.course-list-item { padding: 12px; margin-bottom: 8px; background: #f3f4f6; border: 2px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.course-list-item:hover { background: #e5e7eb; }
.course-list-item.active { background: #dbeafe; border-color: #3b82f6; font-weight: bold; }
.staff-notes-input { max-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
.task-card { padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; background: white; }
.task-card.high { border-left: 4px solid #dc2626; background: #fee2e2; }
.task-card.medium { border-left: 4px solid #f59e0b; background: #fef3c7; }
.task-card.low { border-left: 4px solid #10b981; background: #ecfdf5; }
.task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
.task-title { font-weight: bold; font-size: 1.1rem; color: #1f2937; }
.task-status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }
.task-status-todo { background: #e5e7eb; color: #374151; }
.task-status-inprogress { background: #dbeafe; color: #1e40af; }
.task-status-done { background: #dcfce7; color: #166534; }
.task-status-blocked { background: #fee2e2; color: #991b1b; }
.task-meta { display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; flex-wrap: wrap; }
.task-description { color: #4b5563; margin-bottom: 0.75rem; }
.task-actions { display: flex; gap: 0.5rem; }
.task-actions button { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; border: none; cursor: pointer; }
.task-edit-btn { background: #3b82f6; color: white; }
.task-edit-btn:hover { background: #2563eb; }
.task-delete-btn { background: #ef4444; color: white; }
.task-delete-btn:hover { background: #dc2626; }
.dropdown-menu { position: relative; display: inline-block; }
.dropdown-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.dropdown-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.dropdown-content { position: absolute; background: white; min-width: 250px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 0.375rem; z-index: 1; top: 100%; left: 0; margin-top: 0.5rem; display: none; border: 2px solid #667eea; max-height: 400px; overflow-y: auto; }
.dropdown-content.show { display: block; }
.dropdown-item { color: #1f2937; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: all 0.2s; }
.dropdown-item:last-child { border-bottom: none; }
.dropdown-item:hover { background: #f3f4f6; color: #667eea; font-weight: 500; }
.college-checkboxes { display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
.college-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; }
.college-checkbox-label input { cursor: pointer; width: 18px; height: 18px; }
.unassigned-badge { display: inline-block; background: #fbbf24; color: #78350f; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; }

@media print {
 body * { visibility: hidden; }
 #print-area, #print-area * { visibility: visible; }
 #print-area { position: absolute; left: 0; top: 0; width: 100%; }
 .no-print { display: none !important; }
 .pdf-container { padding: 8px; }
 .pdf-print-grid { margin-bottom: 6px; }
}
</style>
</head>
<body class="bg-gray-100">
<div class="sidebar fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 -translate-x-full" id="sidebar">
<div class="p-4 bg-blue-900 text-white flex justify-between items-center no-print"><h2 class="text-xl font-bold">Data Hub</h2><button class="text-2xl" id="closeSidebarBtn">√ó</button></div>
<div class="p-4 space-y-3 no-print">
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Management</h3>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSemestersBtn">üóìÔ∏è Manage Semesters</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageTeachersBtn">üë®‚Äçüè´ Manage Teachers</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageCoursesBtn">üìö Manage Courses</button>
<button class="w-full text-left bg-blue-100 hover:bg-blue-200 p-3 rounded font-semibold" id="manageSubjectsBtn">üé® Manage Subjects</button>
<hr class="my-4"/>
<h3 class="text-lg font-bold text-gray-700 border-b pb-2">Data Actions</h3>
<button class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" id="exportDataBtn">üíæ Export Data</button>
<button class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" id="importDataBtn">üìÇ Import Data</button>
<button class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" id="loadSampleDataBtn">üîÑ Load Sample Data</button>
<input type="file" id="importFileInput" accept=".json" style="display: none;"/>
</div>
</div>
<div class="transition-all duration-300" id="mainContent">
<header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
<div class="flex items-center gap-4"><h1 class="text-2xl font-bold text-blue-900">Interactive Timetabling App</h1></div>
<div class="flex items-center gap-3">
<button class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded" id="openSidebarBtn">Open Menu</button>
<div class="dropdown-menu">
<button class="dropdown-btn" id="semesterDropdownBtn">üìÖ Semester <span>‚ñº</span></button>
<div class="dropdown-content" id="semesterDropdown"></div>
</div>
<div class="dropdown-menu">
<button class="dropdown-btn" id="viewDropdownBtn">üëÅÔ∏è View <span>‚ñº</span></button>
<div class="dropdown-content" id="viewDropdown"></div>
</div>
<div id="secondary-selectors"></div>
<button class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded" id="printBtn">üìÑ Download PDF</button>
</div>
</header>
<main class="p-4">
<div class="flex items-center gap-2 mb-[-1px] no-print" id="college-tabs-container"></div>
<div id="print-area">
<div class="view-container active" id="main-timetable-view"><div class="bg-white p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-center mb-4" id="main-timetable-title"></h2><div class="timetable-grid-container"><div class="timetable-main-grid" id="main-timetable-grid"><div class="text-center p-10 col-span-6 text-gray-500">Load sample data or add your own to begin.</div></div></div></div></div>
<div class="view-container" id="staff-summary-view"><div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto"><h2 class="text-xl font-bold text-center mb-4" id="staff-summary-title"></h2><div id="staff-summary-table"></div></div></div>
<div class="view-container" id="dispute-log-view"></div>
<div class="view-container" id="course-print-view"></div>
<div class="view-container" id="teacher-print-view"></div>
<div class="view-container" id="tasks-view"><div class="bg-white p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-2">üìã Task Management</h2><p class="text-gray-600 mb-4">Semester: <span id="tasksSemesterLabel" class="font-bold text-blue-900"></span></p><button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-6" id="addTaskBtn">+ Add New Task</button><div id="tasks-container"></div></div></div>
</div>
</main>
</div>
<div class="context-menu" id="contextMenu"></div>

<script>
let selectedCourseForSubjects = null;
let sidebarOpen = false;

document.addEventListener('DOMContentLoaded', () => {
let db = {};
const colleges = ['Moss Vale', 'Goulburn', 'Queanbeyan'];
const getNewSemesterData = () => ({ courses: [], teachers: [], subjects: [], schedule: [], currentCollege: 'Moss Vale', staffNotes: {}, tasks: [] });

const saveData = () => localStorage.setItem('timetableDataV2', JSON.stringify(db));
const loadData = () => {
const savedData = localStorage.getItem('timetableDataV2');
if (savedData) {
db = JSON.parse(savedData);
Object.keys(db.semesters).forEach(semKey => {
if (db.semesters[semKey].subjects) {
db.semesters[semKey].subjects.forEach(subj => {
if (!subj.DeliveryMode) subj.DeliveryMode = 'Face-to-Face';
});
}
if (!db.semesters[semKey].staffNotes) {
db.semesters[semKey].staffNotes = {};
}
if (!db.semesters[semKey].tasks) {
db.semesters[semKey].tasks = [];
}
});
} else {
db = {
semesters: { 'Semester 1 2024': getNewSemesterData(), 'Semester 2 2024': getNewSemesterData() },
currentSemester: 'Semester 1 2024'
};
}
};

const getCurrentSemesterData = () => {
if (!db.semesters[db.currentSemester]) {
const firstSemester = Object.keys(db.semesters);
if (firstSemester) {
db.currentSemester = firstSemester;
} else {
db.semesters['Default Semester'] = getNewSemesterData();
db.currentSemester = 'Default Semester';
}
}
return db.semesters[db.currentSemester];
};

const timeToMinutes = (timeStr) => !timeStr ? 0 : timeStr.split(':').map(Number).reduce((h, m) => h * 60 + m);
const dayOrder = { 'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3, 'Friday': 4 };
const sortSessionsChronologically = (sessions) => {
return [...sessions].sort((a, b) => {
const dayDiff = (dayOrder[a.Day] || 0) - (dayOrder[b.Day] || 0);
if (dayDiff !== 0) return dayDiff;
return timeToMinutes(a.ClassStart) - timeToMinutes(b.ClassStart);
});
};

function renderCoursePrintView(courseCode) {
  const container = document.getElementById('course-print-view');
  const semesterData = getCurrentSemesterData();

  if (!courseCode && semesterData.courses.length > 0) {
    courseCode = semesterData.courses[0].Code;
  }

  if (!courseCode) {
    container.innerHTML = `<div class="p-6 bg-white rounded shadow text-center text-gray-500 font-semibold">Please add courses in the Data Hub to use this view.</div>`;
    return;
  }

  const courseInfo = semesterData.courses.find(c => c.Code === courseCode);
  const scheduleToFilter = semesterData.currentCollege === 'Master View'
    ? semesterData.schedule
    : semesterData.schedule.filter(s => s.colleges?.includes(semesterData.currentCollege));

  let sessions = scheduleToFilter.filter(s => s.CourseCode === courseCode);
  sessions = sortSessionsChronologically(sessions);

  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  
  // Find all unique time slots across all sessions
  const timeSlots = new Set();
  sessions.forEach(s => {
    timeSlots.add(`${s.ClassStart}-${s.ClassEnd}`);
  });
  
  // Sort time slots chronologically
  const sortedTimeSlots = Array.from(timeSlots).sort((a, b) => {
    const startA = timeToMinutes(a.split('-')[0]);
    const startB = timeToMinutes(b.split('-')[0]);
    return startA - startB;
  });

  // Create grid structure: timeSlot -> day -> sessions
  const grid = {};
  sortedTimeSlots.forEach(slot => {
    grid[slot] = {};
    days.forEach(day => {
      grid[slot][day] = [];
    });
  });

  // Populate grid
  sessions.forEach(s => {
    const slot = `${s.ClassStart}-${s.ClassEnd}`;
    if (grid[slot] && grid[slot][s.Day]) {
      grid[slot][s.Day].push(s);
    }
  });

  // Build table with time slots as rows
  let gridHTML = `<table class="pdf-print-grid">
    <thead>
      <tr>
        <th class="pdf-print-grid">Time</th>
        ${days.map(d => `<th class="pdf-day-header">${d}</th>`).join('')}
      </tr>
    </thead>
    <tbody>`;

  sortedTimeSlots.forEach(timeSlot => {
    gridHTML += `<tr>
      <td class="pdf-period-label">${timeSlot}</td>`;

    days.forEach(day => {
      const daySessions = grid[timeSlot][day] || [];
      
      if (daySessions.length === 0) {
        // Empty spacer cell
        gridHTML += `<td class="pdf-cell" style="background-color: #f9f9f9;"></td>`;
      } else {
        const sessionsHTML = daySessions.map(s => {
          const subjectInfo = semesterData.subjects.find(sub => sub.Subject === s.Subject);
          const teacher1Info = semesterData.teachers.find(t => t.Initials === s.TeacherInitials);
          const teacher2Info = s.TeacherInitials2 ? semesterData.teachers.find(t => t.Initials === s.TeacherInitials2) : null;
          const teacherDisplay = s.TeacherInitials
            ? (teacher2Info
              ? `${teacher1Info?.Name || s.TeacherInitials} & ${teacher2Info.Name}`
              : (teacher1Info ? `${teacher1Info.Name} ${teacher1Info.Surname}` : s.TeacherInitials))
            : 'UNASSIGNED';
          const hours = (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60;
          const collegeHTML = semesterData.currentCollege === 'Master View' ? `<div style="font-weight: bold; font-size: 11px; color: #4338ca; margin-bottom: 3px;">${s.colleges?.join(', ') || ''}</div>` : '';
          const notesHTML = s.notes ? `<div style="font-style: italic; font-size: 11px; margin-top: 3px;">${s.notes}</div>` : '';
          const unitsHTML = subjectInfo?.Units?.length > 0 ? `<div style="font-size: 10px; color: #555; margin-top: 2px;">Units: ${subjectInfo.Units.join(', ')}</div>` : '';
          const compulsoryBadge = subjectInfo?.Compulsory ? `<div style="font-weight: bold; font-size: 10px; color: #d32f2f; margin-top: 2px;">COMPULSORY</div>` : '';
          const deliveryMode = subjectInfo?.DeliveryMode || 'Face-to-Face';
          const deliveryBadge = (deliveryMode === 'Online' || deliveryMode === 'Blended') ? `<div style="font-weight: bold; font-size: 10px; color: #3b82f6; margin-top: 2px;">${deliveryMode.toUpperCase()}</div>` : '';
          const deliveryClass = deliveryMode === 'Online' ? 'online' : (deliveryMode === 'Blended' ? 'blended' : '');

          return `<div class="pdf-session ${subjectInfo?.Compulsory ? 'compulsory' : ''} ${deliveryClass}" style="background-color:${subjectInfo?.Color || '#eee'}">
            ${collegeHTML}
            <div style="font-weight: bold; margin-bottom: 3px; font-size: 12px;">${s.CourseCode} | ${s.Subject}</div>
            ${compulsoryBadge}
            ${deliveryBadge}
            ${unitsHTML}
            <div style="margin-top: 3px; font-size: 11px;">${teacherDisplay} | ${hours.toFixed(2)} Hrs | Room ${s.Room}</div>
            ${notesHTML}
            <div style="margin-top: 3px; font-size: 11px;">${s.ClassStart} - ${s.ClassEnd}</div>
          </div>`;
        }).join('');

        gridHTML += `<td class="pdf-cell">${sessionsHTML}</td>`;
      }
    });

    gridHTML += `</tr>`;
  });

  gridHTML += `</tbody></table>`;

  const totalHours = sessions.reduce((sum, s) => sum + (timeToMinutes(s.ClassEnd) - timeToMinutes(s.ClassStart)) / 60, 0);
  
  if (!semesterData.courseNotes) semesterData.courseNotes = {};
  const courseNotes = semesterData.courseNotes[courseCode] || '';

  const uniqueTeacherInitials = new Set();
  sessions.forEach(s => {
    if (s.TeacherInitials) uniqueTeacherInitials.add(s.TeacherInitials);
    if (s.TeacherInitials2) uniqueTeacherInitials.add(s.TeacherInitials2);
  });
  const courseTeachers = Array.from(uniqueTeacherInitials)
    .map(initials => semesterData.teachers.find(t => t.Initials === initials))
    .filter(t => t)
    .sort((a, b) => `${a.Name} ${a.Surname}`.localeCompare(`${b.Name} ${b.Surname}`));

  const teacherContactHTML = courseTeachers.length > 0 ? `
    <div class="pdf-teacher-info">
      <h4>Teacher Contact:</h4>
      ${courseTeachers.map(t => `
        <div style="margin-bottom:6px; font-size:12px; line-height:1.4; color:#222;">
          <span style="font-weight:600;">${t.Name} ${t.Surname}</span><span style="margin:0 6px;">:</span>
          ${t.Email ? `<a href="mailto:${t.Email}" style="color:#0066cc; text-decoration:underline; font-size:12px; word-break:break-all;">${t.Email}</a>` : ''}
        </div>
      `).join('')}
    </div>
  ` : '';

  const notesSection = `
    <div class="pdf-notes-section">
      <h4>Course Notes:</h4>
      <div class="pdf-notes-content">${courseNotes || '(No notes added)'}</div>
    </div>
  `;

  const hasCompulsory = sessions.some(s => semesterData.subjects.find(sub => sub.Subject === s.Subject)?.Compulsory);
  const hasOnline = sessions.some(s => (semesterData.subjects.find(sub => sub.Subject === s.Subject)?.DeliveryMode === 'Online'));
  const hasBlended = sessions.some(s => (semesterData.subjects.find(sub => sub.Subject === s.Subject)?.DeliveryMode === 'Blended'));

  let legendHTML = '';
  if (hasCompulsory || hasOnline || hasBlended) {
    legendHTML = `
      <div class="pdf-legend-section">
        <h4>Legend:</h4>
        ${hasCompulsory ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #fffacd; border: 2px solid #ffd700;"></div><span>Compulsory</span></div>' : ''}
        ${hasOnline ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #dbeafe; border: 1px solid #3b82f6;"></div><span>Online</span></div>' : ''}
        ${hasBlended ? '<div class="pdf-legend-item"><div class="pdf-legend-circle" style="background-color: #dbeafe; border: 1px solid #3b82f6;"></div><span>Blended</span></div>' : ''}
      </div>
    `;
  }

  const bottomSection = `
    <div class="pdf-bottom-section">
      ${teacherContactHTML}
      ${notesSection}
      ${legendHTML}
    </div>
  `;

  const totalHoursHTML = `<div class="pdf-total-hours">Total Hours: <span class="pdf-total-hours-value">${totalHours.toFixed(2)}</span></div>`;

  container.innerHTML = `
    <div class="pdf-container">
      <div class="pdf-title">
        <h2>${courseInfo.Name} (${courseCode})</h2>
        <h3>${semesterData.currentCollege} - ${db.currentSemester}</h3>
      </div>
      ${gridHTML}
      ${totalHoursHTML}
      ${bottomSection}
    </div>
  `;
}

loadData();
processAndRenderAll();

function processAndRenderAll() {
  renderSemesterDropdown();
  renderViewDropdown();
  renderCollegeTabs();
  handleViewChange();
  saveData();
}

function renderSemesterDropdown() {
  const semesterNames = Object.keys(db.semesters).sort();
  let html = '';
  semesterNames.forEach(name => {
    html += `<div class="dropdown-item ${db.currentSemester === name ? 'font-bold text-purple-600' : ''}" onclick="changeSemester('${name}')">${name}</div>`;
  });
  document.getElementById('semesterDropdown').innerHTML = html;
}

function renderViewDropdown() {
  const views = [
    { value: 'main-timetable', label: 'üìä Main Timetable' },
    { value: 'staff-summary', label: 'üë• Staff Summary' },
    { value: 'dispute-log', label: '‚ö†Ô∏è Dispute Log' },
    { value: 'course-print', label: 'üìö Course Print' },
    { value: 'teacher-print', label: 'üë®‚Äçüè´ Teacher Print' },
    { value: 'tasks', label: 'üìã Tasks' }
  ];

  let html = '';
  views.forEach(view => {
    html += `<div class="dropdown-item" onclick="changeView('${view.value}')">${view.label}</div>`;
  });
  document.getElementById('viewDropdown').innerHTML = html;
}

window.changeSemester = (semesterName) => {
  db.currentSemester = semesterName;
  processAndRenderAll();
  document.getElementById('semesterDropdown').classList.remove('show');
};

window.changeView = (viewName) => {
  window.currentView = viewName;
  handleViewChange(viewName);
  document.getElementById('viewDropdown').classList.remove('show');
};

function renderCollegeTabs() {
  const currentData = getCurrentSemesterData();
  let tabsHTML = `<button class="college-tab ${currentData.currentCollege === 'Master View' ? 'active' : ''}" data-college="Master View">Master View</button>`;
  tabsHTML += colleges.map(c => `<button class="college-tab ${currentData.currentCollege === c ? 'active' : ''}" data-college="${c}">${c}</button>`).join('');
  document.getElementById('college-tabs-container').innerHTML = tabsHTML;
  document.getElementById('college-tabs-container').querySelectorAll('.college-tab').forEach(tab => tab.addEventListener('click', (e) => {
    getCurrentSemesterData().currentCollege = e.target.dataset.college;
    processAndRenderAll();
  }));
}

function handleViewChange(viewName) {
  const selectedView = viewName || window.currentView || 'main-timetable';
  document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
  document.getElementById(`${selectedView}-view`).classList.add('active');
  
  if (selectedView === 'course-print') {
    renderCoursePrintView();
  }
}

document.getElementById('semesterDropdownBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('semesterDropdown').classList.toggle('show');
  document.getElementById('viewDropdown').classList.remove('show');
});

document.getElementById('viewDropdownBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('viewDropdown').classList.toggle('show');
  document.getElementById('semesterDropdown').classList.remove('show');
});

document.getElementById('loadSampleDataBtn').addEventListener('click', () => {
  const currentData = getCurrentSemesterData();
  currentData.courses = [{ Code: 'FSK20119', Name: 'Cert II Skills for Work' }, { Code: '11225NAT', Name: 'Cert IV Tertiary Prep' }];
  currentData.teachers = [
    { Name: 'Juan', Surname: 'Aburto', Initials: 'JA', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 20, Email: 'juan.aburto@tafe.edu.au' },
    { Name: 'Miroslav', Surname: 'Belik', Initials: 'MB', HomeCollege: 'Moss Vale', EmploymentType: 'Full-Time', TotalHours: 10, Email: 'miroslav.belik@tafe.edu.au' }
  ];
  currentData.subjects = [
    { Subject: 'Maths B TPC', CourseCode: 'FSK20119', Color: '#ffa57d', Units: ['NAT11225020'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
    { Subject: 'History TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225017'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
    { Subject: 'Calculus B TPC', CourseCode: '11225NAT', Color: '#ffa57d', Units: ['NAT11225021'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
    { Subject: 'Health TPC', CourseCode: 'FSK20119', Color: '#ffa57d', Units: ['NAT11225026'], Compulsory: false, DeliveryMode: 'Face-to-Face' },
    { Subject: 'Study Skills', CourseCode: '11225NAT', Color: '#90ee90', Units: ['NAT11225030'], Compulsory: true, DeliveryMode: 'Face-to-Face' }
  ];
  currentData.schedule = [
    { id: 1, Day: 'Monday', ClassStart: '09:00', ClassEnd: '11:00', TeacherInitials: 'JA', TeacherInitials2: '', CourseCode: 'FSK20119', Subject: 'Maths B TPC', Room: 'C1', colleges: ['Moss Vale'], notes: 'Face-to-Face', dispute: null },
    { id: 2, Day: 'Monday', ClassStart: '11:00', ClassEnd: '13:00', TeacherInitials: 'MB', TeacherInitials2: '', CourseCode: '11225NAT', Subject: 'History TPC', Room: 'C4', colleges: ['Moss Vale'], notes: '', dispute: null },
    { id: 3, Day: 'Tuesday', ClassStart: '09:00', ClassEnd: '11:00', TeacherInitials: 'JA', TeacherInitials2: '', CourseCode: '11225NAT', Subject: 'Calculus B TPC', Room: 'C2', colleges: ['Moss Vale'], notes: '', dispute: null },
    { id: 4, Day: 'Wednesday', ClassStart: '09:00', ClassEnd: '11:00', TeacherInitials: 'MB', TeacherInitials2: '', CourseCode: '11225NAT', Subject: 'Study Skills', Room: 'C3', colleges: ['Moss Vale'], notes: '', dispute: null },
    { id: 5, Day: 'Wednesday', ClassStart: '11:00', ClassEnd: '13:00', TeacherInitials: 'MB', TeacherInitials2: '', CourseCode: '11225NAT', Subject: 'History TPC', Room: 'C3', colleges: ['Moss Vale'], notes: '', dispute: null },
    { id: 6, Day: 'Thursday', ClassStart: '11:00', ClassEnd: '13:00', TeacherInitials: 'JA', TeacherInitials2: '', CourseCode: 'FSK20119', Subject: 'Health TPC', Room: 'C1', colleges: ['Moss Vale'], notes: '', dispute: null },
    { id: 7, Day: 'Friday', ClassStart: '11:00', ClassEnd: '13:00', TeacherInitials: 'MB', TeacherInitials2: '', CourseCode: 'FSK20119', Subject: 'Health TPC', Room: 'C2', colleges: ['Moss Vale'], notes: '', dispute: null }
  ];
  processAndRenderAll();
  alert(`Sample data loaded into ${db.currentSemester}!`);
});

});
</script>
</body>
</html>